<!DOCTYPE html>
<html lang="vi" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Check-in Gi√°ng Sinh - Bin Bin Hotel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ["Quicksand", "system-ui", "sans-serif"]
          },
          colors: {
            xmas: {
              red: '#D42426',
              green: '#146B3A',
              gold: '#F8B229',
              dark: '#0F172A'
            }
          },
          animation: {
            'float': 'float 6s ease-in-out infinite',
            'shine': 'shine 3s linear infinite',
            'ping-slow': 'ping 2s cubic-bezier(0, 0, 0.2, 1) infinite',
            // UPDATE: Hi·ªáu ·ª©ng nh·ªãp th·ªü 4s m∆∞·ª£t m√†
            'glow-pulse': 'glowPulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            },
            shine: {
              '0%': { backgroundPosition: '200% center' },
              '100%': { backgroundPosition: '-200% center' },
            },
            // UPDATE: Keyframes m·ªõi cho hi·ªáu ·ª©ng th·ªü
            glowPulse: {
              '0%, 100%': { 
                boxShadow: '0 0 15px 0px rgba(56, 189, 248, 0.2)', 
                borderColor: 'rgba(56, 189, 248, 0.3)',
                transform: 'scale(1)' 
              },
              '50%': { 
                // B√≥ng ƒë·ªï lan r·ªông v√† s√°ng h∆°n
                boxShadow: '0 0 40px 10px rgba(56, 189, 248, 0.7)', 
                borderColor: 'rgba(56, 189, 248, 0.9)',
                // Ph√≥ng to nh·∫π 2% ƒë·ªÉ t·∫°o nh·ªãp
                transform: 'scale(1.02)' 
              }
            }
          }
        }
      }
    }
  </script>
  <style>
    /* N·ªÅn t·ªëi m·∫∑c ƒë·ªãnh */
    .dark body {
        background: radial-gradient(circle at 50% 30%, #1e293b, #0f172a, #450a0a) !important;
    }
    
    /* N·ªÅn s√°ng m·ªõi - gradient xanh-tr·∫Øng Gi√°ng Sinh */
    body {
        background: linear-gradient(to bottom right, #e0f2fe, #ffffff);
    }

    /* S·ª≠a l·ªói n·ªÅn t·ªëi b·ªã ghi ƒë√® */
    html.dark body {
        background: radial-gradient(circle at 50% 30%, #1e293b, #0f172a, #450a0a);
    }

    html:not(.dark) body {
        background: linear-gradient(to bottom right, #e0f2fe, #ffffff);
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
    }
    .dark .glass-card {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .text-gold-gradient {
        background: linear-gradient(to right, #b45309, #fbbf24, #b45309);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        background-size: 200% auto;
        animation: shine 4s linear infinite;
    }
    .dark .text-gold-gradient {
        background: linear-gradient(to right, #fcd34d, #fffbeb, #fcd34d);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        background-size: 200% auto;
    }

    /* UPDATE: Class m·ªõi cho hi·ªáu ·ª©ng th·ªü xanh d∆∞∆°ng */
    .qr-glow-blue {
        border-width: 2px; /* Border m·ªèng h∆°n cho tinh t·∫ø */
        border-style: solid;
        border-radius: 1rem; /* Bo g√≥c tr√πng v·ªõi container */
        animation: glowPulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        will-change: transform, box-shadow; /* T·ªëi ∆∞u hi·ªáu nƒÉng render */
    }

  </style>
</head>
<body class="h-full flex items-center justify-center relative overflow-hidden text-slate-800 dark:text-slate-100">

  <canvas id="snowCanvas" class="absolute inset-0 pointer-events-none z-0"></canvas>
  
  <audio id="bg-audio" loop>
      <source src='/static/sounds/giangsinh.mp3' type="audio/mpeg">
  </audio>

  <div class="w-full max-w-4xl px-4 z-10 animate-fade-in-up">
    
    <div class="glass-card rounded-[2rem] p-8 md:p-12 relative overflow-visible">
        
        <div class="absolute top-4 right-4 z-20 flex gap-2">
            <button id="btn-music" class="p-2 rounded-full bg-white/50 dark:bg-black/20 hover:bg-white/80 transition shadow-sm group border border-white/20">
                <div id="icon-music-on" class="hidden relative w-5 h-5 flex items-center justify-center">
                    <span class="absolute w-full h-full border border-red-500 rounded-full opacity-0 animate-ping-slow"></span>
                    <svg class="w-5 h-5 text-xmas-red" fill="currentColor" viewBox="0 0 24 24"><path d="M14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77zm-4 0c-4.01.91-7 4.49-7 8.77s2.99 7.86 7 8.77v-2.06c-2.89-.86-5-3.54-5-6.71s2.11-5.85 5-6.71V3.23zM9 13.5h2.83L14.17 16V8L11.83 10.5H9v3z"/></svg>
                </div>
                <div id="icon-music-off" class="w-5 h-5 flex items-center justify-center">
                    <svg class="w-5 h-5 text-slate-500 dark:text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" stroke-miterlimit="10"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" /></svg>
                </div>
            </button>

            <button id="btn-theme" class="p-2 rounded-full bg-white/50 dark:bg-black/20 hover:bg-white/80 transition shadow-sm border border-white/20">
                <svg id="icon-sun" class="w-5 h-5 text-yellow-600 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <svg id="icon-moon" class="w-5 h-5 text-slate-600 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
        </div>

        <div class="grid md:grid-cols-2 gap-10 items-center">
            
            <div class="flex flex-col items-center justify-center relative">
                
                <div class="absolute -top-16 -right-6 w-32 h-32 z-20 pointer-events-none drop-shadow-xl filter animate-float">
                  <svg viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="20" y="90" width="90" height="90" rx="8" fill="#D42426"/>
                      <rect x="55" y="90" width="20" height="90" fill="#F8B229"/>
                      <rect x="20" y="125" width="90" height="20" fill="#F8B229"/>
                      <path d="M55 90 C 55 60, 25 60, 25 90 L 65 90 C 65 60, 95 60, 95 90" stroke="#F8B229" stroke-width="6" fill="none" stroke-linecap="round"/>
                      <g transform="translate(110, 70)">
                          <path d="M-25 -35 L -10 0 M -25 -20 L -35 -45" stroke="#8B4513" stroke-width="5" stroke-linecap="round"/>
                          <path d="M25 -35 L 10 0 M 25 -20 L 35 -45" stroke="#8B4513" stroke-width="5" stroke-linecap="round"/>
                          <ellipse cx="0" cy="0" rx="40" ry="38" fill="#A0522D"/>
                          <ellipse cx="0" cy="18" rx="22" ry="15" fill="#D2B48C"/>
                          <circle cx="0" cy="12" r="10" fill="#D42426"/>
                          <circle cx="-14" cy="-5" r="4" fill="#3E2723"/>
                          <circle cx="14" cy="-5" r="4" fill="#3E2723"/>
                      </g>
                  </svg>
                </div>

                <div class="bg-white p-4 rounded-2xl qr-glow-blue relative z-10">
                    <canvas id="qrcode" class="block w-[220px] h-[220px]"></canvas>
                </div>

                <div class="mt-8 bg-white/60 dark:bg-slate-800/60 backdrop-blur-sm border border-white/40 px-5 py-2 rounded-full flex items-center gap-3 shadow-sm">
                    <span class="relative flex h-3 w-3">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span>
                    </span>
                    <span id="status-text" class="text-sm font-bold text-slate-700 dark:text-slate-300">ƒêang ch·ªù qu√©t m√£...</span>
                </div>
            </div>

            <div class="flex flex-col justify-center text-center md:text-left">
                
                <div class="mb-6">
                    <h3 class="text-sm font-bold text-xmas-red uppercase tracking-widest mb-1">Bin Bin Hotel</h3>
                    <h1 class="text-3xl md:text-4xl font-bold leading-tight">
                        Check-in <br>
                        <span class="text-gold-gradient text-4xl md:text-5xl">Gi√°ng Sinh</span> üéÑ
                    </h1>
                </div>

                <div class="grid grid-cols-1 gap-4 mb-6">
                    <div class="flex items-center gap-4 p-4 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800/30 transition-transform hover:scale-[1.02]">
                        <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 flex items-center justify-center shadow-sm">
                            <svg viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
                                <path d="M9.75 2C8.5 2 7.5 3 7.5 4.25V13.5C7.5 16 5.5 17.5 3.5 17.5C2.5 17.5 1.5 18.5 1.5 19.5C1.5 20.9 2.6 22 4 22C6.5 22 8.5 20.5 10 19V5.5H16.5C17.9 5.5 19 6.6 19 8V11H21.5V8C21.5 5.2 19.3 3 16.5 3H9.75V2Z" />
                                <path d="M16 2H10V5H16V2Z" opacity="0.5"/>
                            </svg>
                        </div>
                        <div class="text-left">
                            <p class="text-xs text-blue-600 dark:text-blue-400 font-bold uppercase">Nh√¢n vi√™n</p>
                            <p class="font-bold text-slate-800 dark:text-white text-lg truncate">{{ user.name }}</p>
                        </div>
                    </div>

                    <div id="shiftNotice" class="hidden items-center gap-4 p-4 rounded-xl transition-transform hover:scale-[1.02]">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center shadow-sm">
                            <svg viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
                                <path d="M12 2L15 8H13V10H16L12 18L8 10H11V8H9L12 2Z" />
                                <path d="M12 22C11.4 22 11 21.6 11 21V18H13V21C13 21.6 12.6 22 12 22Z" />
                                <path d="M5 21H19V22H5V21Z" opacity="0.3"/>
                            </svg>
                        </div>
                        <div class="text-left">
                            <p class="text-xs font-bold uppercase">Ca l√†m vi·ªác</p>
                            <p id="shiftText" class="font-bold text-slate-800 dark:text-white text-lg">Loading...</p>
                        </div>
                    </div>
                </div>

                <div class="border-t border-slate-200 dark:border-slate-700/50 pt-5 mt-2">
                     <p class="text-[11px] text-slate-400 font-bold uppercase tracking-widest mb-3">H∆Ø·ªöNG D·∫™N QU√âT M√É</p>
                     
                     <div class="grid grid-cols-2 gap-4">
                         <div class="flex items-center gap-3 p-3 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800/30 transition hover:bg-blue-100 dark:hover:bg-blue-900/30">
                             <div class="text-2xl filter drop-shadow-sm">‚õÑ</div> 
                             <div class="flex flex-col text-left">
                                 <span class="text-xs font-bold text-blue-600 dark:text-blue-300">Camera</span>
                                 <span class="text-[10px] text-slate-400">M·∫∑c ƒë·ªãnh</span>
                             </div>
                         </div>

                         <div class="flex items-center gap-3 p-3 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800/30 transition hover:bg-blue-100 dark:hover:bg-blue-900/30">
                             <div class="text-2xl filter drop-shadow-sm">üéÅ</div>
                             <div class="flex flex-col text-left">
                                 <span class="text-xs font-bold text-blue-600 dark:text-blue-300">Zalo QR</span>
                                 <span class="text-[10px] text-blue-400 dark:text-blue-400/70">Khuy√™n d√πng</span>
                             </div>
                         </div>
                     </div>
                </div>

            </div>
        </div>
    </div>
    
    <div class="mt-6 text-center">
        <p class="text-white/60 text-xs font-medium">¬© <span id="year"></span> Bin Bin Hotel Management System</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
  
  <script>
    // --- HI·ªÜU ·ª®NG N·ªÄN ƒê·ªòNG ---
    (function() {
        const canvas = document.getElementById('snowCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];
        let currentTheme = 'dark'; // M·∫∑c ƒë·ªãnh l√† t·ªëi

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- C·∫•u h√¨nh cho hi·ªáu ·ª©ng tuy·∫øt ---
        function createSnowflake() {
            return {
                x: Math.random() * width,
                y: Math.random() * -height,
                radius: Math.random() * 2 + 1,
                speed: Math.random() * 1 + 0.5,
                opacity: Math.random() * 0.5 + 0.3
            };
        }

        function drawSnowflakes() {
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = "white";
            particles.forEach(f => {
                ctx.globalAlpha = f.opacity;
                ctx.beginPath();
                ctx.arc(f.x, f.y, f.radius, 0, Math.PI * 2);
                ctx.fill();
                f.y += f.speed;
                f.x += Math.sin(f.y * 0.01) * 0.5;
                if (f.y > height) {
                    Object.assign(f, createSnowflake(), { y: -5 });
                }
            });
        }

        // --- C·∫•u h√¨nh cho hi·ªáu ·ª©ng l√° r∆°i ---
        const leafColors = ['#D42426', '#F8B229', '#f97316', '#ca8a04', '#eab308'];
        function createLeaf() {
            return {
                x: Math.random() * width,
                y: Math.random() * -height,
                size: Math.random() * 10 + 8,
                speed: Math.random() * 1 + 1,
                rotation: Math.random() * 360,
                rotationSpeed: (Math.random() - 0.5) * 2,
                sway: Math.random() * 2 - 1,
                color: leafColors[Math.floor(Math.random() * leafColors.length)]
            };
        }

        function drawLeaves() {
            ctx.clearRect(0, 0, width, height);
            particles.forEach(leaf => {
                ctx.save();
                ctx.translate(leaf.x, leaf.y);
                ctx.rotate(leaf.rotation * Math.PI / 180);
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.quadraticCurveTo(leaf.size / 2, -leaf.size / 4, leaf.size, 0);
                ctx.quadraticCurveTo(leaf.size / 2, leaf.size / 4, 0, 0);
                ctx.closePath();
                ctx.fillStyle = leaf.color;
                ctx.fill();
                ctx.restore();

                leaf.y += leaf.speed;
                leaf.x += leaf.sway + Math.sin(leaf.y * 0.05);
                leaf.rotation += leaf.rotationSpeed;

                if (leaf.y > height) {
                    Object.assign(leaf, createLeaf(), { y: -20 });
                }
            });
        }

        // --- Logic ch√≠nh ---
        let animationFrameId;
        function animate() {
            if (currentTheme === 'dark') {
                drawSnowflakes();
            } else {
                drawLeaves();
            }
            animationFrameId = requestAnimationFrame(animate);
        }

        window.setThemeEffect = function(theme) {
            if (theme === currentTheme) return;
            currentTheme = theme;
            particles = [];
            const particleCount = currentTheme === 'dark' ? 100 : 50;
            const createParticle = currentTheme === 'dark' ? createSnowflake : createLeaf;
            for(let i = 0; i < particleCount; i++) {
                particles.push(createParticle());
            }
            if (!animationFrameId) {
                animate();
            }
        }
    })();
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 1. QR Code
      const checkinUrl = "{{ base_url }}/attendance/checkin?token={{ qr_token }}";
      const qr = new QRious({ 
          element: document.getElementById('qrcode'), 
          value: checkinUrl, 
          size: 220,
          level: 'H'
      });

      // 2. Poll Status
      const statusText = document.getElementById('status-text');
      async function pollCheckin() {
        try {
          const res = await fetch(`/attendance/checkin_status?token={{ qr_token }}&t=` + Date.now(), { credentials: 'same-origin' });
          const data = await res.json();
          if (data.checked_in) {
            statusText.textContent = 'Th√†nh c√¥ng! ƒêang chuy·ªÉn...';
            statusText.className = "text-sm font-bold text-green-600";
            if (data.redirect_to) window.location.href = data.redirect_to;
            else window.location.href = '/choose-function';
          } else {
            setTimeout(pollCheckin, 2500);
          }
        } catch {
          setTimeout(pollCheckin, 3500);
        }
      }
      pollCheckin();

      // 3. Shift Logic (M√†u ƒê·ªè ƒê·ªìng B·ªô)
      const shiftNoticeEl = document.getElementById('shiftNotice');
      const shiftTextEl = document.getElementById('shiftText');
      const now = new Date();
      const currentHour = now.getHours();
      let workDate = new Date(now);
      let shiftName = '';
      
      const uniformStyle = 'bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800/30';

      if (currentHour < 7) {
          workDate.setDate(workDate.getDate() - 1);
          shiftName = 'Ca ƒê√™m';
      } else if (currentHour >= 7 && currentHour < 19) {
          shiftName = 'Ca Ng√†y';
      } else {
          shiftName = 'Ca ƒê√™m';
      }

      const dateStr = `${String(workDate.getDate()).padStart(2, '0')}/${String(workDate.getMonth() + 1).padStart(2, '0')}`;
      
      shiftTextEl.innerHTML = `${shiftName} <span class="text-sm font-normal opacity-70 ml-1">(${dateStr})</span>`;
      shiftNoticeEl.className = `flex items-center gap-4 p-4 rounded-xl transition-transform hover:scale-[1.02] ${uniformStyle}`;
      shiftNoticeEl.querySelector('p:first-child').classList.add('text-blue-600', 'dark:text-blue-400');
      shiftNoticeEl.querySelector('div:first-child').classList.add('bg-blue-100', 'dark:bg-blue-900/30', 'text-blue-600', 'dark:text-blue-300');
      shiftNoticeEl.classList.remove('hidden');

      // 4. Theme Toggle & Music Logic
      const root = document.documentElement;
      const THEME_KEY = 'theme-mode';
      
      const audio = document.getElementById('bg-audio');
      const btnMusic = document.getElementById('btn-music');
      const iconOn = document.getElementById('icon-music-on');
      const iconOff = document.getElementById('icon-music-off');
      let isPlaying = false;

      audio.volume = 0.4;

      function toggleMusicState(play) {
        if (play) {
            audio.play().then(() => {
                isPlaying = true;
                iconOn.classList.remove('hidden');
                iconOff.classList.add('hidden');
            }).catch(() => {
                console.log("Autoplay blocked, waiting for interaction");
            });
        } else {
            audio.pause();
            isPlaying = false;
            iconOn.classList.add('hidden');
            iconOff.classList.remove('hidden');
        }
      }

      btnMusic.addEventListener('click', () => toggleMusicState(!isPlaying));

      // C·ªë g·∫Øng t·ª± ƒë·ªông ph√°t nh·∫°c. N·∫øu th·∫•t b·∫°i, s·∫Ω ch·ªù ng∆∞·ªùi d√πng t∆∞∆°ng t√°c l·∫ßn ƒë·∫ßu.
      let audioUnlocked = false;
      const tryAutoPlay = () => {
        audio.play().then(() => {
            toggleMusicState(true);
        }).catch(() => {
            // N·∫øu t·ª± ƒë·ªông ph√°t th·∫•t b·∫°i, th√™m s·ª± ki·ªán click m·ªôt l·∫ßn v√†o trang
            document.body.addEventListener('click', unlockAndPlay, { once: true });
        });
      };

      const unlockAndPlay = () => {
        toggleMusicState(true);
      };
      tryAutoPlay();
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      function applyTheme(mode){
        if (mode === 'dark' || (mode === 'system' && prefersDark)) {
          root.classList.add('dark');
          document.getElementById('icon-sun').classList.remove('hidden');
          document.getElementById('icon-moon').classList.add('hidden');
          window.setThemeEffect('dark');
        } else {
          root.classList.remove('dark');
          document.getElementById('icon-sun').classList.add('hidden');
          document.getElementById('icon-moon').classList.remove('hidden');
          window.setThemeEffect('light');
        }
      }
      const saved = localStorage.getItem(THEME_KEY) || 'system';
      applyTheme(saved);
      document.getElementById('btn-theme').addEventListener('click', () => {
        const current = localStorage.getItem(THEME_KEY) || 'system';
        const next = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem(THEME_KEY, next);
        applyTheme(next);
      });

      document.getElementById('year').textContent = new Date().getFullYear();
    });
  </script>
</body>
<script>
  function checkAndLogoutForShiftChange() {
      const now = new Date();
      if ((now.getHours() === 6 || now.getHours() === 18) && now.getMinutes() === 59) {
          window.location.href = '/logout';
      }
  }
  setInterval(checkAndLogoutForShiftChange, 30000);
</script>
</html>
