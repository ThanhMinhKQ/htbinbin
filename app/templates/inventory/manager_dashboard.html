{% extends "base.html" %}

{% block title %}Quản lý Kho Vận hành{% endblock %}
{% block page_title %}Dashboard Quản Lý Kho{% endblock %}

{% block content %}
<div x-data="managerInventoryApp()" x-init="initApp()" class="flex flex-col h-full space-y-4">

    <div class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-4 sticky top-0 z-10">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
            <button @click="currentTab = 'overview'" x-show="currentTab === 'overview'"
                :class="currentTab === 'overview' ? 'border-primary-500 text-primary-600 dark:text-primary-400' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                Tổng quan Tồn kho
            </button>

            <button @click="currentTab = 'import'" x-show="currentTab === 'import'"
                :class="currentTab === 'import' ? 'border-green-500 text-green-600 dark:text-green-400' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Nhập Hàng (NCC)
            </button>

            <button @click="currentTab = 'export'" x-show="currentTab === 'export'"
                :class="currentTab === 'export' ? 'border-orange-500 text-orange-600 dark:text-orange-400' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors flex items-center gap-2 relative">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                Nghiệp vụ Xuất kho
                <span x-show="pendingTickets.length > 0" x-text="pendingTickets.length"
                    class="ml-2 px-2 py-0.5 rounded-full bg-red-100 text-red-600 text-xs font-bold animate-pulse"></span>
            </button>
        </nav>
    </div>

    {% include 'inventory/manager/overview.html' %}
    {% include 'inventory/manager/overview.html' %}
    {% include 'inventory/manager/imports/tab_import.html' %}
    {% include 'inventory/manager/export.html' %}

    {# Modals #}
    {% include 'inventory/manager/imports/modal_import.html' %}
    {% include 'inventory/manager/imports/modal_import_detail.html' %}
    {% include 'inventory/manager/imports/modal_edit_import.html' %}
    {% include 'inventory/manager/export.html' %}

</div>
{% endblock %}

{% block scripts %}
<script id="products-data-source" type="application/json">
    {{ products_json | safe }}
</script>

<script>
    // [FIX] 2. Đọc dữ liệu từ thẻ script trên và Parse vào biến
    let PRODUCTS_DB = [];
    try {
        const dataElement = document.getElementById('products-data-source');
        if (dataElement && dataElement.textContent) {
            PRODUCTS_DB = JSON.parse(dataElement.textContent);
        }
    } catch (e) {
        console.error("Lỗi parse dữ liệu sản phẩm:", e);
        PRODUCTS_DB = [];
    }

    function managerInventoryApp() {
        return {
            // [REFACTOR] State quản lý 2 cấp
            currentTab: 'overview', // 'overview', 'import', 'export'
            exportTab: 'requests',  // 'requests', 'direct', 'history'

            filterBranch: '',
            stocks: [],
            productList: PRODUCTS_DB,
            userRole: '{{ user.role.value if user and user.role else "manager" }}',

            // Shared State
            isSubmitting: false,
            loading: false,

            // Stub for dynamically loaded function
            getAllImportsSelected() { return false; },

            // Export/Requests State
            pendingTickets: [],
            historyTickets: [],
            selectedTicket: null,
            viewingHistoryTicket: null,
            approvalForm: { items: [], approver_notes: '' },
            historyFilters: { date_from: '', date_to: '' },

            // Direct Issue State
            directIssueForm: {
                source_warehouse_id: '',
                dest_warehouse_id: '',
                items: [],
                notes: ''
            },

            // Import State (Full Port from Reception)
            importTab: 'create', // Not used as much with Modals, but kept for compatibility
            importsList: [],
            loadingImports: false,
            currentImportPage: 1,
            totalImportPages: 1,
            totalImportRecords: 0,
            perPage: 10,
            importSort: { column: 'created_at', order: 'desc' },
            importFilters: { search: '', date_from: '', date_to: '' },
            selectedImportIds: [],
            lastCheckedImportIndex: null,

            // Import Form State
            isImportModalOpen: false,
            importForm: {
                warehouse_id: '{{ warehouses[0].id if warehouses else "" }}',
                supplier_name: '',
                notes: '',
                itemGroups: [],
                images: []
            },

            // Import Detail State
            isImportDetailModalOpen: false,
            loadingImportDetail: false,
            importDetail: null,

            // Edit Import State
            isEditImportModalOpen: false,
            editingImportId: null,
            editImportForm: {
                supplier_name: '',
                notes: '',
                itemGroups: [],
                existingImages: [],
                newImages: [],
                pendingDeletes: []
            },

            // Normalized Categories/Products for Import Form (Grouped logic compatibility)
            normalizedCategories: [],
            normalizedProducts: PRODUCTS_DB, // Use global DB

            async initApp() {
                // Prepare Categories for Import Dropdown
                // We use global `categories` passed from server? 
                // Wait, manager_dashboard.html doesn't receive `categories` variable in `manager_dashboard` route!
                // We need to fetch it or extract it from products.

                // Extract categories from PRODUCTS_DB if not available
                const catMap = new Map();
                this.normalizedProducts.forEach(p => {
                    if (p.category_id && p.category_name) {
                        catMap.set(p.category_id, p.category_name);
                    }
                });
                this.normalizedCategories = Array.from(catMap.entries()).map(([id, name]) => ({ id, name }));

                // Load Import Module Logic
                try {
                    const module = await import("{{ url_for('static', path='/js/inventory/modules/manager/imports.js') }}?v=" + Date.now());
                    const importLogic = module.default;

                    // Merge logic into this component
                    Object.assign(this, importLogic);

                    // Bind helper functions that rely on 'this'
                    // Alpine proxied objects handle this usually, but explicit binding might be safer if needed.
                } catch (e) {
                    console.error("Failed to load manager import module", e);
                }

                // Compress Image Helper (Copied from reception/index.js base or similar)
                this.compressImage = async (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = (event) => {
                            const img = new Image();
                            img.src = event.target.result;
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const MAX_WIDTH = 1200;
                                const MAX_HEIGHT = 1200;
                                let width = img.width;
                                let height = img.height;

                                if (width > height) {
                                    if (width > MAX_WIDTH) {
                                        height *= MAX_WIDTH / width;
                                        width = MAX_WIDTH;
                                    }
                                } else {
                                    if (height > MAX_HEIGHT) {
                                        width *= MAX_HEIGHT / height;
                                        height = MAX_HEIGHT;
                                    }
                                }
                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);
                                canvas.toBlob((blob) => {
                                    if (blob) {
                                        resolve(new File([blob], file.name, {
                                            type: file.type,
                                            lastModified: Date.now(),
                                        }));
                                    } else {
                                        reject(new Error('Canvas is empty'));
                                    }
                                }, file.type, 0.7);
                            };
                            img.onerror = (error) => reject(error);
                        };
                        reader.onerror = (error) => reject(error);
                    });
                };

                this.getCurrentMonthRange = () => {
                    const date = new Date();
                    const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
                    const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
                    const formatDate = (d) => {
                        let month = '' + (d.getMonth() + 1), day = '' + d.getDate(), year = d.getFullYear();
                        if (month.length < 2) month = '0' + month;
                        if (day.length < 2) day = '0' + day;
                        return [year, month, day].join('-');
                    };
                    return { start: formatDate(firstDay), end: formatDate(lastDay) };
                };

                this.createEmptyGroup = () => ({ id: Date.now() + Math.random(), category_id: '', items: [this.createEmptyItem()] });
                this.createEmptyItem = () => ({ id: Date.now() + Math.random(), product_id: '', quantity: 1, unit: '', unit_price: 0, available_units: [] });

                this.getFlatImportFormItems = () => {
                    return this.importForm.itemGroups.flatMap(g => g.items.map(i => ({ ...i, category_id: g.category_id })));
                };

                this.getFlatEditImportFormItems = () => {
                    return this.editImportForm.itemGroups.flatMap(g => g.items.map(i => ({ ...i, category_id: g.category_id })));
                };

                // [REFACTOR] Xử lý URL Tab cho cả 2 cấp
                const urlParams = new URLSearchParams(window.location.search);
                const tab = urlParams.get('tab');
                const sub = urlParams.get('sub');

                if (tab) {
                    if (tab === 'overview') this.currentTab = 'overview';
                    else if (tab === 'import') {
                        this.currentTab = 'import';
                        if (sub === 'history') { // Legacy support, now basic list
                            this.fetchImports();
                        } else {
                            // Default to list view
                            this.fetchImports();
                        }
                    }
                    // Logic gom nhóm Export
                    else if (tab === 'export' || tab === 'requests' || tab === 'history' || tab === 'direct_issue') {
                        this.currentTab = 'export';

                        // Set sub-tab
                        if (tab === 'history') {
                            this.exportTab = 'history';
                            this.fetchHistoryTickets();
                        } else if (tab === 'direct_issue') {
                            this.exportTab = 'direct';
                        } else {
                            this.exportTab = 'requests'; // Default sub-tab
                        }
                    }
                }

                this.fetchStock();
                this.fetchPendingTickets();
                // Fetch imports initially if on import tab
                if (this.currentTab === 'import') this.fetchImports();

                // Tự động reload định kỳ
                setInterval(() => {
                    this.fetchPendingTickets();
                }, 30000);
            },

            // --- TAB 1: OVERVIEW ---
            async fetchStock() {
                let url = '/api/inventory/report-realtime';
                if (this.filterBranch) url += `?branch_id=${this.filterBranch}`;

                try {
                    const res = await fetch(url);
                    const json = await res.json();
                    this.stocks = json.data;
                } catch (e) { console.error(e); }
            },

            // --- TAB 2: IMPORT LOGIC ---

            addImportItem() {
                this.importForm.items.push({
                    product_id: '',
                    quantity: 1,
                    unit: '',
                    unit_price: 0,
                    available_units: []
                });
            },

            removeImportItem(index) {
                if (this.importForm.items.length > 1) {
                    this.importForm.items.splice(index, 1);
                } else {
                    this.importForm.items[0].product_id = '';
                    this.importForm.items[0].unit = '';
                    this.importForm.items[0].unit_price = 0;
                }
            },

            onProductChange(index) {
                const item = this.importForm.items[index];
                const product = this.productList.find(p => p.id == item.product_id);

                if (product) {
                    item.available_units = [product.base_unit];
                    if (product.packing_unit && product.conversion_rate > 1) {
                        item.available_units.unshift(product.packing_unit);
                    }

                    item.unit = item.available_units[0];
                    item.unit_price = product.cost_price;
                }
            },

            calculateImportTotal() {
                let total = 0;
                this.importForm.items.forEach(item => {
                    total += (item.quantity || 0) * (item.unit_price || 0);
                });
                return this.formatMoney(total);
            },

            async submitImport() {
                if (!this.importForm.warehouse_id || !this.importForm.supplier_name) {
                    alert("Vui lòng chọn Kho và nhập tên Nhà cung cấp");
                    return;
                }
                const validItems = this.importForm.items.filter(i => i.product_id && i.quantity > 0);
                if (validItems.length === 0) {
                    alert("Vui lòng nhập ít nhất 1 sản phẩm");
                    return;
                }

                this.isSubmitting = true;
                try {
                    const payload = {
                        ...this.importForm,
                        items: validItems
                    };

                    const res = await fetch('/api/inventory/import', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();
                    if (res.ok) {
                        alert(data.message);
                        this.importForm.supplier_name = '';
                        this.importForm.notes = '';
                        this.importForm.items = [];
                        this.addImportItem();
                        this.currentTab = 'overview'; // Quay về overview
                        this.fetchStock();
                    } else {
                        alert("Lỗi: " + data.detail);
                    }
                } catch (e) {
                    alert("Lỗi kết nối server");
                } finally {
                    this.isSubmitting = false;
                }
            },

            async fetchReceiptHistory() {
                try {
                    const params = new URLSearchParams();
                    params.append('per_page', 50);
                    if (this.receiptFilters.date_from) params.append('date_from', this.receiptFilters.date_from);
                    if (this.receiptFilters.date_to) params.append('date_to', this.receiptFilters.date_to);

                    const res = await fetch(`/api/inventory/receipts?${params.toString()}`);
                    const data = await res.json();

                    if (data.records) {
                        this.receiptHistory = data.records;
                    } else if (Array.isArray(data)) {
                        this.receiptHistory = data;
                    }
                } catch (e) { console.error(e); }
            },

            openReceiptModal(receipt) {
                this.viewingReceipt = receipt;
            },
            closeReceiptModal() {
                this.viewingReceipt = null;
            },

            // --- TAB 3: EXPORT LOGIC GROUP ---

            // 3.1 Requests
            async fetchPendingTickets() {
                try {
                    const res = await fetch('/api/inventory/requests?status=PENDING');
                    this.pendingTickets = await res.json();
                } catch (e) { console.error(e); }
            },

            selectTicket(ticket) {
                this.selectedTicket = ticket;
                this.approvalForm = {
                    approver_notes: '',
                    items: ticket.items.map(i => ({
                        id: i.id,
                        product_id: i.product_id,
                        product_name: i.product_name,
                        request_quantity: i.request_quantity,
                        request_unit: i.request_unit,
                        approved_quantity: i.request_quantity
                    }))
                };
            },

            async submitApproval() {
                if (!confirm("Bạn chắc chắn muốn duyệt phiếu này? Kho tổng sẽ bị trừ tồn kho ngay lập tức.")) return;

                try {
                    const res = await fetch(`/api/inventory/approve/${this.selectedTicket.id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.approvalForm)
                    });

                    const data = await res.json();
                    if (res.ok) {
                        alert(data.message);
                        this.selectedTicket = null;
                        this.fetchPendingTickets();
                        this.fetchStock();
                    } else {
                        alert(data.detail);
                    }
                } catch (e) { alert("Lỗi kết nối"); }
            },

            // 3.2 Direct Issue
            addDirectIssueItem() {
                this.directIssueForm.items.push({
                    product_id: '',
                    quantity: 1,
                    unit: '',
                    available_units: []
                });
            },

            removeDirectIssueItem(index) {
                if (this.directIssueForm.items.length > 1) {
                    this.directIssueForm.items.splice(index, 1);
                } else {
                    this.directIssueForm.items[0].product_id = '';
                    this.directIssueForm.items[0].unit = '';
                }
            },

            onDirectProductChange(index) {
                const item = this.directIssueForm.items[index];
                const product = this.productList.find(p => p.id == item.product_id);

                if (product) {
                    item.available_units = [product.base_unit];
                    if (product.packing_unit && product.conversion_rate > 1) {
                        item.available_units.unshift(product.packing_unit);
                    }
                    item.unit = item.available_units[0];
                }
            },

            async submitDirectIssue() {
                if (!this.directIssueForm.dest_warehouse_id) {
                    alert("Vui lòng chọn Kho nhận hàng");
                    return;
                }
                const validItems = this.directIssueForm.items.filter(i => i.product_id && i.quantity > 0);
                if (validItems.length === 0) {
                    alert("Vui lòng xuất ít nhất 1 sản phẩm");
                    return;
                }

                if (!confirm(`Xác nhận xuất ${validItems.length} mặt hàng cho kho nhánh? Kho tổng sẽ bị trừ tồn ngay lập tức.`)) return;

                this.isSubmitting = true;
                try {
                    const payload = {
                        source_warehouse_id: this.directIssueForm.source_warehouse_id || null,
                        dest_warehouse_id: parseInt(this.directIssueForm.dest_warehouse_id),
                        items: validItems,
                        notes: this.directIssueForm.notes
                    };
                    const res = await fetch('/api/inventory/transfers/direct', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();
                    if (res.ok) {
                        alert(data.message);
                        this.directIssueForm.notes = '';
                        this.directIssueForm.items = [];
                        this.addDirectIssueItem();
                        this.currentTab = 'overview';
                        this.fetchStock();
                    } else {
                        alert("Lỗi: " + data.detail);
                    }
                } catch (e) {
                    alert("Lỗi kết nối server");
                } finally {
                    this.isSubmitting = false;
                }
            },

            // 3.3 History
            async fetchHistoryTickets() {
                try {
                    const params = new URLSearchParams();
                    const historyStatuses = ['APPROVED', 'COMPLETED', 'SHIPPING', 'REJECTED', 'CANCELLED'];
                    params.append('status', historyStatuses.join(','));
                    params.append('per_page', 50);

                    if (this.historyFilters.date_from) params.append('date_from', this.historyFilters.date_from);
                    if (this.historyFilters.date_to) params.append('date_to', this.historyFilters.date_to);

                    const res = await fetch(`/api/inventory/requests?${params.toString()}`);
                    const data = await res.json();

                    if (data.records) {
                        this.historyTickets = data.records;
                    } else if (Array.isArray(data)) {
                        this.historyTickets = data;
                    }
                } catch (e) { console.error(e); }
            },

            formatMoney(amount) {
                return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
            },

            // --- [NEW] LOGIC CHECK TRẠNG THÁI PHIẾU ---
            getTicketFulfillmentStatus(ticket) {
                if (ticket.status === 'REJECTED') {
                    return { code: 'REJECTED', label: 'Đã từ chối' };
                }

                // Nếu là xuất trực tiếp (thường là COMPLETED và ko có request_quantity hoặc request=approved)
                // Tuy nhiên logic ở trên đã filter riêng visually, hàm này chủ yếu cho phiếu Yêu Cầu

                let isShort = false;
                let isExcess = false;

                if (!ticket.items || ticket.items.length === 0) return { code: 'FULL', label: 'Đủ hàng' };

                for (let item of ticket.items) {
                    const req = parseFloat(item.request_quantity || 0);
                    const app = parseFloat(item.approved_quantity || 0);

                    // Sai số nhỏ cho phép (epsilon)
                    if (app < req - 0.01) isShort = true;
                    if (app > req + 0.01) isExcess = true;
                }

                if (isShort) return { code: 'SHORT', label: 'Thiếu hàng' };
                if (isExcess) return { code: 'EXCESS', label: 'Dư hàng' };
                return { code: 'FULL', label: 'Đủ hàng' };
            },

            // --- [NEW] MODAL HELPERS ---
            openHistoryModal(ticket) {
                this.viewingHistoryTicket = ticket;
                // Có thể fetch chi tiết mới nhất từ server nếu cần, nhưng tạm thời dùng data local
            },

            closeHistoryModal() {
                this.viewingHistoryTicket = null;
            }
        }
    }
</script>
{% endblock %}