  <!DOCTYPE html>
  <html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>ƒêi·ªÉm danh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --safe-top: env(safe-area-inset-top, 0px);
      }

      /* ===== Animations ===== */
      @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
      @keyframes slideUp { from { transform: translateY(16px); opacity: 0 } to { transform: translateY(0); opacity: 1 } }
      @keyframes sheetUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

      .animate-fadeIn { animation: fadeIn .35s ease-out both; }
      .animate-slideUp { animation: slideUp .35s ease-out both; }
      .animate-sheetUp { animation: sheetUp .32s cubic-bezier(.22,.61,.36,1) both; }

      /* ===== Card swipe-to-delete (iOS-like) ===== */
      .swipe-container {
        position: relative;
        overflow: hidden;
        touch-action: pan-y;
      }
      .swipe-actions {
        position: absolute;
        inset: 0;
        display: flex;
        justify-content: flex-end;
        align-items: stretch;
        background: #fee2e2; /* red-100 */
        padding-right: .5rem;
      }
      .swipe-actions button {
        min-width: 72px;
        border-radius: 12px;
        margin: auto .25rem;
        height: 44px;
      }
      .swipe-content {
        position: relative;
        background: white;
        transform: translateX(0);
        transition: transform .18s ease-out;
        border-radius: 16px;
        box-shadow: 0 6px 22px rgba(0,0,0,.06);
      }

      /* ===== Bottom bar glass ===== */
      .glass {
        background: rgba(255,255,255,.82);
        -webkit-backdrop-filter: saturate(180%) blur(16px);
        backdrop-filter: saturate(180%) blur(16px);
      }

      /* ===== Bottom sheet ===== */
      .sheet {
        position: fixed;
        left: 0; right: 0; bottom: 0;
        background: #fff;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        box-shadow: 0 -10px 30px rgba(0,0,0,.12);
        max-height: 78vh;
        padding-bottom: calc(16px + var(--safe-bottom));
      }
      .sheet-handle {
        width: 44px; height: 5px; border-radius: 999px;
        background: #e5e7eb; /* gray-200 */
        margin: 8px auto 12px;
      }

      /* Hide native scrollbars on mobile for cleaner look */
      ::-webkit-scrollbar { width: 0; height: 0; }
    </style>
  </head>

  <body class="bg-gray-50 min-h-screen pb-28">
    <div class="max-w-xl mx-auto px-4 pt-3 space-y-3 animate-fadeIn">
      <!-- Header -->
      <header class="pt-[var(--safe-top)] flex items-center justify-between">
        <h1 class="text-2xl font-bold tracking-tight">üìã ƒêi·ªÉm danh</h1>
        <span class="text-[11px] px-2 py-1 rounded-full bg-blue-50 text-blue-600">GPS x√°c ƒë·ªãnh</span>
      </header>

      <!-- Branch info -->
      <section id="branchInfo" class="bg-gradient-to-r from-sky-50 to-blue-50 p-3 rounded-2xl text-[13px] text-gray-700 shadow-sm flex items-center gap-2">
        <span>üìç</span>
        <span class="font-medium">Chi nh√°nh l√†m:</span>
        <span id="branchName" class="text-blue-700">(ƒëang x√°c ƒë·ªãnh...)</span>
      </section>

      <!-- Top status / helper -->
      <div id="topInfo" class="text-[13px] text-gray-600"></div>

      <!-- Quick search -->
      <div class="flex gap-2">
        <button id="refreshBtn" class="px-3 rounded-xl bg-gray-100 text-[13px] hover:bg-gray-200">T·∫£i l·∫°i</button>
        <button id="addEmployeeBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm font-medium hover:bg-indigo-700">+ Th√™m nh√¢n vi√™n</button>
      </div>

      <!-- Attendance list (cards) -->
      <div id="attendanceList" class="space-y-3"></div>

      <!-- Empty hint -->
      <div id="emptyHint" class="hidden text-center text-gray-500 text-sm py-12">
        Danh s√°ch tr·ªëng. H√£y th√™m nh√¢n vi√™n b·∫±ng √¥ t√¨m ki·∫øm ho·∫∑c n√∫t <span class="font-medium text-gray-700">+ Th√™m ca</span> b√™n d∆∞·ªõi.
      </div>
    </div>

    <!-- Bottom action bar -->
    <div class="fixed left-0 right-0 bottom-0 glass border-t border-gray-200 shadow-lg">
      <div class="max-w-xl mx-auto px-4 py-2.5 flex gap-2 items-center" style="padding-bottom: calc(10px + var(--safe-bottom));">
        <button id="saveBtn" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-semibold active:scale-[.99] transition-colors">üíæ L∆∞u</button>
      </div>
      <div class="max-w-xl mx-auto px-4 pb-2 -mt-2 text-[12px] text-gray-600">
        <span id="status">Ch∆∞a l∆∞u</span>
      </div>
    </div>

    <script>
      /*
        UI iOS 2025 ‚Äì Gi·ªØ logic c≈©:
        - getSheetName, safeFetchJson, loadEmployeesForBranch, addBySearchQuery, saveAttendance
        - GPS detect ‚Üí /attendance/api/detect-branch
        - D·ªØ li·ªáu ·∫©n: branch, branch_today, la_tang_ca v·∫´n g·ª≠i khi l∆∞u
      */

      /* ---------- Config & helpers ---------- */
      let currentBranch = "{{ branch_id }}" || "";
      const loginCode = "{{ login_code }}"; // m√£ nh√¢n vi√™n ƒëƒÉng nh·∫≠p
      const csrfToken = "{{ csrf_token }}";

      const byBranchUrl = (b) => `/attendance/api/employees/by-branch/${encodeURIComponent(b)}`;
      const searchUrl = (q) => `/attendance/api/employees/search?q=${encodeURIComponent(q)}`;
      const saveUrl = () => `/attendance/checkin_bulk`;

      let employees = []; // danh s√°ch row ƒëang hi·ªÉn th·ªã

      function log(...args){ console.log("[attendance]", ...args); }
      function showStatus(text){ document.getElementById("status").textContent = text; }

      // Sheet mapping ‚Äì gi·ªØ nguy√™n logic c≈©
      function getSheetName(code){
        if(!code) return "Khac";
        if (code.includes("BPTC") || code.includes("LTTC")) return "TC";
        if (code.includes("BP")) return "BP";
        if (code.includes("LT")) return "LT";
        if (code.includes("BV")) return "BV";
        if (code.includes("QL")) return "QL";
        if (code === "KTV") return "KTV";
        return "Khac";
      }

      async function safeFetchJson(url, options){
        const res = await fetch(url, options);
        if (!res.ok){
          const text = await res.text().catch(()=>"(no body)");
          throw new Error(`HTTP ${res.status}: ${text}`);
        }
        const ct = res.headers.get("content-type") || "";
        if (ct.includes("application/json")) return await res.json();
        return await res.text();
      }

      function escapeHtml(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
      function escapeAttr(s){ return String(s).replaceAll('"','&quot;'); }

      function departmentDisplay(dep) {
        const map = {
          letan: "L·ªÖ t√¢n",
          buongphong: "Bu·ªìng ph√≤ng",
          baove: "B·∫£o v·ªá"
          // th√™m c√°c b·ªô ph·∫≠n kh√°c n·∫øu c√≥
        };
        return map[dep?.toLowerCase()] || dep || "";
      }

      /* ---------- UI: render Card list + Swipe-to-delete ---------- */
      function renderAttendanceList(){
        const wrap = document.getElementById("attendanceList");
        wrap.innerHTML = "";
        const empty = document.getElementById("emptyHint");
        empty.classList.toggle("hidden", employees.length > 0);

        employees.forEach((emp, idx) => {
          // t√≠nh tƒÉng ca
          const isTangCa = (emp.branch_today || currentBranch) !== (emp.branch || "");
          emp.la_tang_ca = !!isTangCa;

          const container = document.createElement("div");
          container.className = "swipe-container animate-slideUp";

          // actions (delete)
          const actions = document.createElement("div");
          actions.className = "swipe-actions";
          actions.innerHTML = `
            <button class="bg-red-600 text-white text-sm px-3" data-idx="${idx}">X√≥a</button>
          `;

          const card = document.createElement("div");
          card.className = "swipe-content p-3";

          card.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-semibold text-[15px] truncate">${escapeHtml(emp.name || "")}</div>
                <div class="text-[12px] text-gray-500 mt-0.5">
                  B·ªô ph·∫≠n: ${escapeHtml(departmentDisplay(emp.department))}
                </div>
                ${emp.la_tang_ca ? `<div class="inline-flex items-center text-[11px] mt-1 px-2 py-0.5 bg-amber-50 text-amber-700 rounded-full border border-amber-100">TƒÉng ca</div>` : ``}
              </div>
              <button class="text-gray-400 active:scale-95" title="X√≥a" data-idx="${idx}" data-action="delete">‚úï</button>
            </div>

            <div class="mt-3 flex items-center gap-2">
              <label class="text-[12px] text-gray-600">S·ªë c√¥ng</label>
              <select class="border border-gray-200 rounded-lg text-sm px-2 py-1 h-9 min-w-[72px]" data-idx="${idx}" data-field="so_cong_nv">
                <option value="0.5" ${emp.so_cong_nv===0.5?"selected":""}>0.5</option>
                <option value="1" ${!emp.so_cong_nv || emp.so_cong_nv===1?"selected":""}>1</option>
                <option value="1.5" ${emp.so_cong_nv===1.5?"selected":""}>1.5</option>
                <option value="2" ${emp.so_cong_nv===2?"selected":""}>2</option>
                <option value="2.5" ${emp.so_cong_nv===2.5?"selected":""}>2.5</option>
              </select>

              <input class="flex-1 border border-gray-200 rounded-lg text-sm px-3 py-2" placeholder="Ghi ch√∫"
                    value="${escapeAttr(emp.ghi_chu||"")}" data-idx="${idx}" data-field="ghi_chu"/>
            </div>

            <!-- D·ªØ li·ªáu ·∫©n gi·ªØ ƒë√∫ng payload khi l∆∞u -->
            <div class="hidden">
              <span data-field="branch">${escapeHtml(emp.branch || "")}</span>
              <span data-field="branch_today">${escapeHtml(emp.branch_today || currentBranch)}</span>
              <span data-field="la_tang_ca">${emp.la_tang_ca ? "1":"0"}</span>
            </div>
          `;

          // Swipe-to-delete logic
          let startX = 0, currentX = 0, dragged = false;
          const threshold = 68; // m·ªü actions khi k√©o > threshold
          const maxTranslate = 84; // gi·ªõi h·∫°n k√©o

          function onTouchStart(e){
            const touch = e.touches[0];
            startX = touch.clientX;
            currentX = startX;
            dragged = true;
            card.style.transition = "none";
          }
          function onTouchMove(e){
            if(!dragged) return;
            const touch = e.touches[0];
            currentX = touch.clientX;
            let dx = currentX - startX;
            if (dx > 0) dx = 0; // ch·ªâ k√©o sang tr√°i
            if (dx < -maxTranslate) dx = -maxTranslate;
            card.style.transform = `translateX(${dx}px)`;
          }
          function onTouchEnd(){
            if(!dragged) return;
            dragged = false;
            card.style.transition = "transform .18s ease-out";
            const dx = currentX - startX;
            if (dx < -threshold) {
              card.style.transform = `translateX(${-maxTranslate}px)`; // gi·ªØ m·ªü
            } else {
              card.style.transform = "translateX(0)";
            }
          }

          card.addEventListener("touchstart", onTouchStart, {passive:true});
          card.addEventListener("touchmove", onTouchMove, {passive:true});
          card.addEventListener("touchend", onTouchEnd);

          // Wire events
          actions.querySelector("button").onclick = () => {
            employees.splice(idx,1);
            renderAttendanceList();
            showStatus("Ch∆∞a l∆∞u");
          };
          card.querySelector('[data-action="delete"]').onclick = () => {
            employees.splice(idx,1);
            renderAttendanceList();
            showStatus("Ch∆∞a l∆∞u");
          };
          card.querySelector('select[data-field="so_cong_nv"]').onchange = (e)=>{
            employees[idx].so_cong_nv = parseFloat(e.target.value);
            showStatus("Ch∆∞a l∆∞u");
          };
          card.querySelector('input[data-field="ghi_chu"]').oninput = (e)=>{
            employees[idx].ghi_chu = e.target.value;
            showStatus("Ch∆∞a l∆∞u");
          };

          container.appendChild(actions);
          container.appendChild(card);
          wrap.appendChild(container);
        });

        document.getElementById("topInfo").textContent =
          `ƒêang ƒëi·ªÉm danh cho chi nh√°nh: ${currentBranch || "(ch∆∞a x√°c ƒë·ªãnh)"} ‚Äî T·ªïng: ${employees.length}`;
      }

      /* ---------- Data loading & search ---------- */
      async function loadEmployeesForBranch(){
        if(!currentBranch){
          document.getElementById("topInfo").textContent = "L·ªói: currentBranch ch∆∞a x√°c ƒë·ªãnh.";
          return;
        }
        showStatus("ƒêang t·∫£i danh s√°ch...");
        try {
          const data = await safeFetchJson(byBranchUrl(currentBranch));
          if (!Array.isArray(data)) throw new Error("API tr·∫£ v·ªÅ kh√¥ng ph·∫£i m·∫£ng");

          employees = data.map(emp => ({
            code: emp.code || "",
            name: emp.name || "",
            department: emp.department || "",
            branch: emp.branch || "",
            branch_today: currentBranch,
            la_tang_ca: false,
            so_cong_nv: 1,
            service: [],
            ghi_chu: ""
          }));

          // T·ª± th√™m ng∆∞·ªùi ƒëƒÉng nh·∫≠p n·∫øu ch∆∞a c√≥
          if (loginCode && !employees.some(e => e.code === loginCode)) {
            let found = employees.find(e => e.code === loginCode);
            if (!found) {
              try {
                const searchData = await safeFetchJson(searchUrl(loginCode));
                if (Array.isArray(searchData) && searchData.length > 0) {
                  found = {
                    code: searchData[0].code,
                    name: searchData[0].name,
                    department: searchData[0].department,
                    branch: searchData[0].branch,
                    branch_today: currentBranch,
                    la_tang_ca: false,
                    so_cong_nv: 1,
                    service: [],
                    ghi_chu: ""
                  };
                }
              } catch(e) {}
            }
            if (found) employees.unshift(found);
          }

          renderAttendanceList();
          showStatus("ƒê√£ t·∫£i xong");
        } catch (err){
          console.error(err);
          showStatus("L·ªói khi t·∫£i: " + err.message);
          alert("L·ªói khi t·∫£i danh s√°ch nh√¢n vi√™n: " + err.message);
        }
      }

      async function addBySearchQuery(q){
        if(!q) return;
        showStatus("T√¨m nh√¢n vi√™n...");
        try {
          const data = await safeFetchJson(searchUrl(q));
          if (typeof data === "string"){ throw new Error("Server tr·∫£ v·ªÅ: " + data); }
          if (!Array.isArray(data) || data.length === 0){
            alert("Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n");
            showStatus("Kh√¥ng t√¨m th·∫•y");
            return;
          }
          const emp = data[0];
          const exists = employees.some(e => e.code === emp.code && e.branch_today === currentBranch);
          if (exists){
            alert("Nh√¢n vi√™n ƒë√£ c√≥ trong danh s√°ch");
            showStatus("ƒê√£ t·ªìn t·∫°i");
            return;
          }
          employees.push({
            code: emp.code,
            name: emp.name,
            department: emp.department,
            branch: emp.branch,
            branch_today: currentBranch,
            la_tang_ca: (emp.branch !== currentBranch),
            so_cong_nv: 1,
            service: [],
            ghi_chu: "TƒÉng ca"
          });
          renderAttendanceList();
          showStatus("ƒê√£ th√™m nh√¢n vi√™n");
        } catch(err){
          console.error(err);
          showStatus("L·ªói t√¨m ki·∫øm: " + err.message);
          alert("L·ªói t√¨m ki·∫øm: " + err.message);
        }
      }

      /* ---------- Save ---------- */
      async function saveAttendance(){
        if (employees.length === 0){
          alert("Danh s√°ch tr·ªëng, kh√¥ng c√≥ g√¨ ƒë·ªÉ l∆∞u.");
          return;
        }
        const payload = employees.map(emp => ({
          sheet: getSheetName(emp.code),
          thoi_gian: "", // ƒë·ªÉ server t·ª± sinh
          ma_nv: emp.code,
          ten_nv: emp.name,
          chi_nhanh_chinh: emp.branch,
          chi_nhanh_lam: emp.branch_today || currentBranch,
          la_tang_ca: !!emp.la_tang_ca,
          so_cong_nv: emp.so_cong_nv,
          ghi_chu: (emp.ghi_chu || "").slice(0,200),
          nguoi_diem_danh: loginCode //
        }));

        showStatus("ƒêang l∆∞u...");
        try {
          const res = await fetch(saveUrl(), {
            method: "POST",
            headers: {
              "Content-Type":"application/json",
              "X-CSRF-Token": csrfToken
            },
            body: JSON.stringify(payload)
          });
          if (!res.ok){
            const txt = await res.text().catch(()=>"(no body)");
            throw new Error(`HTTP ${res.status}: ${txt}`);
          }
          const doc = await res.json().catch(()=>null);
          if (doc && doc.status){
            showStatus("L∆∞u th√†nh c√¥ng (" + doc.inserted + " b·∫£n ghi)");
            alert("L∆∞u th√†nh c√¥ng");
            // --- QR: N·∫øu c√≥ token tr√™n URL, b√°o v·ªÅ server v√† x√°c nh·∫≠n ---
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get("token");
            if (token) {
              fetch("/attendance/checkin_success", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ token })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.redirect_to) {
                    window.location.href = data.redirect_to;  // frontend ch·ªß ƒë·ªông redirect
                } else {
                    alert("ƒêi·ªÉm danh th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i!");
                }
            })
            .catch(err => console.error("Checkin error:", err));


                  // n·∫øu ch∆∞a c√≥ th√¨ fallback check status nh∆∞ c≈©
                  let ok = false, tries = 0;
                  while (!ok && tries < 5) {
                    await new Promise(r => setTimeout(r, 1000));
                    const resp = await fetch("/attendance/checkin_status?token=" + encodeURIComponent(token));
                    const data = await resp.json();
                    if (data.checked_in) {
                      ok = true;
                      window.location.href = data.redirect_to ? ("/" + data.redirect_to) : "/choose-function";
                    }
                    tries++;
                  };
            }
          } else {
            showStatus("L∆∞u xong (kh√¥ng c√≥ ph·∫£n h·ªìi JSON h·ª£p l·ªá)");
            alert("L∆∞u xong");
          }
        } catch(err){
          console.error(err);
          showStatus("L·ªói khi l∆∞u: " + err.message);
          alert("L·ªói khi l∆∞u ƒëi·ªÉm danh: " + err.message);
        }
      }

      /* ---------- GPS detect ‚Üí set currentBranch ---------- */
      async function detectBranchByGPS(){
        let retry = 0;
        return new Promise((resolve) => {
          function tryGetGPS() {
            if (currentBranch && currentBranch !== "{{ branch_id }}") {
              resolve(currentBranch);
              return;
            }
            if (!navigator.geolocation){
              alert("Thi·∫øt b·ªã c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ GPS! B·∫°n v·∫´n c√≥ th·ªÉ ƒëi·ªÉm danh th·ªß c√¥ng.");
              resolve(null);
              return;
            }
            // Lu√¥n y√™u c·∫ßu quy·ªÅn v·ªã tr√≠ ch√≠nh x√°c
            navigator.geolocation.getCurrentPosition(async (pos) => {
              try {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                // Hi·ªÉn th·ªã v·ªã tr√≠ l·∫•y ƒë∆∞·ª£c ƒë·ªÉ debug
                console.log("GPS:", lat, lng);
                const data = await safeFetchJson("/attendance/api/detect-branch", {
                  method: "POST",
                  headers: { "Content-Type":"application/json" },
                  body: JSON.stringify({ lat, lng })
                });
                if (data && data.branch){
                  currentBranch = data.branch;
                  resolve(currentBranch);
                } else {
                  alert("‚ùå Kh√¥ng th·ªÉ x√°c ƒë·ªãnh chi nh√°nh qua GPS! B·∫°n v·∫´n c√≥ th·ªÉ ƒëi·ªÉm danh th·ªß c√¥ng.");
                  resolve(null);
                }
              } catch (err) {
                if (++retry < 3) {
                  setTimeout(tryGetGPS, 1200);
                } else {
                  alert("L·ªói l·∫•y GPS: " + err.message + ". B·∫°n v·∫´n c√≥ th·ªÉ ƒëi·ªÉm danh th·ªß c√¥ng.");
                  resolve(null);
                }
              }
            }, (err) => {
              // Hi·ªÉn th·ªã l·ªói chi ti·∫øt ƒë·ªÉ debug
              alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS: " + err.message + ". H√£y ki·ªÉm tra quy·ªÅn truy c·∫≠p v·ªã tr√≠, b·∫≠t GPS v√† th·ª≠ l·∫°i tr√™n Chrome/Safari.");
              resolve(null);
            }, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 });
          }
          tryGetGPS();
        });
      }

      /* ---------- Wiring ---------- */
      // T·∫°o popup search khi b·∫•m n√∫t
      document.getElementById("addEmployeeBtn").onclick = () => {
        const searchBox = document.createElement("div");
        searchBox.className = "fixed inset-0 bg-black/40 flex items-center justify-center z-50";
        searchBox.innerHTML = `
          <div class="bg-white p-4 rounded-xl shadow-lg w-80">
            <input id="searchInput" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-3 text-sm" placeholder="Nh·∫≠p m√£ ho·∫∑c t√™n nh√¢n vi√™n..." />
            <ul id="suggestList" class="max-h-40 overflow-y-auto divide-y divide-gray-200"></ul>
            <div class="mt-3 text-right">
              <button id="closeSearch" class="px-3 py-1 bg-gray-100 rounded-lg text-sm">ƒê√≥ng</button>
            </div>
          </div>
        `;
        document.body.appendChild(searchBox);

        const input = searchBox.querySelector("#searchInput");
        const list = searchBox.querySelector("#suggestList");

        input.oninput = async () => {
          const q = input.value.trim();
          if (!q) { list.innerHTML = ""; return; }
          try {
            const data = await safeFetchJson(searchUrl(q));
            const top5 = data.slice(0, 5); // ch·ªâ 5 k·∫øt qu·∫£
            list.innerHTML = top5.map(emp => `
              <li class="p-2 hover:bg-gray-100 cursor-pointer" data-code="${emp.code}">
                <div class="font-medium">${escapeHtml(emp.name)}</div>
                <div class="text-xs text-gray-500">${escapeHtml(emp.code)} ‚Äî ${escapeHtml(emp.department || "")}</div>
              </li>
            `).join("");
            list.querySelectorAll("li").forEach(li => {
              li.onclick = () => {
                addBySearchQuery(li.dataset.code);
                document.body.removeChild(searchBox);
              };
            });
          } catch(e) {
            console.error(e);
          }
        };

        searchBox.querySelector("#closeSearch").onclick = () => {
          document.body.removeChild(searchBox);
        };
      };

      function branchDisplay(branch) {
        const map = {
          B1: "Bin Bin Bin Hotel 1",
          B2: "Bin Bin Bin Hotel 2",
          B3: "Bin Bin Bin Hotel 3",
          B5: "Bin Bin Bin Hotel 5",
          B6: "Bin Bin Bin Hotel 6",
          B7: "Bin Bin Bin Hotel 7",
          B8: "Bin Bin Bin Hotel 8",
          B9: "Bin Bin Bin Hotel 9",
          B10: "Bin Bin Bin Hotel 10",
          B11: "Bin Bin Bin Hotel 11",
          B12: "Bin Bin Bin Hotel 12",
          B14: "Bin Bin Bin Hotel 14",
          B15: "Bin Bin Bin Hotel 15",
          B16: "Bin Bin Bin Hotel 16",
        };
        return map[branch] || branch || "";
      }

      document.getElementById("saveBtn").onclick = saveAttendance;
      document.getElementById("refreshBtn").onclick = () => loadEmployeesForBranch();

      /* ---------- Init ---------- */
      window.addEventListener("DOMContentLoaded", async () => {
        // // N·∫øu mu·ªën enforce ch·ªâ ƒëi·ªán tho·∫°i, b·ªè comment d√≤ng d∆∞·ªõi
        // if (!/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        //   alert("‚ö†Ô∏è H·ªá th·ªëng ƒëi·ªÉm danh ch·ªâ d√πng tr√™n ƒëi·ªán tho·∫°i!");
        //   window.location.href = "/login";
        //   return;
        // }

        // GPS ‚Üí branch
        const detected = await detectBranchByGPS();
        if (detected) {
          document.getElementById("branchName").textContent = branchDisplay(detected);
          await loadEmployeesForBranch();
        } else if (currentBranch && currentBranch !== "{{ branch_id }}") {
          document.getElementById("branchName").textContent = currentBranch;
          await loadEmployeesForBranch();
        } else {
          document.getElementById("branchName").textContent = "(kh√¥ng x√°c ƒë·ªãnh)";
        }
      });
    </script>
  </body>
  </html>
