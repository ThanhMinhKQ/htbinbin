<!DOCTYPE html>
<html lang="vi" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Điểm danh — Mobile (EU)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }
    /* Modal animation */
    .modal { transition: opacity 200ms ease-in-out; }
    .modal > div { transition: transform 200ms ease-in-out, opacity 200ms ease-in-out; }
    .modal.hidden { opacity: 0; pointer-events: none; }
    .modal.hidden > div { transform: translateY(1rem) scale(0.98); opacity: 0; }

    /* Gradient button animation */
    .btn-gradient {
      background-image: linear-gradient(to right, #2563eb 0%, #06b6d4 50%, #2563eb 100%);
      background-size: 200% auto;
      transition: background-position 0.3s cubic-bezier(.4,0,.2,1), transform 0.1s ease-out, box-shadow 0.2s ease;
    }
    .btn-gradient:hover {
      background-position: right center;
    }
    .btn-gradient:active { box-shadow: 0 2px 10px -2px rgba(37, 99, 235, 0.5); }
    /* Focus ring */
    .focus-ring:focus{ outline:none; box-shadow: 0 0 0 3px rgba(59,130,246,.25); border-color: #60a5fa; }
    /* Toast animation */
    /* Status Modal (Loading, Success, Error) */
    .checkmark__circle {
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      stroke-width: 2;
      stroke-miterlimit: 10;
      fill: none;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }
    .checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: block;
      stroke-width: 2;
      stroke: #fff;
      stroke-miterlimit: 10;
      margin: 10% auto;
      animation-duration: .4s, .3s; animation-timing-function: ease-in-out, ease-in-out; animation-delay: .4s, .9s; animation-fill-mode: forwards, both;
    }
    .checkmark__check {
      transform-origin: 50% 50%;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }
    @keyframes stroke { 100% { stroke-dashoffset: 0; } }
    @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
    @keyframes fill-green { 100% { box-shadow: inset 0px 0px 0px 40px #4ade80; } }
    #statusSuccess .checkmark__circle { stroke: #4ade80; } /* green-400 */
    #statusSuccess .checkmark { animation-name: fill-green, scale; }
    #statusSuccess .timer-bar-container { background-color: rgba(74, 222, 128, 0.5); }
    #statusSuccess .timer-bar-inner { background-color: #4ade80; }
    .timer-bar-inner { animation-name: shrink; animation-timing-function: linear; animation-fill-mode: forwards; }
    @keyframes shrink { from { width: 100%; } to { width: 0%; } }

    /* List item animations */
    @keyframes item-in {
      from { opacity: 0; transform: translateY(15px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .attendance-item {
      animation: item-in 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
    }
    .item-out {
      animation: item-out 0.35s ease-in-out forwards;
    }
    @keyframes item-out {
      to { opacity: 0; transform: scale(0.95); height: 0; padding-top: 0; padding-bottom: 0; margin-bottom: 0; border-width: 0; }
    }

    @media (prefers-reduced-motion: reduce){*{animation:none!important;transition:none!important}}
  </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800 antialiased">
  <div class="mx-auto max-w-lg px-4 pt-4 pb-28">
    <!-- Header -->
    <header class="flex items-center gap-3 py-2" style="padding-top: calc(var(--safe-top) + 8px)">
      <div class="grid h-11 w-11 place-items-center rounded-2xl bg-blue-600 shadow-md">
        <svg class="h-5 w-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 5v14M5 12h14"/></svg>
      </div>
      <div class="flex-1">
        <h1 class="text-lg font-bold text-slate-900">Điểm danh</h1>
        <p class="text-sm text-slate-500">Giao diện điểm danh nhân viên</p>
      </div>
    </header>

    <!-- Night Shift Notification -->
    <div id="nightShiftNotice" class="hidden mt-4 flex items-center gap-3 rounded-xl border border-yellow-200 bg-yellow-50 p-3 text-sm text-yellow-800 shadow-sm" role="alert">
      <svg class="h-5 w-5 flex-shrink-0 text-yellow-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21.64 13.5A9 9 0 1 1 11.5 3.36M22 12l-6-6"/></svg>
      <p><strong>Lưu ý:</strong> Hiện là ca đêm. Điểm danh bây giờ sẽ được ghi nhận cho ngày <strong id="workDate"></strong>.</p>
    </div>

    <!-- Branch -->
    <section class="mt-4 rounded-xl border border-slate-200 bg-white p-4 shadow-sm" role="region" aria-label="Chi nhánh">
      <div class="flex items-center gap-3">
        <div class="grid h-10 w-10 place-items-center rounded-lg bg-slate-100">
          <svg class="h-5 w-5 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 1 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
        </div>
        <div class="flex-1">
          <p class="text-xs text-slate-500">Chi nhánh làm việc</p>
          <p id="branchName" class="mt-1 font-semibold text-slate-800">(đang xác định...)</p>
        </div>
      </div>
    </section>

    <!-- Actions -->
    <div class="mt-4 grid grid-cols-2 gap-3">
      <button id="refreshBtn" class="group inline-flex items-center justify-center gap-2 rounded-xl border border-slate-300 bg-white px-3 py-2.5 text-sm font-semibold text-slate-700 shadow-sm transition-transform active:scale-[.98] focus-ring">
        <svg class="h-4 w-4 text-slate-500 transition-transform group-active:rotate-90" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 12a8 8 0 1 1-2.34-5.66"/><path d="M20 4v6h-6"/></svg>
        <span>Tải lại</span>
      </button>
      <button id="addEmployeeBtn" class="btn-gradient inline-flex items-center justify-center gap-2 rounded-xl text-white px-3 py-2.5 text-sm font-semibold shadow-md transition active:scale-[.98] focus-ring">
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 5v14M5 12h14"/></svg>
        <span>Thêm</span>
      </button>
    </div>

    <!-- List -->
    <div id="attendanceList" class="mt-4 space-y-3"></div>
    <div id="emptyHint" class="mt-6 hidden text-center text-sm text-slate-500">
      Danh sách trống. Bấm <strong>+ Thêm</strong> để bắt đầu.
    </div>
  </div>

  <!-- Bottom bar -->
  <div class="fixed bottom-0 left-0 right-0 border-t border-slate-200 bg-white/95 shadow-2xl backdrop-blur supports-[backdrop-filter]:bg-white/75">
    <div class="mx-auto max-w-lg px-4 py-3" style="padding-bottom: calc(12px + var(--safe-bottom))">
      <button id="saveBtn" class="btn-gradient w-full rounded-2xl px-4 py-3.5 text-base font-bold text-white shadow-lg transition active:scale-[.99] focus-ring">
        LƯU ĐIỂM DANH
      </button>
    </div>
  </div>

  <!-- Status Modal (Loading, Success, Error) -->
  <div id="statusModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/30 backdrop-blur-sm transition-opacity duration-200 opacity-0">
    <div id="statusModalContent" class="relative w-full max-w-xs bg-white rounded-2xl shadow-xl p-6 text-center space-y-4 overflow-hidden">
      <!-- Loading State -->
      <div id="statusLoading">
        <svg class="animate-spin mx-auto h-12 w-12 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loadingMessage" class="mt-4 text-slate-700 font-medium">Đang xử lý...</p>
      </div>
      <!-- Success State -->
      <div id="statusSuccess" class="hidden">
        <svg class="checkmark mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
          <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
          <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
        <p id="successMessage" class="mt-4 text-slate-700 font-medium">Thành công!</p>
        <div class="absolute bottom-0 left-0 right-0 h-1 timer-bar-container">
            <div class="h-full timer-bar-inner"></div>
        </div>
      </div>
      <!-- Error State -->
      <div id="statusError" class="hidden">
        <svg class="mx-auto h-16 w-16 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <p id="errorMessage" class="mt-4 text-slate-700 font-medium">Đã xảy ra lỗi!</p>
        <button onclick="hideStatusModal()" class="mt-4 w-full rounded-lg bg-slate-100 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-200">Đóng</button>
      </div>
    </div>
  </div>

  <!-- Branch chooser -->
  <div id="branchPopup" class="modal fixed inset-0 z-40 hidden flex items-center justify-center p-4 bg-black/25 backdrop-blur-sm">
    <div class="w-full max-w-md space-y-4 rounded-2xl border border-white/20 bg-white/70 p-6 shadow-lg backdrop-blur-xl">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-slate-800">Chọn chi nhánh</h3>
        <button onclick="closeModal('branchPopup')" class="rounded-full p-1 text-slate-500 transition-colors hover:bg-slate-400/20" aria-label="Đóng">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
        </button>
      </div>
      <div id="branchChoices" class="max-h-[50vh] space-y-2 overflow-y-auto"></div>
    </div>
  </div>

  <!-- Search modal -->
  <div id="searchModal" class="modal fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/25 backdrop-blur-sm">
    <div class="w-full max-w-md space-y-4 rounded-2xl border border-white/20 bg-white/70 p-6 shadow-lg backdrop-blur-xl">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-slate-800">Thêm nhân viên</h3>
        <button onclick="closeModal('searchModal')" class="rounded-full p-1 text-slate-500 transition-colors hover:bg-slate-400/20" aria-label="Đóng">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="relative">
        <input id="searchInputMain" type="text" placeholder="Nhập mã hoặc tên..." class="focus-ring w-full rounded-xl border border-slate-300 bg-white/80 px-4 py-3 text-base" />
        <svg class="absolute right-4 top-1/2 h-4 w-4 -translate-y-1/2 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="7"/><path d="M20 20l-3-3"/></svg>
      </div>
      <div id="suggestListMain" class="max-h-[50vh] space-y-2 overflow-y-auto"></div>
    </div>
  </div>

  <!-- Template variables (giữ nguyên) -->
  <script>
    const userRole = "{{ role | lower }}";
    const loginCode = "{{ login_code }}";
    const csrfToken = "{{ csrf_token }}";
    let currentBranch = "{{ branch_id }}" || "";
  </script>

  <script>
    /* ========= Endpoint backend (giữ nguyên) ========= */
    const byBranchUrl = (b) => `/attendance/api/employees/by-branch/${encodeURIComponent(b)}`;
    const searchUrl   = (q) => `/attendance/api/employees/search?q=${encodeURIComponent(q)}&loginCode=${encodeURIComponent(loginCode)}`;
    const saveUrl     = () => `/attendance/checkin_bulk`;

    /* Local state */
    let employees = [];

    /* Helpers */
    function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
    function escapeAttr(s){ return String(s||"").replaceAll('"','&quot;'); }
    function departmentDisplay(dep){ const map={ letan:"Lễ tân",buongphong:"Buồng phòng",baove:"Bảo vệ", "hỗ trợ tăng ca": "Hỗ Trợ Tăng Ca", "kỹ thuật viên": "Kỹ thuật viên" }; return map[dep?.toLowerCase()] || dep || ""; }
    function branchDisplay(branch){ const map={ B1:"Bin Bin Hotel 1", B2:"Bin Bin Hotel 2", B3:"Bin Bin Hotel 3", B5:"Bin Bin Hotel 5", B6:"Bin Bin Hotel 6", B7:"Bin Bin Hotel 7", B8:"Bin Bin Hotel 8", B9:"Bin Bin Hotel 9", B10:"Bin Bin Hotel 10", B11:"Bin Bin Hotel 11", B12:"Bin Bin Hotel 12", B14:"Bin Bin Hotel 14", B15:"Bin Bin Hotel 15", B16:"Bin Bin Hotel 16", B17:"Bin Bin Hotel 17", KTV:"Chi nhánh KTV" }; return map[branch] || branch || ""; }

    /* ===== Status Modal Logic ===== */
    function updateEmployeeOvertime(emp) {
        const isDifferentBranch = (emp.branch || "") !== (emp.branch_today || currentBranch);
        const hasHighWorkUnits = (emp.so_cong_nv || 1) > 1;
        emp.la_tang_ca = isDifferentBranch || hasHighWorkUnits;
        // Theo yêu cầu, không tự động cập nhật trường "ghi_chu".
        // Cờ 'la_tang_ca' sẽ được xác định và gửi đi là đủ.
    }
    function vibrate(duration = 5) {
      if ('vibrate' in navigator && window.navigator.vibrate) {
        try {
          window.navigator.vibrate(duration);
        } catch (e) { /* Can fail on some browsers/settings */ }
      }
    }

    const statusModal = document.getElementById('statusModal');
    const statusModalContent = document.getElementById('statusModalContent');
    const statusLoading = document.getElementById('statusLoading');
    const loadingMessage = document.getElementById('loadingMessage');
    const statusSuccess = document.getElementById('statusSuccess');
    const successMessage = document.getElementById('successMessage');
    const statusError = document.getElementById('statusError');
    const errorMessage = document.getElementById('errorMessage');
    let modalHideTimer = null;

    function hideStatusModal() {
      statusModal.classList.add('opacity-0');
      setTimeout(() => {
        statusModal.classList.add('hidden');
      }, 200); // Match transition duration
    }

    function showStatusModal(state, message = "", autoHideDuration = 0, onHidden = null) {
      if (modalHideTimer) clearTimeout(modalHideTimer);
      modalHideTimer = null;
      statusModalContent.onmouseenter = null;
      statusModalContent.onmouseleave = null;

      const checkmarkIcon = statusSuccess.querySelector('.checkmark');
      if (checkmarkIcon) {
          checkmarkIcon.classList.remove('checkmark');
          void checkmarkIcon.offsetWidth;
          checkmarkIcon.classList.add('checkmark');
      }

      const timerBar = document.querySelector('.timer-bar-inner');
      if (timerBar) {
        timerBar.style.animation = 'none';
        timerBar.offsetHeight;
      }

      statusLoading.classList.add('hidden');
      statusSuccess.classList.add('hidden');
      statusError.classList.add('hidden');

      if (state === 'loading') {
        loadingMessage.textContent = message || "Đang xử lý...";
        statusLoading.classList.remove('hidden');
      } else if (state === 'success') {
        successMessage.textContent = message || "Thành công!";
        statusSuccess.classList.remove('hidden');
        if (timerBar && autoHideDuration > 0) {
            timerBar.style.animationDuration = `${autoHideDuration / 1000}s`;
            timerBar.style.animationName = 'shrink';
        }
      } else if (state === 'error') {
        errorMessage.textContent = message || "Đã xảy ra lỗi không xác định.";
        statusError.classList.remove('hidden');
      }
      statusModal.classList.remove('hidden');
      statusModal.classList.remove('opacity-0');

      if (state === 'success' && autoHideDuration > 0) {
        let remaining = autoHideDuration;
        let resumeTime;
        const pause = () => {
          if (modalHideTimer) {
            clearTimeout(modalHideTimer);
            modalHideTimer = null;
            remaining -= (Date.now() - resumeTime);
            if (timerBar) timerBar.style.animationPlayState = 'paused';
          }
        };
        const resume = () => {
          if (remaining > 0 && !modalHideTimer) {
            resumeTime = Date.now();
            if (timerBar) timerBar.style.animationPlayState = 'running';
            modalHideTimer = setTimeout(() => { hideStatusModal(); if (onHidden) onHidden(); }, remaining);
          }
        };
        statusModalContent.onmouseenter = pause;
        statusModalContent.onmouseleave = resume;
        resume();
      }
    };

    function disableForm(message){
      showStatusModal('error', message || "Không thể điểm danh");
      ["saveBtn","addEmployeeBtn","refreshBtn"].forEach(id=>{
        const el=document.getElementById(id); if(!el) return;
        el.disabled=true; el.classList.add("opacity-50", "cursor-not-allowed");
      });
      employees=[]; renderAttendanceList();
    }

    async function safeFetchJson(url, options){
      const res = await fetch(url, options);
      if (!res.ok){
        let msg = `Lỗi kết nối server (mã ${res.status})`;
        try{ const data = await res.json(); if (data && data.error) msg = data.error; }catch(e){}
        throw new Error(msg);
      }
      const ct = res.headers.get("content-type") || "";
      return ct.includes("application/json") ? res.json() : res.text();
    }

    /* ===== Modal Handlers ===== */
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('hidden');
        const input = modal.querySelector('input[type="text"]');
        if (input) setTimeout(() => input.focus(), 50);
      }
    }
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.classList.add('hidden');
    }
    ['searchModal', 'branchPopup'].forEach(id => {
      const modal = document.getElementById(id);
      if(modal) modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(id); });
    });
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal('searchModal');
        closeModal('branchPopup');
      }
    });

    /* ===== Render list ===== */
    function renderSkeleton(count = 3) {
      const wrap = document.getElementById("attendanceList");
      wrap.innerHTML = "";
      let skeletonHTML = '';
      for (let i = 0; i < count; i++) {
          skeletonHTML += `
          <div class="space-y-4 rounded-xl border border-slate-200/80 bg-white p-4 shadow-sm animate-pulse">
            <div class="flex items-start gap-3">
              <div class="flex-1 space-y-2 py-1">
                <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                <div class="h-3 bg-slate-200 rounded w-1/2"></div>
              </div>
              <div class="h-8 w-8 bg-slate-200 rounded-full"></div>
            </div>
            <div class="h-10 bg-slate-200 rounded-lg mt-1"></div>
            <div class="h-10 bg-slate-200 rounded-lg"></div>
          </div>`;
      }
      wrap.innerHTML = skeletonHTML;
    }

    function renderAttendanceList(){
      const wrap = document.getElementById("attendanceList");
      wrap.innerHTML = "";
      document.getElementById("emptyHint").style.display = employees.length > 0 ? "none" : "block";

      employees.forEach((emp, idx) => {
        const row = document.createElement("div");
        row.className = "attendance-item space-y-4 rounded-xl border border-slate-200/80 bg-white p-4 shadow-sm";
        row.style.animationDelay = `${Math.min(idx * 50, 500)}ms`;

        // Tùy chọn số công theo department
        let optionsHtml = "";
        if (emp.department?.toLowerCase() === "letan") {
          optionsHtml = `
            <option value="0.5" ${emp.so_cong_nv === 0.5 ? "selected" : ""}>0.5</option>
            <option value="1" ${!emp.so_cong_nv || emp.so_cong_nv === 1 ? "selected" : ""}>1</option>
          `;
        } else {
          optionsHtml = `
            <option value="0.5" ${emp.so_cong_nv === 0.5 ? "selected" : ""}>0.5</option>
            <option value="1" ${!emp.so_cong_nv || emp.so_cong_nv === 1 ? "selected" : ""}>1</option>
            <option value="1.5" ${emp.so_cong_nv === 1.5 ? "selected" : ""}>1.5</option>
            <option value="2" ${emp.so_cong_nv === 2 ? "selected" : ""}>2</option>
            <option value="2.5" ${emp.so_cong_nv === 2.5 ? "selected" : ""}>2.5</option>
          `;
        }

        row.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="flex-1">
              <p class="font-semibold text-slate-800">${escapeHtml(emp.name)}</p>
              <p class="mt-1 text-sm text-slate-500">
                Mã: ${escapeHtml(emp.code)} &bull; ${escapeHtml(departmentDisplay(emp.department))}
                <span class="badge-container" style="display: inline;">
                  ${emp.la_tang_ca ? '<span class="ml-2 rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-600">Tăng ca</span>' : ''}
                </span>
              </p>
            </div>
            <button data-code="${escapeAttr(emp.code)}" class="btn-delete rounded-full p-1.5 text-slate-400 transition-colors hover:bg-red-100 hover:text-red-500" aria-label="Xóa">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="grid grid-cols-2 gap-x-4 gap-y-3">
            <div>
              <label class="text-xs text-slate-500">Số công</label>
              <select data-code="${escapeAttr(emp.code)}" data-field="so_cong_nv"
                class="focus-ring mt-1 w-full rounded-lg border border-slate-300 bg-white px-2.5 py-1.5 text-base">
                ${optionsHtml}
              </select>
            </div>
            <div class="col-span-2">
              <label class="text-xs text-slate-500">Ghi chú</label>
              <input data-code="${escapeAttr(emp.code)}" data-field="ghi_chu"
                value="${escapeAttr(emp.ghi_chu || '')}" placeholder="Nhập ghi chú..."
                class="focus-ring mt-1 w-full rounded-lg border border-slate-300 px-2.5 py-1.5 text-base">
            </div>
          </div>
        `;

        row.querySelector('.btn-delete').onclick = (e) => {
            vibrate(10);
            const codeToDelete = e.currentTarget.dataset.code;
            const rowElement = e.currentTarget.closest('.attendance-item');

            // Immediately find and remove from the data array
            const indexToDelete = employees.findIndex(emp => emp.code === codeToDelete);
            if (indexToDelete === -1) return; // Already deleted, do nothing
            employees.splice(indexToDelete, 1);

            // Animate the row out, then remove it from the DOM
            rowElement.classList.add('item-out');
            rowElement.addEventListener('animationend', () => {
                rowElement.remove();
                // Update empty hint visibility if needed
                document.getElementById("emptyHint").style.display = employees.length > 0 ? "none" : "block";
            }, { once: true });
        };

        row.querySelector('select').onchange = (e) => {
            const code = e.currentTarget.dataset.code;
            const emp = employees.find(emp => emp.code === code);
            if (!emp) return;
            emp.so_cong_nv = parseFloat(e.target.value);

            updateEmployeeOvertime(emp);

            const itemElement = e.currentTarget.closest('.attendance-item');
            const badgeContainer = itemElement.querySelector('.badge-container');
            badgeContainer.innerHTML = emp.la_tang_ca ? '<span class="ml-2 rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-600">Tăng ca</span>' : '';
        };
        row.querySelector('input').oninput = (e) => {
            const code = e.currentTarget.dataset.code;
            const emp = employees.find(emp => emp.code === code);
            if (!emp) return;
            emp.ghi_chu = e.target.value.slice(0,200);
        };

        wrap.appendChild(row);
      });
    }

    /* ===== Data load by branch ===== */
    async function loadEmployeesForBranch(){
      if(!currentBranch){ showStatusModal("error", "Chi nhánh chưa được xác định."); return; }
      renderSkeleton(3);
      try{
        const data = await safeFetchJson(byBranchUrl(currentBranch));
        if (!Array.isArray(data)) throw new Error("API trả về không phải mảng");
        employees = data.map(emp => {
            const newEmp = {
                code: emp.code||"", name: emp.name||"", department: emp.department||"", branch: emp.branch||"",
                branch_today: currentBranch, so_cong_nv: 1, service:[], ghi_chu: ""
            };
            updateEmployeeOvertime(newEmp);
            return newEmp;
        });

        if (loginCode && !employees.some(e => e.code === loginCode)){
          try{
            const searchData = await safeFetchJson(searchUrl(loginCode));
            if (Array.isArray(searchData) && searchData.length>0){
              const s = searchData[0];
              const newEmp = { code: s.code, name: s.name, department: s.department, branch: s.branch, branch_today: currentBranch, so_cong_nv: 1, service:[], ghi_chu: "" };
              updateEmployeeOvertime(newEmp);
              employees.unshift(newEmp);
            }
          }catch(e){}
        }
        renderAttendanceList();
      }catch(err){
        showStatusModal('error', "Lỗi khi tải danh sách: " + (err?.message || err));
      }
    }

    /* ===== Search & add ===== */
    async function addBySearchQuery(q){
      if(!q) return;
      try{
        const data = await safeFetchJson(searchUrl(q));
        if (!Array.isArray(data) || data.length === 0){ showStatusModal('error', "Không tìm thấy nhân viên"); return; }
        const emp = data[0];
        const exists = employees.some(e => e.code === emp.code);
        if (exists){ showStatusModal('error', "Nhân viên đã có trong danh sách"); return; }
        const newEmp = {
            code: emp.code, name: emp.name, department: emp.department, branch: emp.branch,
            branch_today: currentBranch, so_cong_nv: 1, service:[], ghi_chu: ""
        };
        updateEmployeeOvertime(newEmp);
        employees.unshift(newEmp);
        renderAttendanceList();
        closeModal('searchModal');
      }catch(err){
        showStatusModal('error', "Lỗi tìm kiếm: " + (err?.message || err));
      }
    }

    /* ===== Save attendance (giữ nguyên payload/endpoint) ===== */
    async function saveAttendance(){
      vibrate();
      if (employees.length === 0){ showStatusModal('error', "Danh sách trống, không có gì để lưu."); return; }
      showStatusModal('loading', 'Đang lưu dữ liệu...');
      const payload = employees.map(emp => ({
        sheet:(function(code){
          if(!code) return "Khac";
          if (code.includes("BPTC")||code.includes("LTTC")) return "TC";
          if (code.includes("BP")) return "BP";
          if (code.includes("LT")) return "LT";
          if (code.includes("BV")) return "BV";
          if (code.includes("QL")) return "QL";
          if (code==="KTV") return "KTV";
          return "Khac";
        })(emp.code),
        thoi_gian:"", ma_nv:emp.code, ten_nv:emp.name,
        chi_nhanh_chinh:emp.branch, chi_nhanh_lam: emp.branch_today||currentBranch,
        la_tang_ca:!!emp.la_tang_ca, so_cong_nv:emp.so_cong_nv,
        ghi_chu:(emp.ghi_chu||"").slice(0,200), nguoi_diem_danh: loginCode
      }));

      try{
        const res = await fetch(saveUrl(), { // Gọi đến /attendance/checkin_bulk
          method:"POST",
          headers:{ "Content-Type":"application/json", "X-CSRF-Token": csrfToken },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
            let errorMsg = `Lỗi server: ${res.status}`;
            try {
                const errData = await res.json();
                if (errData && errData.detail) errorMsg = errData.detail;
            } catch(e) {}
            throw new Error(errorMsg);
        }
        const doc = await res.json().catch(()=>null);

        // Luồng 1 (Ưu tiên): Backend yêu cầu chuyển hướng (dành cho đăng nhập mobile)
        if (doc && doc.redirect_to) {
          window.location.replace(doc.redirect_to);
          return; // Dừng xử lý tại đây
        }

        // Luồng 2: Xử lý các trường hợp còn lại (điểm danh thường, hoặc quét QR)
        if (doc && doc.status === 'queued') {
          const token = new URLSearchParams(window.location.search).get("token");
          if (token) {
            // Đây là luồng quét QR từ desktop, cần gọi checkin_success để hoàn tất đăng nhập cho desktop
            const checkinPayload = { token };
            const checkinRes = await fetch("/attendance/checkin_success", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(checkinPayload)
            });
            const data = await checkinRes.json();
            if (data && data.success && data.redirect_to) {
              window.location.replace(data.redirect_to);
              return;
            }
            const errorMsg = data && data.error ? data.error : "Lỗi không xác định";
            showStatusModal('error', "Điểm danh thất bại: " + errorMsg);
          } else {
            // Đây là luồng điểm danh thông thường (không phải đăng nhập)
            showStatusModal('success', 'Lưu điểm danh thành công!', 2000, () => {
                employees = []; // Xóa danh sách sau khi lưu
                renderAttendanceList();
            });
          }
        } else {
          showStatusModal('error', "Lưu xong nhưng server trả về không chuẩn.");
        }
      }catch(err){
        showStatusModal('error', "Lỗi khi lưu điểm danh: " + (err?.message || err));
      }
    }

    /* ===== Branch detect (giữ logic cũ) ===== */
    async function detectBranchByGPS(){
      return new Promise((resolve)=>{
        if (!navigator.geolocation){ disableForm("Trình duyệt không hỗ trợ GPS."); return resolve(null); }
        navigator.geolocation.getCurrentPosition(async (pos)=>{
          try{
            const data = await safeFetchJson("/attendance/api/detect-branch", {
              method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ lat:pos.coords.latitude, lng:pos.coords.longitude })
            });
            if (data && data.error){ disableForm(data.error); return resolve(null); }
            if (data && data.choices){ showBranchSelectionPopup(data.choices); return resolve(null); }
            if (data && data.branch){
              currentBranch = data.branch;
              document.getElementById("branchName").textContent = branchDisplay(currentBranch);
              return resolve(currentBranch);
            }
            disableForm("Không thể xác định chi nhánh từ GPS."); resolve(null);
          }catch(err){ disableForm(err?.message || "Lỗi kết nối server."); resolve(null); }
        }, (err)=>{
          let message = "Không thể lấy vị trí GPS.";
          if (err.code === 1) message = "Bạn đã từ chối quyền truy cập vị trí.";
          disableForm(message); resolve(null);
        }, { enableHighAccuracy:true, timeout:12000, maximumAge:0 });
      });
    }

    /* ===== Branch popup ===== */
    function showBranchSelectionPopup(choices){
      const container = document.getElementById("branchChoices");
      container.innerHTML = "";
      choices.forEach(ch=>{
        const btn=document.createElement("button");
        btn.className = "w-full text-left rounded-lg border border-slate-300 bg-white p-3 text-sm font-semibold transition-colors hover:bg-slate-100 focus-ring";
        btn.innerHTML = `${branchDisplay(ch.branch)} <span class="font-normal text-slate-500">— ${Math.round(ch.distance_km*1000)} m</span>`;
        btn.onclick = async ()=>{
          currentBranch = ch.branch;
          document.getElementById("branchName").textContent = branchDisplay(currentBranch);
          try{
            await safeFetchJson("/attendance/api/select-branch", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ branch: ch.branch }) });
            closeModal('branchPopup'); await loadEmployeesForBranch();
          }catch(err){ showStatusModal('error', "Lỗi chọn chi nhánh: " + (err?.message || err)); }
        };
        container.appendChild(btn);
      });
      openModal('branchPopup');
    }

    /* ===== Search wiring ===== */
    document.getElementById("addEmployeeBtn").addEventListener("click", (e) => {
      vibrate();
      openModal('searchModal');
      document.getElementById("searchInputMain").value="";
      document.getElementById("suggestListMain").innerHTML="";
    });

    let searchTimer=null;
    document.getElementById("searchInputMain").addEventListener("input",(e)=>{
      const q=e.target.value.trim(); const list=document.getElementById("suggestListMain");
      clearTimeout(searchTimer);
      if (!q){ list.innerHTML=""; return; }
      searchTimer=setTimeout(async ()=>{
        try{
          const data = await safeFetchJson(searchUrl(q));
          const top = Array.isArray(data) ? data.slice(0,6) : [];
          list.innerHTML = top.map(emp=>`
            <div class="cursor-pointer rounded-lg p-3 transition-colors hover:bg-slate-400/20" data-code="${emp.code}">
              <p class="font-semibold text-slate-800">${escapeHtml(emp.name)}</p>
              <p class="mt-1 text-sm text-slate-500">${escapeHtml(emp.code)} &bull; ${escapeHtml(emp.department||"")}</p>
            </div>`).join("");
          list.querySelectorAll("div[data-code]").forEach(li=>{
            li.onclick = ()=>{ addBySearchQuery(li.dataset.code); };
          });
        }catch(err){ showStatusModal('error', "Lỗi tìm kiếm: " + (err?.message || err)); }
      }, 300);
    });

    /* ===== Buttons ===== */
    document.getElementById("saveBtn").addEventListener("click", (e) => { vibrate(); saveAttendance(); });
    document.getElementById("refreshBtn").addEventListener("click", (e) => {
      vibrate();
      loadEmployeesForBranch();
    });

    /* ===== Init ===== */
    window.addEventListener("DOMContentLoaded", async ()=>{
      // Hiển thị cảnh báo ca đêm nếu điểm danh trước 7h sáng
      const now = new Date();
      const currentHour = now.getHours();

      if (currentHour < 7) {
        const yesterday = new Date(now);
        yesterday.setDate(now.getDate() - 1);
        const day = String(yesterday.getDate()).padStart(2, '0');
        const month = String(yesterday.getMonth() + 1).padStart(2, '0');
        const year = yesterday.getFullYear();
        const workDateStr = `${day}/${month}/${year}`;

        document.getElementById('workDate').textContent = workDateStr;
        document.getElementById('nightShiftNotice').classList.remove('hidden');
      }

      renderSkeleton(4);
      const role = (userRole||"").toLowerCase();
      if (["quanly","ktv","boss","admin"].includes(role)){
        try{
          const data = await safeFetchJson("/attendance/api/detect-branch", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({}) });
          if (data && data.branch){
            currentBranch = data.branch;
            document.getElementById("branchName").textContent = branchDisplay(currentBranch);
            await loadEmployeesForBranch();
          }else{
            disableForm("Không tìm thấy chi nhánh chính cho tài khoản.");
          }
        }catch(err){ disableForm("Không thể lấy chi nhánh chính."); }
        return;
      }
      const detected = await detectBranchByGPS();
      if (detected){
        await loadEmployeesForBranch();
      }
    });
  </script>
</body>
</html>
