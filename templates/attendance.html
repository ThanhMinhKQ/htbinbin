<!DOCTYPE html>
<html lang="vi" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Điểm danh — Mobile (EU)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }
    /* Modal animation */
    .modal { transition: opacity 200ms ease-in-out; }
    .modal > div { transition: transform 200ms ease-in-out, opacity 200ms ease-in-out; }
    .modal.hidden { opacity: 0; pointer-events: none; }
    .modal.hidden > div { transform: translateY(1rem) scale(0.98); opacity: 0; }

    /* Gradient button animation */
    .btn-gradient {
      background-image: linear-gradient(to right, #2563eb 0%, #06b6d4 50%, #2563eb 100%);
      background-size: 200% auto;
      transition: background-position 0.3s cubic-bezier(.4,0,.2,1);
    }
    .btn-gradient:hover {
      background-position: right center;
    }
    /* Focus ring */
    .focus-ring:focus{ outline:none; box-shadow: 0 0 0 3px rgba(59,130,246,.25); border-color: #60a5fa; }
    /* Toast animation */
    .animate-toastIn { animation: toastIn 0.3s cubic-bezier(0.22, 1, 0.36, 1) both; }
    @keyframes toastIn { from { transform: translateY(100%) scale(0.9); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

    @media (prefers-reduced-motion: reduce){*{animation:none!important;transition:none!important}}
  </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800 antialiased">
  <div class="mx-auto max-w-lg px-4 pt-4 pb-28">
    <!-- Header -->
    <header class="flex items-center gap-3 py-2" style="padding-top: calc(var(--safe-top) + 8px)">
      <div class="grid h-11 w-11 place-items-center rounded-2xl bg-blue-600 shadow-md">
        <svg class="h-5 w-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 5v14M5 12h14"/></svg>
      </div>
      <div class="flex-1">
        <h1 class="text-lg font-bold text-slate-900">Điểm danh</h1>
        <p class="text-sm text-slate-500">Giao diện điểm danh nhân viên</p>
      </div>
    </header>

    <!-- Branch -->
    <section class="mt-4 rounded-xl border border-slate-200 bg-white p-4 shadow-sm" role="region" aria-label="Chi nhánh">
      <div class="flex items-center gap-3">
        <div class="grid h-10 w-10 place-items-center rounded-lg bg-slate-100">
          <svg class="h-5 w-5 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 1 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
        </div>
        <div class="flex-1">
          <p class="text-xs text-slate-500">Chi nhánh làm việc</p>
          <p id="branchName" class="mt-1 font-semibold text-slate-800">(đang xác định...)</p>
        </div>
      </div>
    </section>

    <!-- Actions -->
    <div class="mt-4 grid grid-cols-2 gap-3">
      <button id="refreshBtn" class="group inline-flex items-center justify-center gap-2 rounded-xl border border-slate-300 bg-white px-3 py-2.5 text-sm font-semibold text-slate-700 shadow-sm transition active:scale-[.98] focus-ring">
        <svg class="h-4 w-4 text-slate-500 transition-transform group-active:rotate-90" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 12a8 8 0 1 1-2.34-5.66"/><path d="M20 4v6h-6"/></svg>
        <span>Tải lại</span>
      </button>
      <button id="addEmployeeBtn" class="btn-gradient inline-flex items-center justify-center gap-2 rounded-xl text-white px-3 py-2.5 text-sm font-semibold shadow-md transition active:scale-[.98] focus-ring">
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 5v14M5 12h14"/></svg>
        <span>Thêm</span>
      </button>
    </div>

    <!-- List -->
    <div id="attendanceList" class="mt-4 space-y-3"></div>
    <div id="emptyHint" class="mt-6 hidden text-center text-sm text-slate-500">
      Danh sách trống. Bấm <strong>+ Thêm</strong> để bắt đầu.
    </div>
  </div>

  <!-- Bottom bar -->
  <div class="fixed bottom-0 left-0 right-0 border-t border-slate-200 bg-white/95 shadow-2xl backdrop-blur supports-[backdrop-filter]:bg-white/75">
    <div class="mx-auto max-w-lg px-4 py-3" style="padding-bottom: calc(12px + var(--safe-bottom))">
      <button id="saveBtn" class="btn-gradient w-full rounded-2xl px-4 py-3.5 text-base font-bold text-white shadow-lg transition active:scale-[.99] focus-ring">
        LƯU ĐIỂM DANH
      </button>
    </div>
  </div>

  <!-- Overlay loading -->
  <div id="loadingOverlay" class="fixed inset-0 z-[999] hidden flex items-center justify-center bg-black/40 backdrop-blur-sm">
    <div class="flex flex-col items-center gap-4 rounded-2xl bg-white/90 px-6 py-8 shadow-xl">
      <svg class="h-10 w-10 animate-spin text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.37 0 0 5.37 0 12h4zm2 5.29A7.96 7.96 0 014 12H0c0 3.04 1.13 5.82 3 7.94l3-2.65z"></path>
      </svg>
      <p class="text-base font-semibold text-slate-700">Đang lưu dữ liệu...</p>
    </div>
  </div>

  <!-- Branch chooser -->
  <div id="branchPopup" class="modal fixed inset-0 z-40 hidden flex items-center justify-center p-4 bg-black/25 backdrop-blur-sm">
    <div class="w-full max-w-md space-y-4 rounded-2xl border border-white/20 bg-white/70 p-6 shadow-lg backdrop-blur-xl">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-slate-800">Chọn chi nhánh</h3>
        <button onclick="closeModal('branchPopup')" class="rounded-full p-1 text-slate-500 transition-colors hover:bg-slate-400/20" aria-label="Đóng">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
        </button>
      </div>
      <div id="branchChoices" class="max-h-[50vh] space-y-2 overflow-y-auto"></div>
    </div>
  </div>

  <!-- Search modal -->
  <div id="searchModal" class="modal fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/25 backdrop-blur-sm">
    <div class="w-full max-w-md space-y-4 rounded-2xl border border-white/20 bg-white/70 p-6 shadow-lg backdrop-blur-xl">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-slate-800">Thêm nhân viên</h3>
        <button onclick="closeModal('searchModal')" class="rounded-full p-1 text-slate-500 transition-colors hover:bg-slate-400/20" aria-label="Đóng">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="relative">
        <input id="searchInputMain" type="text" placeholder="Nhập mã hoặc tên..." class="focus-ring w-full rounded-xl border border-slate-300 bg-white/80 px-4 py-3 text-base" />
        <svg class="absolute right-4 top-1/2 h-4 w-4 -translate-y-1/2 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="7"/><path d="M20 20l-3-3"/></svg>
      </div>
      <div id="suggestListMain" class="max-h-[50vh] space-y-2 overflow-y-auto"></div>
    </div>
  </div>

  <!-- Lightweight toast container -->
  <div id="toastHost" class="fixed top-[calc(16px+var(--safe-top))] right-4 z-50 space-y-2"></div>

  <!-- Template variables (giữ nguyên) -->
  <script>
    const userRole = "{{ role | lower }}";
    const loginCode = "{{ login_code }}";
    const csrfToken = "{{ csrf_token }}";
    let currentBranch = "{{ branch_id }}" || "";
  </script>

  <script>
    /* ========= Endpoint backend (giữ nguyên) ========= */
    const byBranchUrl = (b) => `/attendance/api/employees/by-branch/${encodeURIComponent(b)}`;
    const searchUrl   = (q) => `/attendance/api/employees/search?q=${encodeURIComponent(q)}&loginCode=${encodeURIComponent(loginCode)}`;
    const saveUrl     = () => `/attendance/checkin_bulk`;

    /* Local state */
    let employees = [];

    /* Helpers */
    function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
    function escapeAttr(s){ return String(s||"").replaceAll('"','&quot;'); }
    function departmentDisplay(dep){ const map={ letan:"Lễ tân",buongphong:"Buồng phòng",baove:"Bảo vệ" }; return map[dep?.toLowerCase()] || dep || ""; }
    function branchDisplay(branch){ const map={ B1:"Bin Bin Hotel 1", B2:"Bin Bin Hotel 2", B3:"Bin Bin Hotel 3", B5:"Bin Bin Hotel 5", B6:"Bin Bin Hotel 6", B7:"Bin Bin Hotel 7", B8:"Bin Bin Hotel 8", B9:"Bin Bin Hotel 9", B10:"Bin Bin Hotel 10", B11:"Bin Bin Hotel 11", B12:"Bin Bin Hotel 12", B14:"Bin Bin Hotel 14", B15:"Bin Bin Hotel 15", B16:"Bin Bin Hotel 16" }; return map[branch] || branch || ""; }

    const toastHost = document.getElementById("toastHost");
    const toast = (msg, type='info') => {
        const icon = { success: '✓', info: 'ℹ', error: '✕' }[type];
        const colors = { success: 'bg-green-600', info: 'bg-blue-600', error: 'bg-red-600' }[type];
        const base = document.createElement("div");
        base.className = `animate-toastIn ${colors} text-white text-sm font-medium rounded-full shadow-lg px-4 py-2`;
        base.textContent = `${icon} ${msg}`;
        toastHost.appendChild(base);
        setTimeout(()=> base.remove(), 2500);
    };

    const loadingOverlay = document.getElementById("loadingOverlay");
    function showOverlay(){ if(loadingOverlay) loadingOverlay.classList.remove("hidden"); }
    function hideOverlay(){ if(loadingOverlay) loadingOverlay.classList.add("hidden"); }

    function disableForm(message){
      toast(message || "Không thể điểm danh", 'error');
      ["saveBtn","addEmployeeBtn","refreshBtn"].forEach(id=>{
        const el=document.getElementById(id); if(!el) return;
        el.disabled=true; el.classList.add("opacity-50", "cursor-not-allowed");
      });
      employees=[]; renderAttendanceList();
    }

    async function safeFetchJson(url, options){
      const res = await fetch(url, options);
      if (!res.ok){
        let msg = `Lỗi kết nối server (mã ${res.status})`;
        try{ const data = await res.json(); if (data && data.error) msg = data.error; }catch(e){}
        throw new Error(msg);
      }
      const ct = res.headers.get("content-type") || "";
      return ct.includes("application/json") ? res.json() : res.text();
    }

    /* ===== Modal Handlers ===== */
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('hidden');
        const input = modal.querySelector('input[type="text"]');
        if (input) setTimeout(() => input.focus(), 50);
      }
    }
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.classList.add('hidden');
    }
    ['searchModal', 'branchPopup'].forEach(id => {
      const modal = document.getElementById(id);
      if(modal) modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(id); });
    });
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal('searchModal');
        closeModal('branchPopup');
      }
    });

    /* ===== Render list ===== */
    function renderAttendanceList(){
      const wrap = document.getElementById("attendanceList");
      wrap.innerHTML = "";
      document.getElementById("emptyHint").style.display = employees.length > 0 ? "none" : "block";

      employees.forEach((emp, idx) => {
        emp.la_tang_ca = !!((emp.branch_today || currentBranch) !== (emp.branch || ""));

        const row = document.createElement("div");
        row.className = "space-y-4 rounded-xl border border-slate-200/80 bg-white p-4 shadow-sm";
        row.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="flex-1">
              <p class="font-semibold text-slate-800">${escapeHtml(emp.name)}</p>
              <p class="mt-1 text-sm text-slate-500">
                Mã: ${escapeHtml(emp.code)} &bull; ${escapeHtml(departmentDisplay(emp.department))}
                ${emp.la_tang_ca ? '<span class="ml-2 rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-600">Tăng ca</span>' : ''}
              </p>
            </div>
            <button data-idx="${idx}" class="btn-delete rounded-full p-1.5 text-slate-400 transition-colors hover:bg-red-100 hover:text-red-500" aria-label="Xóa">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="grid grid-cols-2 gap-x-4 gap-y-3">
            <div>
              <label class="text-xs text-slate-500">Số công</label>
              <select data-idx="${idx}" data-field="so_cong_nv" class="focus-ring mt-1 w-full rounded-lg border border-slate-300 bg-white px-2.5 py-1.5 text-base">
                <option value="0.5" ${emp.so_cong_nv === 0.5 ? "selected" : ""}>0.5</option>
                <option value="1" ${!emp.so_cong_nv || emp.so_cong_nv === 1 ? "selected" : ""}>1</option>
                <option value="1.5" ${emp.so_cong_nv === 1.5 ? "selected" : ""}>1.5</option>
                <option value="2" ${emp.so_cong_nv === 2 ? "selected" : ""}>2</option>
                <option value="2.5" ${emp.so_cong_nv === 2.5 ? "selected" : ""}>2.5</option>
              </select>
            </div>
            <div class="col-span-2">
              <label class="text-xs text-slate-500">Ghi chú</label>
              <input data-idx="${idx}" data-field="ghi_chu" value="${escapeAttr(emp.ghi_chu || '')}" placeholder="Nhập ghi chú..." class="focus-ring mt-1 w-full rounded-lg border border-slate-300 px-2.5 py-1.5 text-base">
            </div>
          </div>
        `;

        row.querySelector('.btn-delete').onclick = (e) => {
            employees.splice(e.currentTarget.dataset.idx, 1);
            renderAttendanceList();
        };
        row.querySelector('select').onchange = (e) => { employees[e.currentTarget.dataset.idx].so_cong_nv = parseFloat(e.target.value); };
        row.querySelector('input').oninput = (e) => { employees[e.currentTarget.dataset.idx].ghi_chu = e.target.value.slice(0,200); };

        wrap.appendChild(row);
      });
    }

    /* ===== Data load by branch ===== */
    async function loadEmployeesForBranch(){
      if(!currentBranch){ toast("Chi nhánh chưa được xác định.", 'error'); return; }
      try{
        const data = await safeFetchJson(byBranchUrl(currentBranch));
        if (!Array.isArray(data)) throw new Error("API trả về không phải mảng");
        employees = data.map(emp => ({
          code: emp.code||"", name: emp.name||"", department: emp.department||"", branch: emp.branch||"",
          branch_today: currentBranch, la_tang_ca:false, so_cong_nv:1, service:[], ghi_chu:""
        }));

        if (loginCode && !employees.some(e => e.code === loginCode)){
          try{
            const searchData = await safeFetchJson(searchUrl(loginCode));
            if (Array.isArray(searchData) && searchData.length>0){
              const s = searchData[0];
              employees.unshift({ code:s.code, name:s.name, department:s.department, branch:s.branch, branch_today:currentBranch, la_tang_ca:false, so_cong_nv:1, service:[], ghi_chu:"" });
            }
          }catch(e){}
        }
        renderAttendanceList();
      }catch(err){
        toast("Lỗi khi tải danh sách: " + (err?.message || err), 'error');
      }
    }

    /* ===== Search & add ===== */
    async function addBySearchQuery(q){
      if(!q) return;
      try{
        const data = await safeFetchJson(searchUrl(q));
        if (!Array.isArray(data) || data.length === 0){ toast("Không tìm thấy nhân viên", 'info'); return; }
        const emp = data[0];
        const exists = employees.some(e => e.code === emp.code && e.branch_today === currentBranch);
        if (exists){ toast("Nhân viên đã có trong danh sách", 'info'); return; }
        employees.unshift({
          code:emp.code, name:emp.name, department:emp.department, branch:emp.branch,
          branch_today:currentBranch, la_tang_ca:(emp.branch !== currentBranch), so_cong_nv:1, service:[], ghi_chu:"Tăng ca"
        });
        renderAttendanceList();
        closeModal('searchModal');
      }catch(err){
        toast("Lỗi tìm kiếm: " + (err?.message || err), 'error');
      }
    }

    /* ===== Save attendance (giữ nguyên payload/endpoint) ===== */
    async function saveAttendance(){
      if (employees.length === 0){ toast("Danh sách trống, không có gì để lưu.", 'info'); return; }
      showOverlay();
      const payload = employees.map(emp => ({
        sheet:(function(code){
          if(!code) return "Khac";
          if (code.includes("BPTC")||code.includes("LTTC")) return "TC";
          if (code.includes("BP")) return "BP";
          if (code.includes("LT")) return "LT";
          if (code.includes("BV")) return "BV";
          if (code.includes("QL")) return "QL";
          if (code==="KTV") return "KTV";
          return "Khac";
        })(emp.code),
        thoi_gian:"", ma_nv:emp.code, ten_nv:emp.name,
        chi_nhanh_chinh:emp.branch, chi_nhanh_lam: emp.branch_today||currentBranch,
        la_tang_ca:!!emp.la_tang_ca, so_cong_nv:emp.so_cong_nv,
        ghi_chu:(emp.ghi_chu||"").slice(0,200), nguoi_diem_danh: loginCode
      }));

      try{
        const res = await fetch(saveUrl(), {
          method:"POST",
          headers:{ "Content-Type":"application/json", "X-CSRF-Token": csrfToken },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(`Lỗi server: ${res.status}`);
        const doc = await res.json().catch(()=>null);
        if (doc && doc.status === 'queued') {
          // Bỏ toast và hợp nhất logic gọi checkin_success cho cả mobile & desktop
          const token = new URLSearchParams(window.location.search).get("token");
          const checkinPayload = token ? { token } : {};
          const checkinRes = await fetch("/attendance/checkin_success", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(checkinPayload)
          });
          const data = await checkinRes.json();
          if (data && data.success && data.redirect_to) {
            window.location.replace(data.redirect_to);
            return; // Ngăn khối finally chạy trước khi chuyển hướng
          }
          const errorMsg = data && data.error ? data.error : "Lỗi không xác định";
          toast("Điểm danh thất bại: " + errorMsg, 'error');
        } else {
          toast("Lưu xong nhưng server trả về không chuẩn.", 'error');
        }
      }catch(err){
        toast("Lỗi khi lưu điểm danh: " + (err?.message || err), 'error');
      } finally {
        hideOverlay();
      }
    }

    /* ===== Branch detect (giữ logic cũ) ===== */
    async function detectBranchByGPS(){
      return new Promise((resolve)=>{
        if (!navigator.geolocation){ disableForm("Trình duyệt không hỗ trợ GPS."); return resolve(null); }
        navigator.geolocation.getCurrentPosition(async (pos)=>{
          try{
            const data = await safeFetchJson("/attendance/api/detect-branch", {
              method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ lat:pos.coords.latitude, lng:pos.coords.longitude })
            });
            if (data && data.error){ disableForm(data.error); return resolve(null); }
            if (data && data.choices){ showBranchSelectionPopup(data.choices); return resolve(null); }
            if (data && data.branch){
              currentBranch = data.branch;
              document.getElementById("branchName").textContent = branchDisplay(currentBranch);
              return resolve(currentBranch);
            }
            disableForm("Không thể xác định chi nhánh từ GPS."); resolve(null);
          }catch(err){ disableForm(err?.message || "Lỗi kết nối server."); resolve(null); }
        }, (err)=>{
          let message = "Không thể lấy vị trí GPS.";
          if (err.code === 1) message = "Bạn đã từ chối quyền truy cập vị trí.";
          disableForm(message); resolve(null);
        }, { enableHighAccuracy:true, timeout:12000, maximumAge:0 });
      });
    }

    /* ===== Branch popup ===== */
    function showBranchSelectionPopup(choices){
      const container = document.getElementById("branchChoices");
      container.innerHTML = "";
      choices.forEach(ch=>{
        const btn=document.createElement("button");
        btn.className = "w-full text-left rounded-lg border border-slate-300 bg-white p-3 text-sm font-semibold transition-colors hover:bg-slate-100 focus-ring";
        btn.innerHTML = `${branchDisplay(ch.branch)} <span class="font-normal text-slate-500">— ${Math.round(ch.distance_km*1000)} m</span>`;
        btn.onclick = async ()=>{
          currentBranch = ch.branch;
          document.getElementById("branchName").textContent = branchDisplay(currentBranch);
          try{
            await safeFetchJson("/attendance/api/select-branch", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ branch: ch.branch }) });
            closeModal('branchPopup'); await loadEmployeesForBranch();
          }catch(err){ toast("Lỗi chọn chi nhánh: " + (err?.message || err), 'error'); }
        };
        container.appendChild(btn);
      });
      openModal('branchPopup');
    }

    /* ===== Search wiring ===== */
    document.getElementById("addEmployeeBtn").addEventListener("click", () => {
      openModal('searchModal');
      document.getElementById("searchInputMain").value="";
      document.getElementById("suggestListMain").innerHTML="";
    });

    let searchTimer=null;
    document.getElementById("searchInputMain").addEventListener("input",(e)=>{
      const q=e.target.value.trim(); const list=document.getElementById("suggestListMain");
      clearTimeout(searchTimer);
      if (!q){ list.innerHTML=""; return; }
      searchTimer=setTimeout(async ()=>{
        try{
          const data = await safeFetchJson(searchUrl(q));
          const top = Array.isArray(data) ? data.slice(0,6) : [];
          list.innerHTML = top.map(emp=>`
            <div class="cursor-pointer rounded-lg p-3 transition-colors hover:bg-slate-400/20" data-code="${emp.code}">
              <p class="font-semibold text-slate-800">${escapeHtml(emp.name)}</p>
              <p class="mt-1 text-sm text-slate-500">${escapeHtml(emp.code)} &bull; ${escapeHtml(emp.department||"")}</p>
            </div>`).join("");
          list.querySelectorAll("div[data-code]").forEach(li=>{
            li.onclick = ()=>{ addBySearchQuery(li.dataset.code); };
          });
        }catch(err){ toast("Lỗi tìm kiếm: " + (err?.message || err), 'error'); }
      }, 300);
    });

    /* ===== Buttons ===== */
    document.getElementById("saveBtn").addEventListener("click", saveAttendance);
    document.getElementById("refreshBtn").addEventListener("click", ()=> loadEmployeesForBranch());

    /* ===== Init ===== */
    window.addEventListener("DOMContentLoaded", async ()=>{
      const role = (userRole||"").toLowerCase();
      if (["quanly","ktv","boss","admin"].includes(role)){
        try{
          const data = await safeFetchJson("/attendance/api/detect-branch", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({}) });
          if (data && data.branch){
            currentBranch = data.branch;
            document.getElementById("branchName").textContent = branchDisplay(currentBranch);
            await loadEmployeesForBranch();
          }else{
            disableForm("Không tìm thấy chi nhánh chính cho tài khoản.");
          }
        }catch(err){ disableForm("Không thể lấy chi nhánh chính."); }
        return;
      }
      const detected = await detectBranchByGPS();
      if (detected){
        await loadEmployeesForBranch();
      }
    });
  </script>
</body>
</html>
