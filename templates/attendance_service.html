<!-- templates/attendance_service.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ch·∫•m d·ªãch v·ª• bu·ªìng ph√≤ng</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --safe-bottom: env(safe-area-inset-bottom, 0px); --safe-top: env(safe-area-inset-top, 0px); }
    .animate-sheetUp { animation: sheetUp .3s cubic-bezier(.22,.61,.36,1) both; }
    @keyframes sheetUp { from { transform: translateY(100%);} to { transform: translateY(0);} }
    .sheet { position:fixed; left:0; right:0; bottom:0; background:#fff; border-top-left-radius:18px; border-top-right-radius:18px; box-shadow:0 -10px 30px rgba(0,0,0,.15); max-height:75vh; }
    .sheet-handle { width:40px; height:5px; border-radius:999px; background:#e5e7eb; margin:10px auto; }
    @media (min-width:900px){
      body{background:linear-gradient(120deg,#f0f4ff 0%,#f9fafb 100%);}
      .desktop-container{max-width:760px;margin:28px auto;background:#fff;border-radius:18px;box-shadow:0 8px 32px rgba(0,0,0,.1);padding:32px;}
      .desktop-table{width:100%;border-collapse:separate;border-spacing:0;background:#f8fafc;border-radius:12px;overflow:hidden;}
      .desktop-table th,.desktop-table td{padding:10px;text-align:left;font-size:15px;}
      .desktop-table th{background:#f1f5f9;font-weight:600;color:#2563eb;border-bottom:1.5px solid #e5e7eb;}
      .desktop-table td{border-bottom:1px solid #e5e7eb;}
      .desktop-table tr:hover{background:#eef2ff;}
      .desktop-btn{padding:11px 28px;border-radius:10px;background:linear-gradient(90deg,#2563eb,#60a5fa);color:#fff;font-weight:600;}
      .desktop-btn:hover{background:linear-gradient(90deg,#1d4ed8,#3b82f6);}
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen pb-28">
  <div class="max-w-xl mx-auto px-4 pt-3 desktop-container">
    <header class="pt-[var(--safe-top)] flex items-center justify-between mb-3">
      <h1 class="text-2xl font-bold">üõé Ch·∫•m d·ªãch v·ª• bu·ªìng ph√≤ng</h1>
      <span class="text-[11px] px-2 py-1 rounded-full bg-blue-50 text-blue-600">Chi nh√°nh: <span id="branchName">{{ branch_id }}</span></span>
    </header>

    <!-- Service list -->
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-lg font-semibold">Danh s√°ch nh√¢n vi√™n</h2>
      <div class="flex gap-2">
        <button id="reloadBtn" class="text-sm px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200">üîÑ T·∫£i l·∫°i</button>
        <button id="addEmployeeBtn" class="text-sm px-3 py-1.5 rounded-lg bg-blue-100 text-blue-700 font-medium hover:bg-blue-200">+ Th√™m nh√¢n vi√™n</button>
      </div>
    </div>

    <div class="hidden md:block">
      <table class="desktop-table w-full" id="serviceTable">
        <thead>
          <tr>
            <th>Nh√¢n vi√™n</th><th>S·ªë ph√≤ng</th><th>S·ªë l∆∞·ª£ng</th><th>D·ªãch v·ª•</th><th>Ghi ch√∫</th><th></th>
          </tr>
        </thead>
        <tbody id="serviceTableBody"></tbody>
      </table>
    </div>
    <div id="serviceList" class="space-y-3 md:hidden"></div>
    <div id="emptyHint" class="hidden text-center text-gray-500 text-sm py-10">Ch∆∞a c√≥ nh√¢n vi√™n n√†o.</div>
  </div>

  <!-- Bottom bar -->
  <div class="fixed left-0 right-0 bottom-0 border-t border-gray-200 bg-white shadow-lg">
    <div class="max-w-xl mx-auto px-4 py-2 flex gap-2 justify-end">
      <button id="serviceSaveBtn" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-semibold desktop-btn">üíæ L∆∞u d·ªãch v·ª•</button>
    </div>
    <div class="max-w-xl mx-auto px-4 pb-1 text-xs text-gray-600 text-right"><span id="status">Ch∆∞a l∆∞u</span></div>
  </div>

  <!-- Popup add employee -->
  <div id="addSheet" class="sheet hidden animate-sheetUp">
    <div class="sheet-handle"></div>
    <div class="px-4 pb-4">
      <input id="searchInput" type="text" placeholder="üîç T√¨m nh√¢n vi√™n BP..." class="w-full border rounded-lg px-3 py-2 text-sm mb-3">
      <div id="searchResults" class="space-y-2 max-h-[55vh] overflow-y-auto"></div>
    </div>
  </div>

<script>
  let currentBranch="{{ branch_id }}"; const csrfToken="{{ csrf_token }}";
  let serviceRows = JSON.parse('{{ initial_employees | tojson | safe }}'); // B·ªçc trong d·∫•u nh√°y ƒë∆°n ƒë·ªÉ ƒë·∫£m b·∫£o l√† string literal
  const statusEl=document.getElementById("status");
  const serviceList=document.getElementById("serviceList");
  const serviceTableBody=document.getElementById("serviceTableBody");
  function showStatus(t){statusEl.textContent=t;}

  // Render
  function renderService(){
    if(serviceRows.length===0){document.getElementById("emptyHint").classList.remove("hidden");}
    else{document.getElementById("emptyHint").classList.add("hidden");}

    serviceList.innerHTML="";
    serviceRows.forEach((r,i)=>{
      const el=document.createElement("div");
      el.className="bg-white border rounded-xl p-3 shadow-sm";
      el.innerHTML=`
        <div class="flex justify-between items-center">
          <div class="font-medium">${r.name}</div>
          <button onclick="removeRow(${i})" class="text-red-500 text-xs">‚úï X√≥a</button>
        </div>
        <div class="mt-2 grid grid-cols-3 gap-2">
          <input placeholder="Ph√≤ng" class="border rounded px-2 py-1 text-sm" data-i="${i}" data-f="so_phong" value="${r.so_phong||""}">
          <input type="number" placeholder="SL" class="border rounded px-2 py-1 text-sm" data-i="${i}" data-f="so_luong" value="${r.so_luong||""}">
          <select class="border rounded px-2 py-1 text-sm" data-i="${i}" data-f="dich_vu">
            <option value="">D·ªãch v·ª•</option>
            <option value="Gi·∫∑t" ${r.dich_vu==="Gi·∫∑t"?"selected":""}>Gi·∫∑t</option>
            <option value="·ª¶i" ${r.dich_vu==="·ª¶i"?"selected":""}>·ª¶i</option>
          </select>
        </div>
        <input placeholder="Ghi ch√∫" class="mt-2 w-full border rounded px-2 py-1 text-sm" data-i="${i}" data-f="ghi_chu" value="${r.ghi_chu||""}">
      `;
      serviceList.appendChild(el);
    });
    serviceList.querySelectorAll("input,select").forEach(el=>{
      el.oninput=()=>{serviceRows[el.dataset.i][el.dataset.f]=el.value; showStatus("Ch∆∞a l∆∞u");};
    });

    serviceTableBody.innerHTML="";
    serviceRows.forEach((r,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${r.name}</td>
        <td><input class="border rounded px-2 py-1 text-sm w-20" data-i="${i}" data-f="so_phong" value="${r.so_phong||""}"></td>
        <td><input type="number" class="border rounded px-2 py-1 text-sm w-16" data-i="${i}" data-f="so_luong" value="${r.so_luong||""}"></td>
        <td>
          <select class="border rounded px-2 py-1 text-sm" data-i="${i}" data-f="dich_vu">
            <option value="">Ch·ªçn</option>
            <option value="Gi·∫∑t" ${r.dich_vu==="Gi·∫∑t"?"selected":""}>Gi·∫∑t</option>
            <option value="·ª¶i" ${r.dich_vu==="·ª¶i"?"selected":""}>·ª¶i</option>
          </select>
        </td>
        <td><input class="border rounded px-2 py-1 text-sm w-28" data-i="${i}" data-f="ghi_chu" value="${r.ghi_chu||""}"></td>
        <td><button onclick="removeRow(${i})" class="text-red-500 text-xs">X√≥a</button></td>
      `;
      serviceTableBody.appendChild(tr);
    });
    serviceTableBody.querySelectorAll("input,select").forEach(el=>{
      el.oninput=()=>{serviceRows[el.dataset.i][el.dataset.f]=el.value; showStatus("Ch∆∞a l∆∞u");};
    });
  }
  function removeRow(i){serviceRows.splice(i,1); renderService(); showStatus("Ch∆∞a l∆∞u");}

  // Save
 async function saveService() {
    const rows = document.querySelectorAll("#employeeTable tbody tr");
    const payload = [];

    rows.forEach(row => {
        const code = row.getAttribute("data-code");
        const name = row.cells[1].innerText;
        const branch = row.getAttribute("data-branch"); // ‚úÖ branch ƒë∆∞·ª£c g·∫Øn t·ª´ initial_employees

        const so_phong = row.querySelector("input[name=so_phong]").value;
        const so_luong = row.querySelector("input[name=so_luong]").value;
        const dich_vu = row.querySelector("input[name=dich_vu]").value;
        const ghi_chu = row.querySelector("input[name=ghi_chu]").value;

        payload.push({
            code,
            name,
            branch,       // gi·ªØ l·∫°i ƒë·ªÉ backend bi·∫øt chi nh√°nh
            so_phong,
            so_luong,
            dich_vu,
            ghi_chu
        });
    });

    if (!payload.length) {
        alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u");
        return;
    }

    const now = new Date().toISOString().slice(0, 19).replace("T", " ");

    const normalized = payload.map(r => ({
        sheet: "DV",
        thoi_gian: now,
        ma_nv: r.code,
        ten_nv: r.name,
        chi_nhanh_chinh: r.main_branch || currentBranch,   // chi nh√°nh ch√≠nh t·ª´ h·ªì s∆° nh√¢n vi√™n
        chi_nhanh_lam: r.branch || currentBranch,         // chi nh√°nh l√∫c ƒëi·ªÉm danh
        la_tang_ca: (r.branch || currentBranch) !== currentBranch,
        ghi_chu: r.ghi_chu || "",
        dich_vu: r.dich_vu,
        so_phong: r.so_phong,
        so_luong: r.so_luong
    }));

    try {
        const resp = await fetch("/attendance/checkin_bulk", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRF-Token": csrfToken
            },
            body: JSON.stringify(normalized)
        });

        const result = await resp.json();
        if (resp.ok) {
            alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
        } else {
            alert("L·ªói: " + result.detail);
        }
    } catch (err) {
        alert("C√≥ l·ªói khi g·ªçi API: " + err);
    }
}

  document.getElementById("serviceSaveBtn").onclick=saveService;

  // Popup add employee
  const addSheet=document.getElementById("addSheet");
  document.getElementById("addEmployeeBtn").onclick=()=>{addSheet.classList.remove("hidden");document.getElementById("searchInput").focus();};
  document.getElementById("searchInput").oninput=async(e)=>{
    const q=e.target.value.trim(); if(!q){document.getElementById("searchResults").innerHTML="";return;}
    const url = `/attendance/api/employees/search?q=${encodeURIComponent(q)}&only_bp=true&branch_id=${encodeURIComponent(currentBranch)}`;
    const data=await fetch(url).then(r=>r.json());
    const c=document.getElementById("searchResults"); c.innerHTML="";
    if(data.length===0){c.innerHTML="<div class='text-gray-400 text-sm px-3 py-2'>Kh√¥ng t√¨m th·∫•y</div>";}
    data.forEach(emp=>{
      const btn=document.createElement("button");
      btn.className="w-full text-left px-3 py-2 border rounded-lg hover:bg-blue-50";
      btn.textContent=`${emp.name} (${emp.code})`;
      btn.onclick=()=>{
        if(serviceRows.some(r=>r.code===emp.code)){alert("Nh√¢n vi√™n n√†y ƒë√£ c√≥ trong danh s√°ch");return;}
        serviceRows.push({code:emp.code,name:emp.name,branch:emp.branch,so_phong:"",so_luong:"",dich_vu:"",ghi_chu:""});
        renderService(); addSheet.classList.add("hidden");
        document.getElementById("searchInput").value = ""; // Clear search input
        c.innerHTML = ""; // Clear results
      };
      c.appendChild(btn);
    });
  };

  async function loadInitialEmployees() {
    // H√†m n√†y ƒë∆∞·ª£c g·ªçi b·ªüi n√∫t "T·∫£i l·∫°i".
    // N√≥ s·∫Ω reset danh s√°ch v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu: ch·ªâ nh·ªØng nh√¢n vi√™n BP ƒë√£ ƒë∆∞·ª£c ƒëi·ªÉm danh l·∫ßn cu·ªëi.
    try{
      showStatus("ƒêang t·∫£i l·∫°i danh s√°ch ƒë√£ ƒëi·ªÉm danh...");
      const data = await fetch('/api/attendance/last-checked-in-bp').then(r => {
        if (!r.ok) throw new Error('L·ªói m√°y ch·ªß khi t·∫£i l·∫°i.');
        return r.json();
      });
      
      if (!Array.isArray(data)) throw new Error("API kh√¥ng tr·∫£ v·ªÅ d·ªØ li·ªáu m·∫£ng.");

      serviceRows = data; // D·ªØ li·ªáu t·ª´ API ƒë√£ c√≥ c·∫•u tr√∫c chu·∫©n
      renderService(); showStatus("S·∫µn s√†ng");
    }catch(e){alert("‚ùå L·ªói t·∫£i l·∫°i: "+e.message); showStatus("L·ªói t·∫£i d·ªØ li·ªáu");}
  }

  // Load initial
  document.getElementById("reloadBtn").onclick = loadInitialEmployees;
  window.addEventListener("DOMContentLoaded", () => {
    // Lu√¥n render danh s√°ch ban ƒë·∫ßu, d√π n√≥ r·ªóng hay kh√¥ng.
    // `serviceRows` ƒë√£ ch·ª©a danh s√°ch nh√¢n vi√™n ƒë∆∞·ª£c ƒëi·ªÉm danh l·∫ßn cu·ªëi (n·∫øu c√≥).
    // N·∫øu `serviceRows` r·ªóng, `renderService()` s·∫Ω t·ª± ƒë·ªông hi·ªÉn th·ªã th√¥ng b√°o "Ch∆∞a c√≥ nh√¢n vi√™n n√†o.".
    // N√∫t "T·∫£i l·∫°i" c≈©ng s·∫Ω reset v·ªÅ danh s√°ch n√†y.
    renderService();
    showStatus("S·∫µn s√†ng");
  });
</script>
</body>
</html>
