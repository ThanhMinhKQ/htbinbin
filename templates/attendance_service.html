<!-- templates/attendance_service.html | 2025 EU-modern redesign
Notes:
- Keep same backend endpoints & payload shape.
- No icon fonts/emoji → inline SVG only.
- Tailwind only, no extra deps. 
- Desktop-first with graceful mobile.
- Smooth micro-interactions & animations.
-->
<!DOCTYPE html>
<html lang="vi" class="h-full scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Chấm dịch vụ buồng phòng</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }
    /* Modal animation */
    #addModal { transition: opacity 200ms ease-in-out; }
    #addModal > div { transition: transform 200ms ease-in-out, opacity 200ms ease-in-out; }
    #addModal.hidden { opacity: 0; pointer-events: none; }
    #addModal.hidden > div { transform: translateY(1rem) scale(0.98); opacity: 0; }

    /* Gradient button animation */
    .btn-gradient {
      /* Tailwind: from-blue-600 via-cyan-500 to-blue-600 */
      background-image: linear-gradient(to right, #2563eb 0%, #06b6d4 50%, #2563eb 100%);
      background-size: 200% auto;
      transition: background-position 0.3s cubic-bezier(.4,0,.2,1);
    }
    .btn-gradient:hover {
      background-position: right center;
    }
    /* Elevation + rounded for desktop card */
    @media (min-width: 960px){
      body{background:linear-gradient(120deg,#eef2ff 0%,#f9fafb 100%);} 
      .desktop-shell{max-width:960px;margin:40px auto;background:#fff;border-radius:22px;box-shadow:0 10px 40px rgba(0,0,0,.08);}
    }

    /* Fancy focus ring */
    .focus-ring:focus{ outline: none; box-shadow: 0 0 0 3px rgba(3,105,161,.18), 0 0 0 1px rgba(3,105,161,.35) inset; }

    /* Subtle appear */
    .fade-in{animation:fi .2s ease-out both}
    @keyframes fi{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

    /* Table zebra */
    .tbl tr:nth-child(even) td{ background: #fafafa; }

    /* Status modal success animation */
    .checkmark__circle {
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      stroke-width: 2;
      stroke-miterlimit: 10;
      fill: none;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }
    .checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: block;
      stroke-width: 2;
      stroke: #fff;
      stroke-miterlimit: 10;
      margin: 10% auto;
      animation-duration: .4s, .3s; animation-timing-function: ease-in-out, ease-in-out; animation-delay: .4s, .9s; animation-fill-mode: forwards, both;
    }
    .checkmark__check {
      transform-origin: 50% 50%;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }
    @keyframes stroke { 100% { stroke-dashoffset: 0; } }
    @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
    @keyframes fill-green { 100% { box-shadow: inset 0px 0px 0px 40px #4ade80; } }
    @keyframes fill-blue { 100% { box-shadow: inset 0px 0px 0px 40px #60a5fa; } } /* blue-400 */

    /* Default (save) success colors */
    #statusSuccess:not(.is-reload) .checkmark__circle { stroke: #4ade80; } /* green-400 */
    #statusSuccess:not(.is-reload) .checkmark { animation-name: fill-green, scale; }
    #statusSuccess:not(.is-reload) .timer-bar-container { background-color: rgba(74, 222, 128, 0.5); }
    #statusSuccess:not(.is-reload) .timer-bar-inner { background-color: #4ade80; }

    /* Blue override for reload success */
    #statusSuccess.is-reload .checkmark__circle { stroke: #60a5fa; } /* blue-400 */
    #statusSuccess.is-reload .checkmark { animation-name: fill-blue, scale; }
    #statusSuccess.is-reload .timer-bar-container { background-color: rgba(96, 165, 250, 0.5); }
    #statusSuccess.is-reload .timer-bar-inner { background-color: #60a5fa; }
    .reload__arrow {
      transform-origin: 50% 50%;
      stroke-dasharray: 100;
      stroke-dashoffset: 100;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }

    /* Timer bar for success modal */
    .timer-bar-inner {
      animation-name: shrink;
      animation-timing-function: linear;
      animation-fill-mode: forwards;
    }
    @keyframes shrink {
      from { width: 100%; }
      to { width: 0%; }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen pb-[calc(76px+var(--safe-bottom))] antialiased">
  <div class="desktop-shell">
    <!-- Header -->
    <header class="sticky top-0 z-30 backdrop-blur supports-[backdrop-filter]:bg-white/70 bg-white/90 border-b border-slate-200 pt-[var(--safe-top)]">
      <div class="mx-auto max-w-screen-lg px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <!-- Nút quay lại -->
          <a href="/choose-function" title="Quay lại" class="p-2 rounded-full text-slate-600 hover:bg-slate-100 transition-colors">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline>
            </svg>
          </a>
          <div class="p-2 rounded-xl bg-blue-50 border border-blue-100 shadow-sm">
            <!-- Bell concierge SVG -->
            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
              <path d="M12 6a4 4 0 0 0-4 4v1H6a4 4 0 0 0-4 4v1h20v-1a4 4 0 0 0-4-4h-2v-1a4 4 0 0 0-4-4Z"/>
              <path d="M12 3v2"/>
            </svg>
          </div>
          <div>
            <h1 class="text-xl md:text-2xl font-semibold tracking-tight text-slate-800">Chấm dịch vụ buồng phòng</h1>
            
          </div>
        </div>
        <span class="text-[11px] px-2.5 py-1.5 rounded-full bg-blue-50 text-blue-700 border border-blue-100">
          Chi nhánh: {{ branch_id }}
        </span>
      </div>
    </header>

    <!-- Main -->
    <main class="mx-auto max-w-screen-lg px-4 py-4 space-y-4">
      <!-- Toolbar -->
      <div class="flex flex-wrap items-center justify-between gap-2">
        <h2 class="text-base md:text-lg font-semibold text-slate-800">Danh sách nhân viên</h2>
        <div class="flex items-center gap-2">
          <button id="reloadBtn" class="group inline-flex items-center gap-2 text-sm px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 border border-slate-200 transition active:scale-[.98] focus-ring" title="Tải lại danh sách">
            <svg class="w-4 h-4 group-active:rotate-90 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M20 12a8 8 0 1 1-2.34-5.66"/><path d="M20 4v6h-6"/></svg>
            <span>Tải lại</span>
          </button>
          <button id="addEmployeeBtn" class="btn-gradient group inline-flex items-center gap-2 text-sm px-3 py-2 rounded-xl text-white shadow-md hover:shadow-lg transition active:scale-[.98] focus-ring" title="Thêm nhân viên">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M12 5v14M5 12h14"/></svg>
            <span>Thêm nhân viên</span>
          </button>
        </div>
      </div>

      <!-- Desktop table -->
      <div class="hidden md:block">
        <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white">
          <table class="w-full tbl" id="serviceTable">
            <thead class="bg-slate-100/80">
              <tr class="text-left text-slate-600 text-xs uppercase tracking-wider">
                <th class="font-semibold px-3 py-3">Nhân viên</th>
                <th class="font-semibold px-3 py-3">Số phòng</th>
                <th class="font-semibold px-3 py-3">Số lượng</th>
                <th class="font-semibold px-3 py-3">Dịch vụ</th>
                <th class="font-semibold px-3 py-3">Ghi chú</th>
                <th class="w-20"></th>
              </tr>
            </thead>
            <tbody id="serviceTableBody" class="text-[13px] text-slate-800"></tbody>
          </table>
        </div>
      </div>

      <!-- Mobile cards -->
      <div id="serviceList" class="space-y-3 md:hidden"></div>
      <div id="emptyHint" class="hidden text-center text-slate-500 text-sm py-12">Chưa có nhân viên nào.</div>
    </main>
  </div>

  <!-- Bottom action bar -->
  <div class="fixed left-0 right-0 bottom-0 border-t border-slate-200 bg-white/95 backdrop-blur supports-[backdrop-filter]:bg-white/75 shadow-2xl">
    <div class="mx-auto max-w-screen-lg px-4 py-3 flex flex-col gap-1">
      <div class="flex items-center gap-2 justify-end">
        <button id="serviceSaveBtn" class="btn-gradient flex-1 md:flex-none inline-flex items-center justify-center gap-2 text-white px-4 py-3 rounded-2xl font-semibold shadow-md hover:shadow-lg active:scale-[.99] transition focus-ring">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4 7a2 2 0 0 1 2-2h9l5 5v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7Z"/><path d="M7 7h7v6H7z"/></svg>
          <span>Lưu dịch vụ</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Add employee Modal (Glassmorphism) -->
  <div id="addModal" class="fixed inset-0 z-40 hidden flex items-center justify-center p-4 bg-black/25 backdrop-blur-sm">
    <div class="w-full max-w-md">
      <div class="bg-white/70 backdrop-blur-xl rounded-2xl border border-white/20 shadow-lg p-6 space-y-4">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-slate-800">Thêm nhân viên</h3>
          <button id="closeModalBtn" class="p-1 rounded-full text-slate-500 hover:bg-slate-400/20 transition-colors" aria-label="Đóng">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="relative">
          <input id="searchInput" type="text" inputmode="search" placeholder="Tìm nhân viên BP..." class="w-full border border-slate-300 bg-white/80 rounded-2xl px-4 py-3 text-base focus-ring" aria-label="Tìm nhân viên" />
          <svg class="w-4 h-4 absolute right-4 top-1/2 -translate-y-1/2 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><circle cx="11" cy="11" r="7"/><path d="M20 20l-3-3"/></svg>
        </div>
        <div id="searchResults" class="space-y-2 max-h-[50vh] overflow-y-auto -mr-2 pr-2"></div>
      </div>
    </div>
  </div>

  <!-- Status Modal (Loading, Success, Error) -->
  <div id="statusModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/30 backdrop-blur-sm transition-opacity duration-200 opacity-0">
    <div id="statusModalContent" class="relative w-full max-w-xs bg-white rounded-2xl shadow-xl p-6 text-center space-y-4 overflow-hidden">
      <!-- Loading State -->
      <div id="statusLoading">
        <svg class="animate-spin mx-auto h-12 w-12 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loadingMessage" class="mt-4 text-slate-700 font-medium">Đang xử lý...</p>
      </div>
      <!-- Success State -->
      <div id="statusSuccess" class="hidden">
        <!-- Save Icon (default) -->
        <svg id="saveSuccessIcon" class="checkmark mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
          <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
          <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
        <!-- Reload Icon -->
        <svg id="reloadSuccessIcon" class="checkmark mx-auto hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="reload__arrow" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M40 22a14 14 0 1 1-6-11.3M40 13v9h-9"/>
        </svg>
        <p id="successMessage" class="mt-4 text-slate-700 font-medium">Thành công!</p>
        <div class="absolute bottom-0 left-0 right-0 h-1 timer-bar-container">
            <div class="h-full timer-bar-inner"></div>
        </div>
      </div>
      <!-- Error State -->
      <div id="statusError" class="hidden">
         <svg class="mx-auto h-12 w-12 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
           <circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>
         </svg>
        <p id="errorMessage" class="mt-4 text-slate-700 font-medium">Đã xảy ra lỗi.</p>
        <button id="closeStatusModalBtn" class="mt-4 w-full px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-semibold transition-colors">Đóng</button>
      </div>
    </div>
  </div>

<script>
  // ------- State & constants -------
  let currentBranch = "{{ branch_id }}";
  const csrfToken = "{{ csrf_token }}";
  let serviceRows = JSON.parse('{{ initial_employees | tojson | safe }}');
  let modalHideTimer = null; // For auto-hiding modal

  const serviceList = document.getElementById("serviceList");
  const serviceTableBody = document.getElementById("serviceTableBody");
  const addModal = document.getElementById("addModal");
  // New modal elements
  const statusModal = document.getElementById("statusModal");
  const statusModalContent = document.getElementById("statusModalContent");
  const statusLoading = document.getElementById("statusLoading");
  const statusSuccess = document.getElementById("statusSuccess");
  const statusError = document.getElementById("statusError");
  const errorMessage = document.getElementById("errorMessage");
  const loadingMessage = document.getElementById("loadingMessage");
  const successMessage = document.getElementById("successMessage");

  const SERVICES = ["Giặt","Ủi"]; // giữ nguyên danh mục để không phá backend mapping

  const fmt = (v)=> v==null? "" : String(v);

  // ------- UI helpers -------
  function showStatusModal(state, message = "", autoHideDuration = 0, onHidden = null, options = {}) {
    const { iconType = 'save' } = options;

    // Clear any previous timer to prevent conflicts
    if (modalHideTimer) clearTimeout(modalHideTimer);
    modalHideTimer = null;
    
    // Reset mouse listeners
    statusModalContent.onmouseenter = null;
    statusModalContent.onmouseleave = null;

    const saveIcon = document.getElementById('saveSuccessIcon');
    const reloadIcon = document.getElementById('reloadSuccessIcon');

    // Reset icon animations by briefly removing and re-adding the 'checkmark' class
    [saveIcon, reloadIcon].forEach(icon => {
        if (icon) {
            icon.classList.remove('checkmark');
            void icon.offsetWidth; // trigger reflow
            icon.classList.add('checkmark');
        }
    });

    // Reset timer bar animation
    const timerBar = document.querySelector('.timer-bar-inner');
    if (timerBar) {
      timerBar.style.animation = 'none';
      timerBar.offsetHeight; /* trigger reflow */
    }

    statusLoading.classList.add('hidden');
    statusSuccess.classList.add('hidden');
    statusError.classList.add('hidden');
    statusSuccess.classList.remove('is-reload'); // Reset to default green scheme
    saveIcon.classList.add('hidden');
    reloadIcon.classList.add('hidden');

    if (state === 'loading') {
      loadingMessage.textContent = message || "Đang xử lý...";
      statusLoading.classList.remove('hidden');
    } else if (state === 'success') {
      successMessage.textContent = message || "Thành công!";
      
      if (iconType === 'reload') {
        statusSuccess.classList.add('is-reload'); // Apply blue color scheme
        reloadIcon.classList.remove('hidden');
      } else {
        saveIcon.classList.remove('hidden');
      }

      statusSuccess.classList.remove('hidden');
      // Start timer bar animation
      if (timerBar && autoHideDuration > 0) {
          timerBar.style.animationDuration = `${autoHideDuration / 1000}s`;
          timerBar.style.animationName = 'shrink';
      }
    } else if (state === 'error') {
      errorMessage.textContent = message || "Đã xảy ra lỗi không xác định.";
      statusError.classList.remove('hidden');
    }
    statusModal.classList.remove('hidden');
    statusModal.classList.remove('opacity-0');

    // Handle auto-hide for success state
    if (state === 'success' && autoHideDuration > 0) {
      let remaining = autoHideDuration;
      let resumeTime;

      const pause = () => {
        if (modalHideTimer) {
          clearTimeout(modalHideTimer);
          modalHideTimer = null;
          remaining -= (Date.now() - resumeTime);
          if (timerBar) timerBar.style.animationPlayState = 'paused';
        }
      };

      const resume = () => {
        if (remaining > 0 && !modalHideTimer) {
          resumeTime = Date.now();
          if (timerBar) timerBar.style.animationPlayState = 'running';
          modalHideTimer = setTimeout(() => {
            hideStatusModal();
            if (onHidden) onHidden();
          }, remaining);
        }
      };

      statusModalContent.onmouseenter = pause;
      statusModalContent.onmouseleave = resume;

      resume(); // Start the timer
    }
  }

  function hideStatusModal() {
    statusModal.classList.add('opacity-0');
    setTimeout(() => {
        statusModal.classList.add('hidden');
        // Clean up listeners after hiding to be safe
        statusModalContent.onmouseenter = null;
        statusModalContent.onmouseleave = null;
    }, 200);
  }
  document.getElementById("closeStatusModalBtn").onclick = hideStatusModal;

  const openModal = () => {
    addModal.classList.remove("hidden");
    setTimeout(() => document.getElementById("searchInput").focus(), 50);
  };

  const closeModal = () => {
    addModal.classList.add("hidden");
    document.getElementById("searchInput").value = "";
    document.getElementById("searchResults").innerHTML = "";
  };

  // Event listeners for modal
  document.getElementById("addEmployeeBtn").onclick = openModal;
  document.getElementById("closeModalBtn").onclick = closeModal;
  addModal.addEventListener('click', (e) => {
    if (e.target === addModal) closeModal();
  });
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !addModal.classList.contains('hidden')) {
      closeModal();
    }
  });

  const inputBase = "border border-slate-300 rounded-xl px-2.5 py-1.5 text-base focus-ring";
  const selectBase = inputBase + " bg-white";
  const btnLink = "text-[12px] text-red-600 hover:text-red-700 underline underline-offset-2";

  // ------- Render (Mobile cards + Desktop table) -------
  function renderService(){
    // Empty hint
    const hasData = Array.isArray(serviceRows) && serviceRows.length>0;
    document.getElementById("emptyHint").classList.toggle("hidden", hasData);

    // Mobile
    serviceList.innerHTML = "";
    serviceRows.forEach((r,i)=>{
      const wrap = document.createElement("div");
      wrap.className = "fade-in bg-white border border-slate-200 rounded-2xl p-3 shadow-sm";
      wrap.innerHTML = `
        <div class="flex justify-between items-start">
          <div class="font-medium text-slate-800">${fmt(r.name)}</div>
          <button type="button" class="${btnLink}" onclick="removeRow(${i})" aria-label="Xóa dòng">
            <span class="inline-flex items-center gap-1">
              <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 7h12M9 7v12m6-12v12M10 7l1-2h2l1 2"/></svg>
              Xóa
            </span>
          </button>
        </div>
        <div class="mt-2 grid grid-cols-3 gap-2">
          <input placeholder="Phòng" class="${inputBase}" data-i="${i}" data-f="so_phong" value="${fmt(r.so_phong)}">
          <input type="number" min="1" placeholder="SL" class="${inputBase}" data-i="${i}" data-f="so_luong" value="${fmt(r.so_luong)}">
          <select class="${selectBase}" data-i="${i}" data-f="dich_vu">${serviceOptions(r.dich_vu)}</select>
        </div>
        <input placeholder="Ghi chú" class="mt-2 w-full ${inputBase}" data-i="${i}" data-f="ghi_chu" value="${fmt(r.ghi_chu)}">
      `;
      serviceList.appendChild(wrap);
    });

    // Desktop table
    serviceTableBody.innerHTML = "";
    serviceRows.forEach((r,i)=>{
      const tr = document.createElement("tr");
      tr.className = "hover:bg-slate-50 transition-colors";
      tr.innerHTML = `
        <td class="px-3 py-2">${fmt(r.name)}</td>
        <td class="px-3 py-2"><input class="${inputBase} w-24" data-i="${i}" data-f="so_phong" value="${fmt(r.so_phong)}"></td>
        <td class="px-3 py-2"><input type="number" min="1" class="${inputBase} w-20" data-i="${i}" data-f="so_luong" value="${fmt(r.so_luong)}"></td>
        <td class="px-3 py-2"><select class="${selectBase}" data-i="${i}" data-f="dich_vu">${serviceOptions(r.dich_vu)}</select></td>
        <td class="px-3 py-2"><input class="${inputBase} w-40" data-i="${i}" data-f="ghi_chu" value="${fmt(r.ghi_chu)}"></td>
        <td class="px-3 py-2 text-right">
          <button type="button" onclick="removeRow(${i})" class="text-[12px] text-red-600 hover:text-red-700 inline-flex items-center gap-1">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 7h12M9 7v12m6-12v12M10 7l1-2h2l1 2"/></svg>
            Xóa
          </button>
        </td>
      `;
      serviceTableBody.appendChild(tr);
    });

    // Bind change handlers
    document.querySelectorAll("#serviceList input,#serviceList select,#serviceTableBody input,#serviceTableBody select").forEach(el=>{
      el.oninput = ()=>{ serviceRows[el.dataset.i][el.dataset.f] = el.type==='number'? (el.value===''? '' : Number(el.value)) : el.value; unsaved = true; };
    });
  }

  function serviceOptions(selected){
    let html = '<option value="">Chọn</option>';
    for(const s of SERVICES){ html += `<option value="${s}" ${selected===s? 'selected':''}>${s}</option>`; }
    return html;
  }

  function removeRow(i){ serviceRows.splice(i,1); renderService(); unsaved = true; }

  // ------- Save (keep original payload structure/endpoint) -------
  let unsaved = false;
  window.addEventListener('beforeunload', (e)=>{ if(unsaved){ e.preventDefault(); e.returnValue = ''; }});

  async function saveService(event){
    const submitBtn = event.target.closest('button');
    if (submitBtn.disabled) return; // Prevent double-click

    submitBtn.disabled = true;
    submitBtn.querySelector('span').textContent = 'Đang lưu...';

    if (!serviceRows || serviceRows.length === 0) {
      showStatusModal('error', "Danh sách trống, không có gì để lưu.");
      return;
    }

    // Validate all rows before saving
    for (const row of serviceRows) {
      if (!row.so_phong) {
        showStatusModal('error', `Nhân viên "${row.name}" cần nhập "Số phòng".`);
        return;
      }
      if (row.so_luong === '' || row.so_luong == null) { // Check if empty
        showStatusModal('error', `Nhân viên "${row.name}" cần nhập "Số lượng".`);
        return;
      }
      if (row.so_luong <= 0) { // Check if not positive
        showStatusModal('error', `Số lượng của nhân viên "${row.name}" phải lớn hơn 0.`);
        return;
      }
      if (!row.dich_vu) {
        showStatusModal('error', `Nhân viên "${row.name}" cần chọn "Dịch vụ".`);
        return;
      }
    }

    showStatusModal('loading', 'Đang lưu dữ liệu...');

    const now = new Date().toISOString().slice(0, 19).replace("T", " ");
    const normalized = serviceRows.map(r => ({
      sheet: "DV",
      thoi_gian: now,
      ma_nv: r.code,
      ten_nv: r.name,
      chi_nhanh_chinh: r.branch || currentBranch,
      chi_nhanh_lam: currentBranch,
      la_tang_ca: (r.branch || currentBranch) !== currentBranch,
      ghi_chu: r.ghi_chu || "", // Đảm bảo ghi chú là chuỗi
      dich_vu: r.dich_vu,
      so_phong: r.so_phong,
      so_luong: r.so_luong
    }));

    try {
      const res = await fetch("/attendance/checkin_bulk", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRF-Token": csrfToken },
        body: JSON.stringify(normalized)
      });

      if (!res.ok) {
        let errorText = `Lỗi máy chủ: ${res.status}`;
        try { const errorData = await res.json(); if (errorData.detail) errorText = errorData.detail; }
        catch { /* Ignore if response is not JSON */ }
        throw new Error(errorText);
      }

      // Use the new modal function with auto-hide and callback
      showStatusModal(
        'success', 
        'Lưu thành công!', 
        1800, // duration
        async () => { await loadInitialEmployees(false); } // onHidden callback, no modals
      );

    } catch (e) {
      showStatusModal('error', e.message);
    } finally {
      submitBtn.disabled = false;
      submitBtn.querySelector('span').textContent = 'Lưu dịch vụ';
    }
  }

  document.getElementById("serviceSaveBtn").addEventListener('click', saveService);

  // Debounce helper
  const debounce = (fn, d=250)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d); }; };

  const renderSearchResults = (data)=>{
    const c = document.getElementById("searchResults"); c.innerHTML = "";
    if(!Array.isArray(data) || data.length===0){
      c.innerHTML = "<div class='text-slate-400 text-sm px-3 py-2'>Không tìm thấy</div>"; return;
    }
    data.forEach(emp=>{
      const btn = document.createElement("button");
      btn.className = "w-full text-left px-3 py-2 border border-slate-200 rounded-xl hover:bg-blue-50 active:scale-[.99] transition";
      btn.innerHTML = `<div class='flex items-center justify-between'>
        <span class='font-medium text-slate-800'>${emp.name}</span>
        <span class='text-xs text-slate-500'>${emp.code}</span>
      </div>`;
      btn.onclick = ()=>{
        if(serviceRows.some(r=> r.code===emp.code)) {
          showStatusModal('error', 'Nhân viên này đã có trong danh sách.');
          return;
        }
        serviceRows.push({ code: emp.code, name: emp.name, branch: emp.branch, so_phong:"", so_luong:"", dich_vu:"", ghi_chu:"" });
        renderService(); closeModal();
        document.getElementById("searchInput").value = "";
        c.innerHTML = "";
        unsaved = true;
      };
      c.appendChild(btn);
    });
  };

  const doSearch = debounce(async(q)=>{
    if(!q){ renderSearchResults([]); return; }
    const url = `/attendance/api/employees/search?q=${encodeURIComponent(q)}&only_bp=true&branch_id=${encodeURIComponent(currentBranch)}`;
    try{
      const data = await fetch(url).then(r=> r.json());
      renderSearchResults(data);
    }catch{ renderSearchResults([]); }
  }, 260);

  document.getElementById("searchInput").addEventListener('input', (e)=> doSearch(e.target.value.trim()));

  // ------- Reload initial checked-in list -------
  async function loadInitialEmployees(showModals = true){
    if (showModals) showStatusModal('loading', 'Đang tải lại danh sách...');
    try{
      const data = await fetch('/api/attendance/last-checked-in-bp').then(r=>{ if(!r.ok) throw new Error('Lỗi máy chủ khi tải lại.'); return r.json(); });
      if(!Array.isArray(data)) throw new Error('API không trả về mảng.');
      serviceRows = data;
      renderService();
      unsaved = false;
      if (showModals) {
        // Use the new modal function with auto-hide and custom icon
        showStatusModal('success', 'Đã tải lại danh sách!', 1800, null, { iconType: 'reload' });
      }
    }catch(e){
      if (showModals) {
        showStatusModal('error', "Lỗi tải lại: " + e.message);
      } else {
        console.error("Lỗi khi tải lại danh sách (ẩn):", e.message);
      }
    }
  }

  document.getElementById("reloadBtn").onclick = () => loadInitialEmployees(true);

  // ------- Init -------
  window.addEventListener('DOMContentLoaded', ()=>{ renderService(); });
</script>
<script>
    function checkAndLogoutForShiftChange() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();

        // Tự động đăng xuất lúc 6:59 sáng
        const isMorningLogout = (hours === 6 && minutes === 59); // Giữ nguyên hoặc thay đổi để test

        // Tự động đăng xuất lúc 18:59 tối
        const isEveningLogout = (hours === 18 && minutes === 59); // <-- THAY ĐỔI GIỜ VÀ PHÚT Ở ĐÂY

        if (isMorningLogout || isEveningLogout) {
            console.log("Đã đến giờ chuyển ca, tự động đăng xuất...");
            // Chuyển hướng về trang đăng xuất để xóa session
            window.location.href = '/logout';
        }
    }

    // Kiểm tra thời gian mỗi 30 giây để đảm bảo không bỏ lỡ
    setInterval(checkAndLogoutForShiftChange, 30000);
</script>
</body>
</html>
