<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lịch Chấm Công Theo Chi Nhánh</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

  <div class="container mx-auto p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <!-- Header -->
        <div class="mb-8 text-center">
        <h1 class="text-3xl md:text-4xl font-light text-gray-800 tracking-wide">
            Lịch Chấm Công
        </h1>
        <p class="mt-2 text-base text-gray-500">
            Chi nhánh: 
            <span class="ml-1 px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm shadow-sm">
            {{ selected_branch or 'Chưa chọn' }}
            </span>
        </p>
        </div>

      <a href="/choose-function"
         class="inline-flex items-center px-4 py-2 rounded-xl shadow-md bg-indigo-600 text-white text-sm font-medium hover:bg-indigo-700 transition">
        <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="currentColor"
             viewBox="0 0 20 20" aria-hidden="true">
          <path fill-rule="evenodd"
                d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 
                1 0 01-1.414 1.414l-4-4a1 1 0 
                010-1.414l4-4a1 1 0 011.414 0z"
                clip-rule="evenodd" />
        </svg>
        Quay lại
      </a>
    </div>

    <!-- Bộ lọc -->
    <form id="filter-form"
          class="flex flex-wrap gap-6 mb-6 bg-white p-5 rounded-2xl shadow-lg border border-gray-100">
      {% if user.role in ['admin', 'boss', 'quanly'] %}
      <div class="flex-1 min-w-[150px]">
        <label class="block text-sm font-medium mb-1 text-gray-600">Chi nhánh</label>
        <select id="branch-select" name="chi_nhanh"
                onchange="this.form.submit()"
                class="w-full rounded-lg border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
          {% for branch in branches %}
          <option value="{{ branch }}" {% if branch == selected_branch %}selected{% endif %}>
            {{ branch }}
          </option>
          {% endfor %}
        </select>
      </div>
      {% endif %}

      <div class="flex-1 min-w-[120px]">
        <label class="block text-sm font-medium mb-1 text-gray-600">Tháng</label>
        <select id="month-select" name="month"
                onchange="this.form.submit()"
                class="w-full rounded-lg border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
          {% for i in range(1, 13) %}
          <option value="{{ i }}" {% if i == selected_month %}selected{% endif %}>Tháng {{ i }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="flex-1 min-w-[120px]">
        <label class="block text-sm font-medium mb-1 text-gray-600">Năm</label>
        <select id="year-select" name="year"
                onchange="this.form.submit()"
                class="w-full rounded-lg border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
          {% set current_year = selected_year %}
          {% for i in range(current_year - 5, current_year + 3) %}
          <option value="{{ i }}" {% if i == selected_year %}selected{% endif %}>Năm {{ i }}</option>
          {% endfor %}
        </select>
      </div>
    </form>

    <!-- Bảng Chấm Công -->
    <div class="overflow-x-auto bg-white rounded-2xl shadow-lg border border-gray-100">
      <table class="min-w-full text-sm border-collapse border border-gray-200">
        <thead class="bg-gray-100 sticky top-0 z-20 border-b border-gray-200">
          <tr>
            <th class="sticky left-0 bg-gray-100 px-6 py-3 text-left font-semibold text-gray-700 z-30 border-r border-gray-200">
              Nhân viên
            </th>
            {% for day in range(1, num_days + 1) %}
            <th class="px-4 py-3 text-center font-medium text-gray-600 border-r border-gray-200 
                       {% if day % 2 == 0 %}bg-gray-50{% else %}bg-white{% endif %}
                       {% if day == current_day %}bg-indigo-50 text-indigo-700{% endif %}">
              {{ day }}
            </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for code, emp in employee_data.items() %}
          <tr class="border-b border-gray-200 hover:bg-gray-50 transition">
            <td class="sticky left-0 bg-white px-4 py-3 whitespace-nowrap z-10 border-r border-gray-200 group-hover:bg-gray-50">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-medium text-gray-800">
                    {{ emp.name }}
                    {% if emp.worked_away_from_main_branch %}
                      <span class="text-red-500 font-bold" title="Nhân viên có làm việc khác chi nhánh chính trong tháng">*</span>
                    {% endif %}
                  </div>
                  <div class="text-xs text-gray-500">{{ emp.role }}</div>
                </div>
                {% if emp.dashboard_stats %}
                <button onclick="toggleDashboard('{{ code }}')" class="p-1 rounded-full hover:bg-gray-200 transition-colors" title="Xem thống kê">
                    <svg id="arrow-{{ code }}" class="w-4 h-4 text-gray-500 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>
                {% endif %}
              </div>
            </td>
            {% for day in range(1, num_days + 1) %}
              {% set day_data = emp.daily_work.get(day) %}
              {% set cell_class = '' %}
              {% set cell_content = '' %}
              {% set services = day_data.services if day_data else [] %}

              {% if day_data and day_data.work_units > 0 %}
                {% set work_units = day_data.work_units %}
                {% set is_overtime_flag = day_data.is_overtime %}
                {% set overtime_branch = day_data.work_branch if day_data else '' %}

                {# Logic xác định màu nền #}
                {% if work_units > 1.0 or is_overtime_flag %}
                  {% set cell_class = 'bg-yellow-50' %}
                {% elif work_units == 1.0 %}
                  {% set cell_class = 'bg-green-50' %}
                {% else %}
                  {% set cell_class = 'bg-blue-50' %}
                {% endif %}

                {# Logic xác định nội dung ô #}
                {% set cell_content = work_units %}
                {# Chỉ hiển thị chi nhánh làm thêm cho LTTC/BPTC khi ở bộ lọc của họ. Các trường hợp tăng ca khác chỉ được tô màu. #}
                {% if is_overtime_flag and overtime_branch and emp.role_key in ['lttc', 'bptc'] and selected_branch in ['LTTC', 'BPTC'] %}
                  {% set cell_content = '{}<br><span class="text-red-500 text-xs font-semibold">{}</span>'.format(work_units, overtime_branch) %}
                {% endif %}
              {% endif %}
              <td class="px-2 py-2 text-center align-top {{ cell_class }} border-r border-gray-200 min-w-[70px]">
                <div class="text-gray-700" title="{{ services | join(', ') }}">{{ cell_content | safe }}</div>
                {% if services %}
                <div class="text-xs text-indigo-700 mt-1 truncate">{{ services | join(', ') | safe }}</div>
                {% endif %}
              </td>
            {% endfor %}
          </tr>
          {% if emp.dashboard_stats %}
          <tr id="dashboard-{{ code }}" class="hidden bg-gray-50 border-b-2 border-gray-300">
            <td class="sticky left-0 bg-gray-50 p-4 z-10 border-r border-gray-200">
                <div class="overflow-x-auto">
                <div class="flex space-x-4">
                    <div class="bg-blue-100 p-3 rounded-lg shadow-sm flex-shrink-0 w-32 text-center">
                        <p class="text-xs text-blue-700 font-semibold">Số ngày làm</p>
                        <p class="text-2xl font-bold text-blue-800">{{ emp.dashboard_stats.so_ngay_lam }}</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-lg shadow-sm flex-shrink-0 w-32 text-center">
                        <p class="text-xs text-red-700 font-semibold">Số ngày nghỉ</p>
                        <p class="text-2xl font-bold text-red-800">{{ emp.dashboard_stats.so_ngay_nghi }}</p>
                    </div>
                    
                    {% set so_ngay_tang_ca = emp.dashboard_stats.so_ngay_tang_ca %}
                    {% if so_ngay_tang_ca > 0 %}
                    <div class="p-3 rounded-lg shadow-sm transition-colors bg-yellow-100 cursor-pointer hover:bg-yellow-200 flex-shrink-0 w-32 text-center"
                         onclick="showDetails('{{ code }}', 'overtime', '{{ emp.name }}')">
                        <p class="text-xs font-semibold text-yellow-700">Số ngày tăng ca</p>
                        <p class="text-2xl font-bold text-yellow-800">{{ so_ngay_tang_ca }}</p>
                    </div>
                    {% endif %}

                    <div class="bg-green-100 p-3 rounded-lg shadow-sm flex-shrink-0 w-32 text-center">
                        <p class="text-xs text-green-700 font-semibold">Tổng số công</p>
                        <p class="text-2xl font-bold text-green-800">{{ "%.1f"|format(emp.dashboard_stats.tong_so_cong) }}</p>
                    </div>

                    {% if emp.role_key == 'buongphong' or emp.role_key == 'bptc' %}
                        {% set tong_giat = emp.dashboard_stats.tong_dich_vu_giat %}
                        {% if tong_giat > 0 %}
                        <div class="p-3 rounded-lg shadow-sm transition-colors bg-purple-100 cursor-pointer hover:bg-purple-200 flex-shrink-0 w-32 text-center"
                             onclick="showDetails('{{ code }}', 'laundry', '{{ emp.name }}')">
                            <p class="text-xs font-semibold text-purple-700">Đồ giặt</p>
                            <p class="text-2xl font-bold text-purple-800">{{ tong_giat }}</p>
                        </div>
                        {% endif %}

                        {% set tong_ui = emp.dashboard_stats.tong_dich_vu_ui %}
                        {% if tong_ui > 0 %}
                        <div class="p-3 rounded-lg shadow-sm transition-colors bg-fuchsia-100 cursor-pointer hover:bg-fuchsia-200 flex-shrink-0 w-32 text-center"
                             onclick="showDetails('{{ code }}', 'ironing', '{{ emp.name }}')">
                            <p class="text-xs font-semibold text-fuchsia-700">Đồ ủi</p>
                            <p class="text-2xl font-bold text-fuchsia-800">{{ tong_ui }}</p>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
                </div>
            </td>
            <td colspan="{{ num_days }}" class="bg-gray-50">&nbsp;</td>
          </tr>
          {% endif %}
          {% else %}
          <tr>
            <td colspan="{{ num_days + 1 }}" class="text-center py-10 text-gray-500">
              Không có dữ liệu chấm công.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Chú thích -->
    <div class="mt-6 grid grid-cols-3 gap-4 text-sm">
      <div class="flex items-center justify-center gap-2 bg-white p-3 rounded-xl shadow-sm border">
        <span class="w-4 h-4 rounded bg-green-50 border border-gray-300"></span> Đủ công
      </div>
      <div class="flex items-center justify-center gap-2 bg-white p-3 rounded-xl shadow-sm border">
        <span class="w-4 h-4 rounded bg-yellow-50 border border-gray-300"></span> Tăng ca
      </div>
      <div class="flex items-center justify-center gap-2 bg-white p-3 rounded-xl shadow-sm border">
        <span class="w-4 h-4 rounded bg-gray-50 border border-gray-300"></span> Nghỉ / Không dữ liệu
      </div>
    </div>
  </div>

  <!-- Modal for Details -->
  <div id="detailModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 z-50 flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col transform transition-all duration-300 scale-95 opacity-0" id="modal-panel">
        <!-- Header -->
        <div class="flex justify-between items-center p-4 border-b">
            <h3 id="modalTitle" class="text-lg font-semibold text-gray-800">Chi tiết</h3>
            <button onclick="closeDetailModal()" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                <svg class="w-5 h-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <!-- Content -->
        <div class="p-4 overflow-y-auto">
            <table class="min-w-full text-sm">
                <thead id="modalThead" class="bg-gray-50">
                    <!-- Headers will be injected by JS -->
                </thead>
                <tbody id="modalTbody" class="divide-y divide-gray-200">
                    <!-- Rows will be injected by JS -->
                </tbody>
            </table>
        </div>
    </div>
  </div>

  <script>
    function toggleDashboard(code) {
      const dashboardRow = document.getElementById(`dashboard-${code}`);
      const arrowIcon = document.getElementById(`arrow-${code}`);
      if (dashboardRow) {
        const isHidden = dashboardRow.classList.contains('hidden');
        if (isHidden) {
          dashboardRow.classList.remove('hidden');
          arrowIcon.classList.add('rotate-180');
        } else {
          dashboardRow.classList.add('hidden');
          arrowIcon.classList.remove('rotate-180');
        }
      }
    }
  </script>

  <script id="employee-details-data" type="application/json">
    {{ employee_data_for_js | tojson | safe }}
  </script>

  <script>
    let allEmployeeDetails = {};

    document.addEventListener('DOMContentLoaded', () => {
        const dataEl = document.getElementById('employee-details-data');
        if (dataEl) {
            try {
                allEmployeeDetails = JSON.parse(dataEl.textContent);
            } catch (e) {
                console.error("Lỗi parse dữ liệu chi tiết nhân viên:", e);
            }
        }
    });

    function showDetails(employeeCode, dataType, employeeName) {
        const employee = allEmployeeDetails[employeeCode];
        if (!employee || !employee.dashboard_stats) return;

        const modal = document.getElementById('detailModal');
        const modalPanel = document.getElementById('modal-panel');
        const titleEl = document.getElementById('modalTitle');
        const theadEl = document.getElementById('modalThead');
        const tbodyEl = document.getElementById('modalTbody');

        tbodyEl.innerHTML = ''; // Xóa nội dung cũ
        let records = [];
        let headers = [];
        let title = '';
        let rowsHtml = '';

        if (dataType === 'overtime') {
            title = `Chi tiết Tăng ca - ${employeeName}`;
            headers = ['Ngày', 'Giờ', 'Chi nhánh làm', 'Số công'];
            records = employee.dashboard_stats.overtime_details || [];
            rowsHtml = records.map(r => `<tr class="hover:bg-gray-50"><td class="px-4 py-2">${r.date}</td><td class="px-4 py-2">${r.time}</td><td class="px-4 py-2">${r.branch || ''}</td><td class="px-4 py-2">${r.work_units}</td></tr>`).join('');
        } else if (dataType === 'laundry') {
            title = `Chi tiết Đồ giặt - ${employeeName}`;
            headers = ['Ngày', 'Giờ', 'Chi nhánh làm', 'Số phòng', 'Số lượng'];
            records = employee.dashboard_stats.laundry_details || [];
            rowsHtml = records.map(r => `<tr class="hover:bg-gray-50"><td class="px-4 py-2">${r.date}</td><td class="px-4 py-2">${r.time}</td><td class="px-4 py-2">${r.branch || ''}</td><td class="px-4 py-2">${r.room || ''}</td><td class="px-4 py-2">${r.quantity || ''}</td></tr>`).join('');
        } else if (dataType === 'ironing') {
            title = `Chi tiết Đồ ủi - ${employeeName}`;
            headers = ['Ngày', 'Giờ', 'Chi nhánh làm', 'Số phòng', 'Số lượng'];
            records = employee.dashboard_stats.ironing_details || [];
            rowsHtml = records.map(r => `<tr class="hover:bg-gray-50"><td class="px-4 py-2">${r.date}</td><td class="px-4 py-2">${r.time}</td><td class="px-4 py-2">${r.branch || ''}</td><td class="px-4 py-2">${r.room || ''}</td><td class="px-4 py-2">${r.quantity || ''}</td></tr>`).join('');
        }

        titleEl.textContent = title;
        theadEl.innerHTML = `<tr>${headers.map(h => `<th class="px-4 py-2 text-left font-semibold text-gray-600">${h}</th>`).join('')}</tr>`;
        
        if (records.length === 0) {
            tbodyEl.innerHTML = `<tr><td colspan="${headers.length}" class="text-center py-4 text-gray-500">Không có dữ liệu chi tiết.</td></tr>`;
        } else {
            tbodyEl.innerHTML = rowsHtml;
        }

        modal.classList.remove('hidden');
        // Kích hoạt hiệu ứng chuyển động
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modalPanel.classList.remove('scale-95', 'opacity-0');
        }, 10);
    }

    function closeDetailModal() {
        const modal = document.getElementById('detailModal');
        const modalPanel = document.getElementById('modal-panel');
        modal.classList.add('opacity-0');
        modalPanel.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300); // Phải khớp với thời gian transition
    }
  </script>
</body>
</html>
