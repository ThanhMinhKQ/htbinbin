<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết Quả Điểm Danh - {{ user.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        .table-auto th, .table-auto td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
        }
        .table-auto th {
            background-color: #f7fafc;
        }
        .pagination-btn.current {
            background-color: #3b82f6;
            color: white;
        }
        /* For sticky header */
        #results-table {
            max-height: 70vh; /* Adjust height as needed */
            overflow-y: auto;
            position: relative;
        }
        #results-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .sortable .sort-indicator {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            opacity: 0.5;
            font-size: 0.8em;
            color: #6b7280;
            line-height: 1;
        }
        .sortable.asc .sort-indicator, .sortable.desc .sort-indicator {
            opacity: 1;
            color: #2563eb;
        }
        .sortable:hover .sort-indicator {
            opacity: 0.8;
        }
        /* Modal animation */
        #record-modal { transition: opacity 0.2s ease-in-out; }
        #record-modal > div { transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out; }
        #record-modal.hidden > div { transform: translateY(1rem) scale(0.98); opacity: 0; }
        .focus-ring:focus { outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <!-- Header -->
            <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Lịch sử Điểm Danh</h1>
                    {% if user.role not in ['admin', 'boss'] %}
                    <p class="text-gray-600">Các bản ghi do bạn (<strong class="text-blue-600">{{ user.name }}</strong>) thực hiện.</p>
                    {% endif %}
                </div>
                <a href="/choose-function" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition text-sm font-semibold">
                    &#8592; Quay lại
                </a>
            </div>

            <!-- Action Bar -->
            <div class="flex flex-wrap justify-end items-center gap-4 mb-4">
                <div class="flex items-center gap-2">
                    {% if user.role in ['admin', 'boss'] %}
                    <button id="export-attendance-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 text-sm font-semibold flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" /><path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" /></svg>
                        Xuất Excel
                    </button>
                    <button id="open-absence-modal-btn" class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition font-semibold text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>
                        Cập nhật vắng
                    </button>
                    {% endif %}
                </div>
            </div>

            <div id="search-filters" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-4 p-4 border rounded-md bg-gray-50">
                {% if user.role not in ['quanly', 'ktv'] %}
                <div>
                    <label for="filter-type" class="block text-sm font-medium text-gray-700">Loại bản ghi</label>
                    <select id="filter-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        <option value="all" selected>Tất cả</option>
                        <option value="Điểm danh">Điểm danh</option>
                        <option value="Dịch vụ">Chấm Dịch Vụ</option>
                    </select>
                </div>
                {% endif %}
                <div>
                    <label for="filter-date" class="block text-sm font-medium text-gray-700">Ngày</label>
                    <input type="text" id="filter-date" placeholder="dd/mm/yyyy" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                </div>
                {% if user.role in ['admin', 'boss'] %}
                <div class="relative">
                    <label for="filter-nguoi-thuc-hien" class="block text-sm font-medium text-gray-700">Người thực hiện</label>
                    <input type="text" id="filter-nguoi-thuc-hien" placeholder="Tìm theo mã hoặc tên..." autocomplete="off" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    <div id="performer-filter-results" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-40 overflow-y-auto"></div>
                </div>
                {% endif %}
                <div class="relative">
                    <label for="filter-nhan-vien" class="block text-sm font-medium text-gray-700">Nhân viên</label>
                    <input type="text" id="filter-nhan-vien" placeholder="Tìm theo mã hoặc tên..." autocomplete="off" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    <div id="employee-filter-results" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-40 overflow-y-auto"></div>
                </div>
                {% if user.role not in ['quanly', 'ktv'] %}
                <div id="container-filter-chuc-vu" class="w-full">
                    <label for="filter-chuc-vu" class="block text-sm font-medium text-gray-700">Chức vụ</label>
                    <select id="filter-chuc-vu" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        <option value="">Tất cả</option>
                        {% if user.role in ['admin', 'boss'] %}
                            {% for role_key, role_name in roles.items() if role_key not in ['admin', 'boss'] %}
                            <option value="{{ role_name }}">{{ role_name }}</option>
                            {% endfor %}
                        {% elif user.role == 'letan' %}
                            {% for role_key, role_name in roles.items() if role_key in ['letan', 'buongphong', 'baove'] %}
                            <option value="{{ role_name }}">{{ role_name }}</option>
                            {% endfor %}
                        {% else %}
                            {% for role_key, role_name in roles.items() %}
                            <option value="{{ role_name }}">{{ role_name }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <div>
                    <label for="filter-cn-lam" class="block text-sm font-medium text-gray-700">CN Làm</label>
                    <select id="filter-cn-lam" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        <option value="">Tất cả</option>
                        {% for branch in branches %}
                        <option value="{{ branch }}">{{ branch }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="container-filter-tang-ca">
                    <label for="filter-tang-ca" class="block text-sm font-medium text-gray-700">Tăng ca</label>
                    <select id="filter-tang-ca" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        <option value="all">Tất cả</option>
                        <option value="yes">Có</option>
                        <option value="no">Không</option>
                    </select>
                </div>
                <div id="container-filter-dich-vu" style="display: none;">
                    <label for="filter-dich-vu" class="block text-sm font-medium text-gray-700">Dịch vụ</label>
                    <select id="filter-dich-vu" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        <option value="">Tất cả</option>
                        <option value="Giặt">Giặt</option>
                        <option value="Ủi">Ủi</option>
                    </select>
                </div>
                <div id="container-filter-so-phong" style="display: none;">
                    <label for="filter-so-phong" class="block text-sm font-medium text-gray-700">Số phòng</label>
                    <input type="text" id="filter-so-phong" placeholder="Tìm theo số phòng..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                </div>
                {% endif %} {# End if not quanly/ktv #}
                <div id="container-filter-so-cong">
                    <label for="filter-so-cong" class="block text-sm font-medium text-gray-700">Số công</label>
                    <select id="filter-so-cong" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div>
                    <label for="filter-ghi-chu" class="block text-sm font-medium text-gray-700">Ghi chú</label>
                    <input type="text" id="filter-ghi-chu" placeholder="Tìm trong ghi chú..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                </div>
                <div class="col-span-full flex items-center justify-start gap-3 pt-2">
                    <div class="flex items-center gap-3">
                        <button id="apply-filters" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm font-medium">
                            Lọc kết quả
                        </button>
                        <button id="clear-filters" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition text-sm">
                            Xóa bộ lọc
                        </button>
                    </div>
                </div>
            </div>

            <div class="my-4 flex justify-between items-center gap-4">
                <!-- Left side: Delete button, Per-page select, and Record count -->
                <div class="flex items-center gap-4">
                    {% if user.role in ['admin', 'boss'] %}
                    <button id="delete-selected-btn" class="hidden px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition font-semibold text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        Xóa mục đã chọn
                    </button>
                    {% endif %}
                    <div class="flex items-center gap-2">
                        <label for="per-page-select" class="text-sm font-medium text-gray-700 whitespace-nowrap">Hiển thị:</label>
                        <select id="per-page-select" class="block rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2 pl-3 pr-8 text-sm">
                            <option value="100">100</option>
                            <option value="500">500</option>
                            <option value="1000">1000</option>
                        </select>
                    </div>
                    <p id="record-count" class="text-sm text-gray-600 font-medium"></p>
                </div>

                <!-- Center: Pagination controls -->
                <div id="pagination-controls" class="flex justify-center items-center gap-1">
                    <!-- Pagination buttons will be generated here -->
                </div>

                <!-- Right side: Add button -->
                <div>
                    {% if user.role in ['admin', 'boss'] %}
                    <button id="add-record-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition font-semibold text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Thêm bản ghi
                    </button>
                    {% endif %}
                </div>
            </div>

            <div id="loading" class="text-center py-10">
                <p class="text-gray-500">Đang tải dữ liệu, vui lòng chờ...</p>
            </div>

            <div id="error" class="hidden text-center py-10 bg-red-100 text-red-700 rounded-md">
                <p>Có lỗi xảy ra khi tải dữ liệu. Vui lòng thử lại.</p>
            </div>

            <div id="results-table" class="hidden overflow-x-auto">
                <table class="min-w-full table-auto text-sm text-left text-gray-700">
                    <thead id="results-thead" class="bg-gray-50 text-xs text-gray-700 uppercase">
                        <!-- Headers will be generated here by JavaScript -->
                    </thead>
                    <tbody id="results-tbody" class="bg-white">
                        <!-- Dữ liệu sẽ được chèn vào đây bằng JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit Record -->
    <div id="record-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm">
        <div class="relative w-full max-w-2xl bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-h-[90vh] flex flex-col animate-fadeIn">
            <!-- Header -->
            <div class="flex items-center justify-between p-5 border-b border-slate-200 dark:border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="grid place-items-center w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/50">
                        <svg class="w-5 h-5 text-blue-600 dark:text-blue-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                    </div>
                    <h3 id="modal-title" class="text-lg font-semibold text-slate-800 dark:text-white">Thêm bản ghi mới</h3>
                </div>
                <button id="modal-close-btn" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <!-- Form -->
            <form id="record-form" class="p-5 space-y-5 overflow-y-auto">
                <input type="hidden" id="modal-record-id" name="record_id">
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div id="modal-type-selector-container">
                        <label for="modal-record-type" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Loại bản ghi <span class="text-rose-500">*</span></label>
                        <select id="modal-record-type" name="record_type" class="w-full py-2.5 px-4 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="attendance">Điểm danh</option>
                            <option value="service">Dịch vụ</option>
                        </select>
                    </div>
                    <div id="modal-performer-container" class="relative">
                        <label for="modal-nguoi-thuc-hien-search" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Người thực hiện <span class="text-rose-500">*</span></label>
                        <input type="text" id="modal-nguoi-thuc-hien-search" placeholder="Tìm theo mã hoặc tên..." autocomplete="off" class="w-full py-2.5 px-4 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <input type="hidden" id="modal-nguoi-thuc-hien-code" name="nguoi_thuc_hien">
                        <div id="performer-search-results" class="hidden absolute z-20 mt-1 w-full bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-lg max-h-48 overflow-y-auto"></div>
                    </div>
                    <div class="relative">
                        <label for="modal-ma-nv-search" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Nhân viên <span class="text-rose-500">*</span></label>
                        <input type="text" id="modal-ma-nv-search" placeholder="Tìm theo mã hoặc tên..." autocomplete="off" class="w-full py-2.5 px-4 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <input type="hidden" id="modal-ma-nv" name="ma_nv">
                        <div id="employee-search-results" class="hidden absolute z-20 mt-1 w-full bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-lg max-h-48 overflow-y-auto"></div>
                    </div>
                    <div>
                        <label for="modal-thoi-gian" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Thời gian <span class="text-rose-500">*</span></label>
                        <input type="text" id="modal-thoi-gian" name="thoi_gian" required placeholder="dd/mm/yyyy HH:MM" class="w-full py-2.5 px-4 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div id="modal-cn-lam-container">
                        <label for="modal-chi-nhanh-lam" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Chi nhánh làm <span class="text-rose-500">*</span></label>
                        <select id="modal-chi-nhanh-lam" name="chi_nhanh_lam" required class="w-full py-2.5 px-4 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="" disabled selected>-- Chọn chi nhánh --</option>
                            {% for branch in branches %}
                            <option value="{{ branch }}">{{ branch }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="modal-tang-ca-container" class="flex items-end pb-2">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="modal-la-tang-ca" name="la_tang_ca" class="h-4 w-4 rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-500">
                            <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Tăng ca</span>
                        </label>
                    </div>
                </div>

                <!-- Attendance-specific fields -->
                <fieldset id="modal-attendance-fields" class="border-t border-slate-200 dark:border-slate-700 pt-4">
                    <legend class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">Thông tin điểm danh</legend>
                    <div>
                        <label for="modal-so-cong-nv" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Số công <span class="text-rose-500">*</span></label>
                        <input type="number" step="0.5" min="0.5" id="modal-so-cong-nv" name="so_cong_nv" value="1" class="w-full py-2.5 px-4 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                </fieldset>

                <!-- Service-specific fields -->
                <fieldset id="modal-service-fields" class="hidden border-t border-slate-200 dark:border-slate-700 pt-4">
                    <legend class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">Thông tin dịch vụ</legend>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="modal-dich-vu" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Dịch vụ <span class="text-rose-500">*</span></label>
                            <select id="modal-dich-vu" name="dich_vu" class="w-full py-2.5 px-4 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                <option value="" disabled selected>Chọn dịch vụ</option>
                                <option value="Giặt">Giặt</option>
                                <option value="Ủi">Ủi</option>
                            </select>
                        </div>
                        <div>
                            <label for="modal-so-phong" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Số phòng <span class="text-rose-500">*</span></label>
                            <input type="text" id="modal-so-phong" name="so_phong" placeholder="VD: 201, 202" class="w-full py-2.5 px-4 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                        <div>
                            <label for="modal-so-luong" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Số lượng <span class="text-rose-500">*</span></label>
                            <input type="text" id="modal-so-luong" name="so_luong" placeholder="VD: 2" class="w-full py-2.5 px-4 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                    </div>
                </fieldset>

                <div>
                    <label for="modal-ghi-chu" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Ghi chú</label>
                    <textarea id="modal-ghi-chu" name="ghi_chu" rows="2" class="w-full py-2.5 px-4 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></textarea>
                </div>
            </form>
            <!-- Footer with buttons -->
            <div class="p-5 border-t border-slate-200 dark:border-slate-700 flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
                <button type="button" id="modal-cancel-btn" class="px-5 py-2.5 text-center text-sm font-semibold text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors">Hủy</button>
                <button type="submit" id="modal-submit-btn" form="record-form" class="w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-white bg-blue-600 rounded-xl hover:bg-blue-700 active:bg-blue-800 transition-colors shadow-lg shadow-blue-500/20">Lưu lại</button>
            </div>
        </div>
    </div>

    <!-- Modal for Absence Check -->
    {% if user.role in ['admin', 'boss'] %}
    <div id="absence-check-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 class="text-xl font-bold text-gray-900">Cập nhật điểm danh vắng</h3>
                <button id="absence-modal-close-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <div class="mt-4">
                <p class="text-sm text-gray-600">Chọn ngày để chạy lại tác vụ ghi nhận nhân viên vắng mặt cho ngày đó.</p>
                <p class="text-sm text-gray-600 mt-1"><strong>Lưu ý:</strong> Thao tác này sẽ xóa và tạo lại các bản ghi "Nghỉ" do hệ thống tự động tạo cho ngày đã chọn.</p>
                <div class="mt-4 flex items-center gap-4">
                    <input type="text" id="absence-check-date" placeholder="dd/mm/yyyy" class="block w-full sm:w-auto rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <button id="run-absence-check-btn" class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition font-semibold text-sm disabled:opacity-50 disabled:cursor-not-allowed">Chạy cập nhật</button>
                </div>
                <p id="absence-check-status" class="mt-2 text-sm font-bold"></p>
            </div>
        </div>
    </div>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userRole = '{{ user.role }}';
            const isAdminOrBoss = userRole === 'admin' || userRole === 'boss';

            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const tableEl = document.getElementById('results-table');
            const tbodyEl = document.getElementById('results-tbody');
            const theadEl = document.getElementById('results-thead');
            const searchFiltersEl = document.getElementById('search-filters');

            // Modal elements
            const recordModal = document.getElementById('record-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const recordForm = document.getElementById('record-form');
            const addRecordBtn = document.getElementById('add-record-btn');
    
            // Filter controls
            const applyFiltersBtn = document.getElementById('apply-filters');
            const clearFiltersBtn = document.getElementById('clear-filters');
            const filterTypeEl = document.getElementById('filter-type');
            const filterDateEl = document.getElementById('filter-date');
            const filterNhanVienEl = document.getElementById('filter-nhan-vien');
                const employeeFilterResults = document.getElementById('employee-filter-results');
            const filterChucVuEl = document.getElementById('filter-chuc-vu');
            const filterCnLamEl = document.getElementById('filter-cn-lam');
            const filterSoCongEl = document.getElementById('filter-so-cong');
            const filterTangCaEl = document.getElementById('filter-tang-ca');
            const filterGhiChuEl = document.getElementById('filter-ghi-chu');
            const filterNguoiThucHienEl = document.getElementById('filter-nguoi-thuc-hien');
            const performerFilterResults = document.getElementById('performer-filter-results');

            const deleteSelectedBtn = document.getElementById('delete-selected-btn');

            const containerSoCong = document.getElementById('container-filter-so-cong');
            // containerTangCa và containerChucVu không được sử dụng, có thể xóa
            const containerTangCa = document.getElementById('container-filter-tang-ca');
            const containerChucVu = document.getElementById('container-filter-chuc-vu');
            const containerDichVu = document.getElementById('container-filter-dich-vu');
            const containerSoPhong = document.getElementById('container-filter-so-phong');
    
            let allRecords = [];
            let lastCheckedCheckbox = null;
            let currentSortBy = 'thoi_gian';
            let currentSortOrder = 'desc';

            // Cờ để đảm bảo listener chỉ được gắn một lần
            let listenersAttached = false;

    
            function fetchData() {
                loadingEl.classList.remove('hidden');
                tableEl.classList.add('hidden');
                errorEl.classList.add('hidden');

                const queryString = buildQueryString();

                fetch(`/api/attendance/results-by-checker?${queryString}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(handleData)
                    .catch(handleError);
            }
    
            let currentPage = 1;
            let recordsPerPage = parseInt(localStorage.getItem('recordsPerPage')) || 100;
            const perPageSelect = document.getElementById('per-page-select');

            if (perPageSelect) {
                perPageSelect.value = recordsPerPage;
                perPageSelect.addEventListener('change', () => {
                    recordsPerPage = parseInt(perPageSelect.value, 10);
                    localStorage.setItem('recordsPerPage', recordsPerPage);
                    currentPage = 1; // Reset to first page when changing page size
                    fetchData();
                });
            }
    
            function buildQueryString() {
                const params = new URLSearchParams();
                params.append('page', currentPage);
                params.append('per_page', recordsPerPage);

                params.append('sort_by', currentSortBy);
                params.append('sort_order', currentSortOrder);

                const filterType = filterTypeEl ? filterTypeEl.value : 'all';
                if (filterType && filterType !== 'all') params.append('filter_type', filterType);
                
                if (filterDateEl.value) {
                    const dateValue = filterDateEl.value.trim();
                    const parts = dateValue.split('/');
                    // Convert d/m/Y to YYYY-MM-DD for API
                    if (parts.length === 3 && parts[2] && parts[2].length === 4) {
                        const [d, m, y] = parts;
                        params.append('filter_date', `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`);
                    }
                }
                if (filterNhanVienEl && filterNhanVienEl.value) params.append('filter_nhan_vien', filterNhanVienEl.value.trim());
                if (filterChucVuEl && filterChucVuEl.value) params.append('filter_chuc_vu', filterChucVuEl.value);
                if (filterCnLamEl && filterCnLamEl.value) params.append('filter_cn_lam', filterCnLamEl.value.trim());
                if (filterSoCongEl.value) params.append('filter_so_cong', filterSoCongEl.value);
                if (filterTangCaEl && filterTangCaEl.value && filterTangCaEl.value !== 'all') params.append('filter_tang_ca', filterTangCaEl.value);
                if (filterGhiChuEl.value) params.append('filter_ghi_chu', filterGhiChuEl.value.trim());

                const filterDichVuEl = document.getElementById('filter-dich-vu');
                const filterSoPhongEl = document.getElementById('filter-so-phong');
                if (filterDichVuEl && filterDichVuEl.value) params.append('filter_dich_vu', filterDichVuEl.value.trim());
                if (filterSoPhongEl && filterSoPhongEl.value) params.append('filter_so_phong', filterSoPhongEl.value.trim());

                if (isAdminOrBoss && filterNguoiThucHienEl && filterNguoiThucHienEl.value) {
                    params.append('filter_nguoi_thuc_hien', filterNguoiThucHienEl.value.trim());
                }

                return params.toString();
            }
    
            function toggleFilterVisibility() {
                const selectedType = filterTypeEl ? filterTypeEl.value : 'all';
                if (selectedType === 'Dịch vụ') {
                    if (containerSoCong) containerSoCong.style.display = 'none';
                    if (containerChucVu) containerChucVu.style.display = 'none';
                    if (containerDichVu) containerDichVu.style.display = 'block';
                    if (containerSoPhong) containerSoPhong.style.display = 'block';
                } else {
                    if (containerSoCong) containerSoCong.style.display = 'block';
                    if (containerChucVu) containerChucVu.style.display = 'block';
                    if (containerDichVu) containerDichVu.style.display = 'none';
                    if (containerSoPhong) containerSoPhong.style.display = 'none';
                }
            }
    
            function updateSelectAllCheckboxState() {
                const selectAllCheckbox = document.getElementById('select-all-checkbox');
                if (!selectAllCheckbox) return;

                const rowCheckboxes = tbodyEl.querySelectorAll('.row-checkbox');
                const totalRows = rowCheckboxes.length;
                if (totalRows === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                    return;
                }

                const checkedRows = tbodyEl.querySelectorAll('.row-checkbox:checked').length;

                if (checkedRows === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else if (checkedRows < totalRows) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                } else { // checkedRows === totalRows
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                }
            }
    
            function updateDeleteButtonState() {
                if (!isAdminOrBoss || !deleteSelectedBtn) return;
                const selectedCheckboxes = tbodyEl.querySelectorAll('.row-checkbox:checked');
                if (selectedCheckboxes.length > 0) {
                    deleteSelectedBtn.classList.remove('hidden');
                } else {
                    deleteSelectedBtn.classList.add('hidden');
                }
            }
    
            // Hàm này sẽ được gọi một lần duy nhất để gắn các listener tĩnh
            function setupCheckboxListeners() {
                const selectAllCheckbox = document.getElementById('select-all-checkbox');
                if (selectAllCheckbox) {
                    selectAllCheckbox.addEventListener('change', (e) => {
                        const isChecked = e.target.checked;
                        lastCheckedCheckbox = null; // Reset shift-click state
                        tbodyEl.querySelectorAll('.row-checkbox').forEach(checkbox => {
                            checkbox.checked = isChecked;
                        });
                        selectAllCheckbox.indeterminate = false;
                        updateDeleteButtonState();
                    });
                }

                // Sử dụng event delegation cho tbody
                tbodyEl.addEventListener('click', (e) => {
                    if (e.target.tagName === 'INPUT' && e.target.classList.contains('row-checkbox')) {
                        const checkbox = e.target;

                        if (e.shiftKey && lastCheckedCheckbox && lastCheckedCheckbox !== checkbox) {
                            const checkboxes = Array.from(tbodyEl.querySelectorAll('.row-checkbox'));
                            const start = checkboxes.indexOf(lastCheckedCheckbox);
                            const end = checkboxes.indexOf(checkbox);

                            const rangeStart = Math.min(start, end);
                            const rangeEnd = Math.max(start, end);
                            const isChecked = checkbox.checked;
                            for (let i = rangeStart; i <= rangeEnd; i++) {
                                checkboxes[i].checked = isChecked;
                            }
                        } else {
                            lastCheckedCheckbox = checkbox;
                        }
                        updateDeleteButtonState();
                        updateSelectAllCheckboxState();
                    }
                });
            }
    
            if (deleteSelectedBtn) {
                deleteSelectedBtn.addEventListener('click', () => {
                    const selected = [];
                    tbodyEl.querySelectorAll('.row-checkbox:checked').forEach(checkbox => {
                        selected.push({
                            id: parseInt(checkbox.dataset.id, 10),
                            type: checkbox.dataset.type
                        });
                    });

                    if (selected.length === 0) {
                        alert('Vui lòng chọn ít nhất một bản ghi để xóa.');
                        return;
                    }

                    if (confirm(`Bạn có chắc chắn muốn xóa ${selected.length} bản ghi đã chọn không?`)) {
                        fetch('/api/attendance/records/batch-delete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ records: selected })
                        }).then(res => res.ok ? res.json() : res.json().then(err => Promise.reject(err)))
                        .then(data => {
                            if (data.status === 'success') {
                                alert(`Đã xóa thành công ${data.deleted_count} bản ghi.`);
                                fetchData();
                            } else {
                                throw new Error(data.detail || 'Lỗi không xác định');
                            }
                        }).catch(err => alert(`Lỗi khi xóa hàng loạt: ${err.message || 'Lỗi server'}`));
                    }
                });
            }
    
            function setupSoCongFilter() {
                const filterType = filterTypeEl ? filterTypeEl.value : 'all';
                filterSoCongEl.innerHTML = '<option value="">Tất cả</option>'; // Default option

                const options = ['0', '0.5', '1', '1.5', '2'];
                containerSoCong.style.display = 'block';

                options.forEach(opt => {
                    const optionEl = document.createElement('option');
                    optionEl.value = opt;
                    optionEl.textContent = opt;
                    filterSoCongEl.appendChild(optionEl);
                });
            }
    
    
            function renderTable(records) {
                let headersHtml = '';
                let rowsHtml = '';

                const currentFilter = filterTypeEl ? filterTypeEl.value : 'all';

                if (currentFilter === 'Điểm danh') {
                    headersHtml = `<tr>
                        ${isAdminOrBoss ? '<th><input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"></th>' : ''}
                        <th class="px-4 py-3 sortable" data-sort="thoi_gian">Ngày<span class="sort-indicator"></span></th><th class="px-4 py-3">Giờ</th>${isAdminOrBoss ? '<th class="px-4 py-3 sortable" data-sort="nguoi_thuc_hien">Người thực hiện<span class="sort-indicator"></span></th>' : ''}<th class="px-4 py-3 sortable" data-sort="ma_nv">Mã NV<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="ten_nv">Tên NV<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="chuc_vu">Chức vụ<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="chi_nhanh_lam">CN Làm<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="la_tang_ca">Tăng ca<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="so_cong">Số công<span class="sort-indicator"></span></th><th class="px-4 py-3">Ghi chú</th>${isAdminOrBoss ? '<th class="px-4 py-3">Hành động</th>' : ''}</tr>`;
                    records.forEach((rec, index) => {
                        const [ngay, gio] = rec.thoi_gian.split(' ');
                        const checkboxHtml = isAdminOrBoss ? `<td class="px-4 py-2"><input type="checkbox" class="row-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-id="${rec.id}" data-type="attendance"></td>` : '';
                        const nguoiThucHienHtml = isAdminOrBoss ? `<td class="px-4 py-2">${rec.nguoi_thuc_hien || ''}</td>` : '';
                        const actionsHtml = isAdminOrBoss ? `<td class="px-4 py-2 whitespace-nowrap"><button class="edit-btn text-blue-600 hover:underline mr-2" data-id="${rec.id}" data-type="attendance">Sửa</button><button class="delete-btn text-red-600 hover:underline" data-id="${rec.id}" data-type="attendance">Xóa</button></td>` : '';
                        const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                        rowsHtml += `<tr class="border-b ${rowClass} hover:bg-blue-100" data-record='${JSON.stringify(rec)}'>${checkboxHtml}<td class="px-4 py-2">${ngay||''}</td><td class="px-4 py-2">${gio||''}</td>${nguoiThucHienHtml}<td class="px-4 py-2 font-medium text-gray-900">${rec.ma_nv||''}</td><td class="px-4 py-2">${rec.ten_nv||''}</td><td class="px-4 py-2">${rec.chuc_vu||'Không rõ'}</td><td class="px-4 py-2">${rec.chi_nhanh_lam||''}</td><td class="px-4 py-2">${rec.tang_ca ? 'Có' : 'Không'}</td><td class="px-4 py-2">${rec.so_cong}</td><td class="px-4 py-2">${rec.ghi_chu||''}</td>${actionsHtml}</tr>`;
                    });
                } else if (currentFilter === 'Dịch vụ') {
                    headersHtml = `<tr>
                        ${isAdminOrBoss ? '<th><input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"></th>' : ''}
                        <th class="px-4 py-3 sortable" data-sort="thoi_gian">Ngày<span class="sort-indicator"></span></th><th class="px-4 py-3">Giờ</th>${isAdminOrBoss ? '<th class="px-4 py-3 sortable" data-sort="nguoi_thuc_hien">Người thực hiện<span class="sort-indicator"></span></th>' : ''}<th class="px-4 py-3 sortable" data-sort="ma_nv">Mã NV<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="ten_nv">Tên NV<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="chuc_vu">Chức vụ<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="chi_nhanh_lam">CN Làm<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="la_tang_ca">Tăng ca<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="dich_vu">Dịch vụ<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="so_phong">Số phòng<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="so_luong">Số lượng<span class="sort-indicator"></span></th><th class="px-4 py-3">Ghi chú</th>${isAdminOrBoss ? '<th class="px-4 py-3">Hành động</th>' : ''}</tr>`;
                    records.forEach((rec, index) => {
                        const [ngay, gio] = rec.thoi_gian.split(' ');
                        const checkboxHtml = isAdminOrBoss ? `<td class="px-4 py-2"><input type="checkbox" class="row-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-id="${rec.id}" data-type="service"></td>` : '';
                        const nguoiThucHienHtml = isAdminOrBoss ? `<td class="px-4 py-2">${rec.nguoi_thuc_hien || ''}</td>` : '';
                        const actionsHtml = isAdminOrBoss ? `<td class="px-4 py-2 whitespace-nowrap"><button class="edit-btn text-blue-600 hover:underline mr-2" data-id="${rec.id}" data-type="service">Sửa</button><button class="delete-btn text-red-600 hover:underline" data-id="${rec.id}" data-type="service">Xóa</button></td>` : '';
                        const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                        rowsHtml += `<tr class="border-b ${rowClass} hover:bg-blue-100" data-record='${JSON.stringify(rec)}'>${checkboxHtml}<td class="px-4 py-2">${ngay||''}</td><td class="px-4 py-2">${gio||''}</td>${nguoiThucHienHtml}<td class="px-4 py-2 font-medium text-gray-900">${rec.ma_nv||''}</td><td class="px-4 py-2">${rec.ten_nv||''}</td><td class="px-4 py-2">${rec.chuc_vu||'Không rõ'}</td><td class="px-4 py-2">${rec.chi_nhanh_lam||''}</td><td class="px-4 py-2">${rec.tang_ca ? 'Có' : 'Không'}</td><td class="px-4 py-2">${rec.dich_vu||''}</td><td class="px-4 py-2">${rec.so_phong||''}</td><td class="px-4 py-2">${rec.so_luong||''}</td><td class="px-4 py-2">${rec.ghi_chu||''}</td>${actionsHtml}</tr>`;
                    });
                } else { // 'all'
                    headersHtml = `<tr>
                        ${isAdminOrBoss ? '<th><input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"></th>' : ''}
                        <th class="px-4 py-3 sortable" data-sort="type">Loại<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="thoi_gian">Ngày<span class="sort-indicator"></span></th><th class="px-4 py-3">Giờ</th>${isAdminOrBoss ? '<th class="px-4 py-3 sortable" data-sort="nguoi_thuc_hien">Người thực hiện<span class="sort-indicator"></span></th>' : ''}<th class="px-4 py-3 sortable" data-sort="ma_nv">Mã NV<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="ten_nv">Tên NV<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="chuc_vu">Chức vụ<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="chi_nhanh_lam">CN Làm<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="la_tang_ca">Tăng ca<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="so_cong">Số công<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="dich_vu">Dịch vụ<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="so_phong">Số phòng<span class="sort-indicator"></span></th><th class="px-4 py-3 sortable" data-sort="so_luong">Số lượng<span class="sort-indicator"></span></th><th class="px-4 py-3">Ghi chú</th>${isAdminOrBoss ? '<th class="px-4 py-3">Hành động</th>' : ''}</tr>`;
                    records.forEach((rec, index) => {
                        const [ngay, gio] = rec.thoi_gian.split(' ');
                        const isService = rec.type === 'Dịch vụ';
                        const recordType = isService ? 'service' : 'attendance';
                        const checkboxHtml = isAdminOrBoss ? `<td class="px-4 py-2"><input type="checkbox" class="row-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-id="${rec.id}" data-type="${recordType}"></td>` : '';
                        const nguoiThucHienHtml = isAdminOrBoss ? `<td class="px-4 py-2">${rec.nguoi_thuc_hien || ''}</td>` : '';
                        const actionsHtml = isAdminOrBoss ? `<td class="px-4 py-2 whitespace-nowrap"><button class="edit-btn text-blue-600 hover:underline mr-2" data-id="${rec.id}" data-type="${recordType}">Sửa</button><button class="delete-btn text-red-600 hover:underline" data-id="${rec.id}" data-type="${recordType}">Xóa</button></td>` : '';
                        const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                        rowsHtml += `
                            <tr class="border-b ${rowClass} hover:bg-blue-100" data-record='${JSON.stringify(rec)}'>
                                ${checkboxHtml}
                                <td class="px-4 py-2 font-semibold ${isService ? 'text-green-600' : 'text-blue-600'}">${rec.type}</td>
                                <td class="px-4 py-2">${ngay||''}</td>
                                <td class="px-4 py-2">${gio||''}</td>
                                ${nguoiThucHienHtml}
                                <td class="px-4 py-2 font-medium text-gray-900">${rec.ma_nv||''}</td>
                                <td class="px-4 py-2">${rec.ten_nv||''}</td>
                                <td class="px-4 py-2">${rec.chuc_vu||'Không rõ'}</td>
                                <td class="px-4 py-2">${rec.chi_nhanh_lam||''}</td>
                                <td class="px-4 py-2">${rec.tang_ca ? 'Có' : 'Không'}</td>
                                <td class="px-4 py-2">${rec.so_cong != null ? rec.so_cong : ''}</td>
                                <td class="px-4 py-2">${rec.dich_vu || ''}</td>
                                <td class="px-4 py-2">${rec.so_phong || ''}</td>
                                <td class="px-4 py-2">${rec.so_luong || ''}</td>
                                <td class="px-4 py-2">${rec.ghi_chu || ''}</td>
                                ${actionsHtml}
                            </tr>
                        `;
                    });
                }

                theadEl.innerHTML = headersHtml;
                tbodyEl.innerHTML = rowsHtml;

                if (records.length === 0) {
                    const colspan = theadEl.querySelector('tr')?.children.length || 9;
                    tbodyEl.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-6 text-gray-500">Không có dữ liệu cho bộ lọc này.</td></tr>`;
                } else {
                    lastCheckedCheckbox = null; // Reset for new table render
                }
            }
    
            function renderPagination(currentPageNum, totalPages, totalRecords) {
                const paginationEl = document.getElementById('pagination-controls');
                const recordCountEl = document.getElementById('record-count');
                paginationEl.innerHTML = '';

                if (totalRecords === 0) {
                    recordCountEl.textContent = 'Không có bản ghi nào.';
                    return;
                }

                recordCountEl.textContent = `Hiển thị ${allRecords.length} trên tổng số ${totalRecords} bản ghi.`;

                if (totalPages <= 1) return;

                const createButton = (text, page, isDisabled = false, isCurrent = false) => {
                    const button = document.createElement('button');
                    button.textContent = text;
                    button.dataset.page = page;
                    let baseClasses = 'px-3 py-1 rounded-md border text-sm font-medium transition';
                    if (isCurrent) {
                        button.className = `${baseClasses} bg-blue-600 text-white border-blue-600 cursor-default`;
                        button.disabled = true;
                    } else if (isDisabled) {
                        button.className = `${baseClasses} bg-gray-100 text-gray-400 border-gray-300 cursor-not-allowed`;
                        button.disabled = true;
                    } else {
                        button.className = `${baseClasses} bg-white border-gray-300 hover:bg-gray-50`;
                        button.addEventListener('click', () => {
                            currentPage = page;
                            fetchData();
                        });
                    }
                    return button;
                };

                paginationEl.appendChild(createButton('<<', 1, currentPageNum === 1));
                paginationEl.appendChild(createButton('<', currentPageNum - 1, currentPageNum === 1));

                let startPage, endPage;
                if (totalPages <= 7) {
                    startPage = 1; endPage = totalPages;
                } else {
                    if (currentPageNum <= 4) { startPage = 1; endPage = 5; }
                    else if (currentPageNum + 3 >= totalPages) { startPage = totalPages - 4; endPage = totalPages; }
                    else { startPage = currentPageNum - 2; endPage = currentPageNum + 2; }
                }

                if (startPage > 1) {
                    paginationEl.appendChild(createButton('1', 1));
                    if (startPage > 2) paginationEl.insertAdjacentHTML('beforeend', `<span class="px-3 py-1 text-sm">...</span>`);
                }

                for (let i = startPage; i <= endPage; i++) {
                    paginationEl.appendChild(createButton(i, i, false, i === currentPageNum));
                }

                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) paginationEl.insertAdjacentHTML('beforeend', `<span class="px-3 py-1 text-sm">...</span>`);
                    paginationEl.appendChild(createButton(totalPages, totalPages));
                }

                paginationEl.appendChild(createButton('>', currentPageNum + 1, currentPageNum === totalPages));
                paginationEl.appendChild(createButton('>>', totalPages, currentPageNum === totalPages));
            }
    
            function handleData(data) {
                lastCheckedCheckbox = null; // Reset on new data
                loadingEl.classList.add('hidden');
                if (data && data.records && data.records.length > 0) {
                    tableEl.classList.remove('hidden');
                    allRecords = data.records;
                    renderTable(data.records);                    
                    renderPagination(data.currentPage, data.totalPages, data.totalRecords);
                } else {
                    tbodyEl.innerHTML = `<tr><td colspan="15" class="text-center py-6 text-gray-500">Không có dữ liệu.</td></tr>`;
                    document.getElementById('pagination-controls').innerHTML = '';
                    document.getElementById('record-count').textContent = 'Không có bản ghi nào.';
                }
                // Sau khi render bảng lần đầu, cập nhật trạng thái các checkbox
                if (isAdminOrBoss) {
                    updateDeleteButtonState();
                    updateSelectAllCheckboxState();
                }
            }
    
            function handleError(error) {
                console.error('Error fetching attendance data:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
            }
    
            applyFiltersBtn.addEventListener('click', () => {
                currentPage = 1;
                fetchData();
            });

            clearFiltersBtn.addEventListener('click', () => {
                filterDateEl.value = '';
                if (filterNhanVienEl) filterNhanVienEl.value = '';
                if (filterChucVuEl) filterChucVuEl.selectedIndex = 0;
                if (filterCnLamEl) filterCnLamEl.value = '';
                filterSoCongEl.value = '';
                if (filterTangCaEl) filterTangCaEl.value = 'all';
                if (filterGhiChuEl) filterGhiChuEl.value = '';
                if (isAdminOrBoss) {
                    filterNguoiThucHienEl.value = '';
                }
                if (filterTypeEl) {
                    filterTypeEl.value = 'all';
                }
                const filterDichVuEl = document.getElementById('filter-dich-vu');
                const filterSoPhongEl = document.getElementById('filter-so-phong');
                if (filterDichVuEl) filterDichVuEl.value = '';
                if (filterSoPhongEl) filterSoPhongEl.value = '';

                currentPage = 1;
                fetchData();
            });
    
            if (filterTypeEl) {
                filterTypeEl.addEventListener('change', () => {
                    currentPage = 1;
                    toggleFilterVisibility();
                    fetchData();
                });
            }
    
            // --- Modal Logic ---
            if (isAdminOrBoss) {
                // --- Absence Check Modal Logic ---
                const openAbsenceModalBtn = document.getElementById('open-absence-modal-btn');
                const absenceCheckModal = document.getElementById('absence-check-modal');
                const absenceModalCloseBtn = document.getElementById('absence-modal-close-btn');
                const runAbsenceBtn = document.getElementById('run-absence-check-btn');
                const absenceDateInput = document.getElementById('absence-check-date');
                const absenceStatusEl = document.getElementById('absence-check-status');
    
                if (openAbsenceModalBtn) {
                    openAbsenceModalBtn.addEventListener('click', () => absenceCheckModal.classList.remove('hidden'));
                }
                if (absenceModalCloseBtn) {
                    absenceModalCloseBtn.addEventListener('click', () => absenceCheckModal.classList.add('hidden'));
                }
                if (runAbsenceBtn) {
                    runAbsenceBtn.addEventListener('click', function() {
                        const dateValue = absenceDateInput.value.trim();
                        const button = this;

                        if (!dateValue) {
                            alert('Vui lòng chọn ngày.');
                            return;
                        }

                        const parts = dateValue.split('/');
                        if (parts.length !== 3 || !parts[2] || parts[2].length !== 4) {
                            alert('Định dạng ngày không hợp lệ. Vui lòng dùng dd/mm/yyyy.');
                            return;
                        }
                        const [d, m, y] = parts;
                        const formattedDate = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;

                        button.disabled = true;
                        button.textContent = 'Đang xử lý...';
                        absenceStatusEl.textContent = 'Đang gửi yêu cầu...';
                        absenceStatusEl.className = 'mt-2 text-sm font-bold text-blue-600';
                        fetch('/api/attendance/run-absence-check', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ check_date: formattedDate })
                        })
                        .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err)))
                        .then(data => {
                            if (data.status === 'success') {
                                absenceStatusEl.textContent = data.message;
                                absenceStatusEl.className = 'mt-2 text-sm font-bold text-green-600';
                                setTimeout(() => {
                                    alert('Yêu cầu cập nhật đã được gửi. Kết quả sẽ được áp dụng sau vài phút.');
                                    absenceCheckModal.classList.add('hidden');
                                }, 1000);
                            } else {
                                absenceStatusEl.textContent = 'Lỗi: ' + (data.detail || 'Không rõ nguyên nhân.');
                                absenceStatusEl.className = 'mt-2 text-sm font-bold text-red-600';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            absenceStatusEl.textContent = 'Đã xảy ra lỗi: ' + (error.detail || 'Không thể gửi yêu cầu đến server.');
                            absenceStatusEl.className = 'mt-2 text-sm font-bold text-red-600';
                        })
                        .finally(() => {
                            setTimeout(() => {
                                button.disabled = false;
                                button.textContent = 'Chạy cập nhật';
                            }, 2000);
                        });
                    });
                }
    
                // --- Export to Excel Logic ---
                const exportBtn = document.getElementById('export-attendance-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', function() {
                        const params = new URLSearchParams();
                        const filterType = document.getElementById('filter-type') ? document.getElementById('filter-type').value : '';
                        const filterDateInput = document.getElementById('filter-date');
                        let filterDate = '';
                        if (filterDateInput && filterDateInput.value) {
                            const parts = filterDateInput.value.split('/');
                            if (parts.length === 3 && parts[2] && parts[2].length === 4) {
                                filterDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            }
                        }
                        const filterNhanVien = document.getElementById('filter-nhan-vien') ? document.getElementById('filter-nhan-vien').value : '';
                        const filterChucVu = document.getElementById('filter-chuc-vu') ? document.getElementById('filter-chuc-vu').value : '';
                        const filterCnLam = document.getElementById('filter-cn-lam') ? document.getElementById('filter-cn-lam').value : '';
                        const filterSoCong = document.getElementById('filter-so-cong') ? document.getElementById('filter-so-cong').value : '';
                        const filterTangCa = document.getElementById('filter-tang-ca') ? document.getElementById('filter-tang-ca').value : '';
                        const filterGhiChu = document.getElementById('filter-ghi-chu') ? document.getElementById('filter-ghi-chu').value : '';
                        const filterNguoiThucHien = document.getElementById('filter-nguoi-thuc-hien') ? document.getElementById('filter-nguoi-thuc-hien').value : '';
                        const filterDichVu = document.getElementById('filter-dich-vu') ? document.getElementById('filter-dich-vu').value : '';
                        const filterSoPhong = document.getElementById('filter-so-phong') ? document.getElementById('filter-so-phong').value : '';

                        if (filterType && filterType !== 'all') params.append('filter_type', filterType);
                        if (filterDate) params.append('filter_date', filterDate);
                        if (filterNhanVien) params.append('filter_nhan_vien', filterNhanVien);
                        if (filterChucVu) params.append('filter_chuc_vu', filterChucVu);
                        if (filterCnLam) params.append('filter_cn_lam', filterCnLam);
                        if (filterSoCong) params.append('filter_so_cong', filterSoCong);
                        if (filterTangCa && filterTangCa !== 'all') params.append('filter_tang_ca', filterTangCa);
                        if (filterGhiChu) params.append('filter_ghi_chu', filterGhiChu);
                        if (filterNguoiThucHien) params.append('filter_nguoi_thuc_hien', filterNguoiThucHien);
                        if (filterDichVu) params.append('filter_dich_vu', filterDichVu);
                        if (filterSoPhong) params.append('filter_so_phong', filterSoPhong);

                        const exportUrl = `/api/attendance/export-excel?${params.toString()}`;
                        window.open(exportUrl, '_blank');
                    });
                }
    
                const modalRecordId = document.getElementById('modal-record-id');
                const modalPerformerContainer = document.getElementById('modal-performer-container');
                const modalNguoiThucHienSearch = document.getElementById('modal-nguoi-thuc-hien-search');
                const modalNguoiThucHienCode = document.getElementById('modal-nguoi-thuc-hien-code');
                const performerSearchResults = document.getElementById('performer-search-results');
                const modalThoiGian = document.getElementById('modal-thoi-gian');
                const modalChiNhanhLam = document.getElementById('modal-chi-nhanh-lam');
                const modalLaTangCa = document.getElementById('modal-la-tang-ca');
                const modalGhiChu = document.getElementById('modal-ghi-chu');
                const modalSoCongNv = document.getElementById('modal-so-cong-nv');
                const modalDichVu = document.getElementById('modal-dich-vu');
                const modalSoPhong = document.getElementById('modal-so-phong');
                const modalSoLuong = document.getElementById('modal-so-luong');
                const attendanceFields = document.getElementById('modal-attendance-fields');
                const serviceFields = document.getElementById('modal-service-fields');
                const modalRecordType = document.getElementById('modal-record-type');
                const modalTypeContainer = document.getElementById('modal-type-selector-container');
                const modalMaNvSearch = document.getElementById('modal-ma-nv-search');
                const modalMaNv = document.getElementById('modal-ma-nv');
                const employeeSearchResults = document.getElementById('employee-search-results');
    
                const closeModal = () => recordModal.classList.add('hidden');
    
                const updateOvertimeStatus = () => {
                    const chiNhanhChinh = recordForm.dataset.chiNhanhChinh;
                    // Nếu chưa có chi nhánh chính (chưa chọn NV), thì không thể xác định tăng ca khác chi nhánh.
                    // Chỉ có thể dựa vào số công.
    
                    const chiNhanhLam = modalChiNhanhLam.value;
                    const soCong = parseFloat(modalSoCongNv.value);
    
                    // Tăng ca là true nếu chi nhánh làm khác chi nhánh chính, HOẶC số công > 1.
                    // Đối với bản ghi dịch vụ, soCong sẽ là NaN, nên (soCong > 1) sẽ là false.
                    let isOvertime = (soCong > 1);
                    if (chiNhanhChinh && chiNhanhLam) { // Chỉ kiểm tra khác chi nhánh khi có đủ thông tin
                        isOvertime = isOvertime || (chiNhanhLam !== chiNhanhChinh);
                    }
                    modalLaTangCa.checked = isOvertime;
                };
    
                // Thêm event listener để tự động cập nhật khi người dùng thay đổi
                modalChiNhanhLam.addEventListener('change', updateOvertimeStatus);
                modalSoCongNv.addEventListener('input', updateOvertimeStatus);

                const openModal = (mode, record = null) => {
                    recordForm.reset();
                    // Xóa data attribute và bật lại checkbox khi mở modal
                    recordForm.removeAttribute('data-employee-role');
                    recordForm.removeAttribute('data-chi-nhanh-chinh');
                    modalLaTangCa.disabled = false;
    
                    let recordType = 'attendance'; // Default for add mode
                    modalTypeContainer.style.display = mode === 'add' ? 'block' : 'none';
    
                    if (mode === 'edit' && record) {
                        modalTitle.textContent = 'Chỉnh sửa bản ghi';
                        recordType = record.type === 'Điểm danh' ? 'attendance' : 'service';
                        modalRecordId.value = record.id; // Đặt ID cho form
    
                        // Populate common form fields first
                        modalMaNv.value = record.ma_nv;
                        modalMaNvSearch.value = record.ten_nv;
                        modalGhiChu.value = record.ghi_chu_raw;

                        // Điền thời gian và số công TRƯỚC khi tính toán tăng ca
                        const [datePart, timePart] = record.thoi_gian.split(' ');
                        const [h, min] = timePart.split(':');
                        modalThoiGian.value = `${datePart} ${h}:${min}`;
    
                        if (recordType === 'attendance') {
                            const soCong = record.so_cong;
                            if (soCong != null) { // Check for null/undefined
                                modalSoCongNv.value = (soCong % 1 === 0) ? parseInt(soCong, 10) : soCong;
                            } else {
                                modalSoCongNv.value = '1'; // Default if null
                            }
                        } else {
                            modalSoCongNv.value = ''; // Bản ghi dịch vụ không có số công
                            modalDichVu.value = record.dich_vu;
                            modalSoPhong.value = record.so_phong;
                            modalSoLuong.value = record.so_luong;
                        }
    
                        // Bây giờ, xử lý UI và logic tăng ca theo vai trò
                        const isKtvOrQuanLy = record.chuc_vu === 'Kỹ thuật viên' || record.chuc_vu === 'Quản lý';
                        recordForm.dataset.chiNhanhChinh = record.chi_nhanh_chinh || '';
                        const cnLamContainer = document.getElementById('modal-cn-lam-container');
                        const tangCaContainer = document.getElementById('modal-tang-ca-container');
                        const performerContainer = document.getElementById('modal-performer-container');
    
                        if (isKtvOrQuanLy) {
                            // Ẩn các trường không áp dụng cho KTV/Quản lý
                            cnLamContainer.style.display = 'none';
                            modalChiNhanhLam.disabled = true;
                            tangCaContainer.style.display = 'none';
                            performerContainer.style.display = 'none';
                            modalLaTangCa.disabled = true;
    
                            // Đặt các giá trị ngầm định
                            modalChiNhanhLam.value = record.chi_nhanh_chinh;
                            modalNguoiThucHienCode.value = record.ma_nv;
                            modalNguoiThucHienSearch.value = record.ma_nv;
    
                            // Đặt tăng ca dựa trên số công (đã được điền)
                            modalLaTangCa.checked = (record.so_cong || 0) > 1.0;
                        } else {
                            // Hiển thị các trường và bật logic tăng ca tự động cho các vai trò khác
                            modalLaTangCa.disabled = true; // Người dùng không thể tự tick
                            cnLamContainer.style.display = 'block';
                            modalChiNhanhLam.disabled = false;
                            tangCaContainer.style.display = 'block';
                            performerContainer.style.display = 'block';
    
                            // Đặt giá trị từ bản ghi
                            modalChiNhanhLam.value = record.chi_nhanh_lam;
                            modalNguoiThucHienCode.value = record.nguoi_thuc_hien;
                            modalNguoiThucHienSearch.value = record.nguoi_thuc_hien;
    
                            // This will now work correctly because so_cong is set
                            updateOvertimeStatus();
                        }
    
                    } else { // 'add' mode
                        modalTitle.textContent = 'Thêm bản ghi mới';
                        modalRecordId.value = '';
                        recordForm.dataset.chiNhanhChinh = ''; // Clear old data
    
                        // --- ✨ LOGIC AUTOFILL MỚI TỪ BỘ LỌC ---
                        const filterType = document.getElementById('filter-type').value;
                        if (filterType && filterType !== 'all') {
                            modalRecordType.value = (filterType === 'Điểm danh') ? 'attendance' : 'service';
                        } else {
                            modalRecordType.value = 'attendance'; // Mặc định
                        }
    
                        const filterDate = document.getElementById('filter-date').value;
                        if (filterDate) {
                            const now = new Date();
                            const hours = String(now.getHours()).padStart(2, '0');
                            const minutes = String(now.getMinutes()).padStart(2, '0');
                            modalThoiGian.value = `${filterDate} ${hours}:${minutes}`;
                        }
    
                        const filterNguoiThucHien = document.getElementById('filter-nguoi-thuc-hien').value;
                        if (filterNguoiThucHien) {
                            modalNguoiThucHienSearch.value = filterNguoiThucHien;
                            modalNguoiThucHienCode.value = filterNguoiThucHien;
                        } else {
                            modalNguoiThucHienSearch.value = '{{ user.code }}';
                            modalNguoiThucHienCode.value = '{{ user.code }}';
                        }

                        const filterNhanVien = document.getElementById('filter-nhan-vien').value;
                        if (filterNhanVien) modalMaNvSearch.value = filterNhanVien;

                        const filterCnLam = document.getElementById('filter-cn-lam').value;
                        modalChiNhanhLam.value = filterCnLam || ''; // Để trống nếu không có filter

                        const filterDichVu = document.getElementById('filter-dich-vu').value;
                        if (filterDichVu) modalDichVu.value = filterDichVu;

                        const filterSoPhong = document.getElementById('filter-so-phong').value;
                        if (filterSoPhong) modalSoPhong.value = filterSoPhong;

                        const filterSoCong = document.getElementById('filter-so-cong').value;
                        if (filterSoCong) modalSoCongNv.value = filterSoCong;

                        const filterGhiChu = document.getElementById('filter-ghi-chu').value;
                        if (filterGhiChu) modalGhiChu.value = filterGhiChu;
                        
                        document.getElementById('modal-cn-lam-container').style.display = 'block';
                        modalChiNhanhLam.disabled = false;
                        document.getElementById('modal-tang-ca-container').style.display = 'block';
                        document.getElementById('modal-performer-container').style.display = 'block';
                        modalLaTangCa.disabled = true; 
                        recordType = modalRecordType.value;

                        // ✨ FIX: Gọi updateOvertimeStatus sau khi autofill để kiểm tra logic tăng ca ban đầu.
                        // Cần một khoảng trễ nhỏ để đảm bảo DOM đã cập nhật giá trị từ các bộ lọc.
                        setTimeout(updateOvertimeStatus, 50);

                    }

                    toggleModalFields(recordType);
                    recordModal.classList.remove('hidden');
                };

                const toggleModalFields = (type) => {
                    if (type === 'attendance') {
                        attendanceFields.style.display = 'block';
                        serviceFields.style.display = 'none';
                        modalSoCongNv.required = true;
                    } else {
                        attendanceFields.style.display = 'none';
                        serviceFields.style.display = 'block';
                        modalSoCongNv.required = false;
                    }
                };

                addRecordBtn.addEventListener('click', () => openModal('add'));
                modalCloseBtn.addEventListener('click', closeModal);
                modalCancelBtn.addEventListener('click', closeModal);
                modalRecordType.addEventListener('change', () => toggleModalFields(modalRecordType.value));

                tbodyEl.addEventListener('click', (e) => {
                    if (e.target.classList.contains('edit-btn')) {
                        const recordRow = e.target.closest('tr');
                        const record = JSON.parse(recordRow.dataset.record);
                        openModal('edit', record);
                    }
                    if (e.target.classList.contains('delete-btn')) {
                        const recordId = e.target.dataset.id;
                        const recordType = e.target.dataset.type;
                        if (confirm('Bạn có chắc chắn muốn xóa bản ghi này không?')) {
                            fetch(`/api/attendance/record/${recordType}/${recordId}`, { method: 'DELETE' })
                                .then(res => res.json())
                                .then(data => {
                                    if (data.status === 'success') {
                                        alert('Đã xóa bản ghi thành công.');
                                        fetchData();
                                    } else {
                                        throw new Error(data.detail || 'Lỗi không xác định');
                                    }
                                })
                                .catch(err => alert(`Lỗi khi xóa: ${err.message}`));
                        }
                    }
                });

                recordForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const recordId = modalRecordId.value;
                    const isEdit = !!recordId;

                    // --- VALIDATION LOGIC FOR ADD MODE ---
                    if (!isEdit) {
                        const employeeRole = recordForm.dataset.employeeRole || '';
                        const isKtvOrQuanLy = employeeRole === 'ktv' || employeeRole === 'quanly';
                        const recordType = modalRecordType.value;

                        const validateField = (input, message, checkNumeric = false) => {
                            const value = input.value.trim();
                            let searchInput;
                            if (input.id === 'modal-ma-nv') {
                                searchInput = document.getElementById('modal-ma-nv-search');
                            } else if (input.id === 'modal-nguoi-thuc-hien-code') {
                                searchInput = document.getElementById('modal-nguoi-thuc-hien-search');
                            }
                            const targetInput = searchInput || input;

                            if (!value) {
                                alert(message);
                                targetInput.focus();
                                return false;
                            }
                            if (checkNumeric && (isNaN(parseFloat(value)) || parseFloat(value) <= 0)) {
                                alert(message);
                                targetInput.focus();
                                return false;
                            }
                            return true;
                        };

                        if (!isKtvOrQuanLy && !validateField(modalNguoiThucHienCode, 'Vui lòng chọn người thực hiện.')) return;
                        if (!validateField(modalMaNv, 'Vui lòng chọn một nhân viên.')) return;
                        if (!validateField(modalThoiGian, 'Vui lòng nhập thời gian.')) return;
                        if (!isKtvOrQuanLy && !validateField(modalChiNhanhLam, 'Vui lòng chọn chi nhánh làm việc.')) return;

                        if (recordType === 'attendance') {
                            if (!validateField(modalSoCongNv, 'Vui lòng nhập số công hợp lệ (lớn hơn 0).', true)) return;
                        } else { // service
                            if (!validateField(modalDichVu, 'Vui lòng chọn dịch vụ.')) return;
                            if (!validateField(modalSoPhong, 'Vui lòng nhập số phòng.')) return;
                            if (!validateField(modalSoLuong, 'Vui lòng nhập số lượng.')) return;
                        }
                    }
                    // --- END VALIDATION ---

                    const formData = new FormData(recordForm);
                    // Handle checkbox value
                    formData.set('la_tang_ca', modalLaTangCa.checked);

                    const recordType = isEdit ? (allRecords.find(r => r.id == recordId).type === 'Điểm danh' ? 'attendance' : 'service') : modalRecordType.value;

                    const url = isEdit ? `/api/attendance/manual-record/${recordType}/${recordId}` : '/api/attendance/manual-record';

                    fetch(url, { method: 'POST', body: formData })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert(data.message);
                                closeModal();
                                fetchData();
                            } else {
                                throw new Error(data.detail || 'Lỗi không xác định');
                            }
                        })
                        .catch(err => alert(`Lỗi khi lưu: ${err.message}`));
                });

                // Performer search in modal
                let performerSearchTimeout;
                modalNguoiThucHienSearch.addEventListener('input', () => {
                    clearTimeout(performerSearchTimeout);
                    modalNguoiThucHienCode.value = ''; // Invalidate on any input
                    const query = modalNguoiThucHienSearch.value.trim();
                    // If the search box is cleared, also clear the hidden code input.
                    if (query === '') {
                        performerSearchResults.classList.add('hidden');
                        return;
                    }
                    if (query.length < 2) {
                        return;
                    }
                    performerSearchTimeout = setTimeout(() => {
                        fetch(`/api/users/search-checkers?q=${encodeURIComponent(query)}`)
                            .then(res => res.json())
                            .then(performers => {
                                performerSearchResults.innerHTML = '';
                                if (performers.length > 0) {
                                    performers.forEach(p => {
                                        const div = document.createElement('div');
                                        div.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                                        div.textContent = `${p.name} (${p.code})`;
                                        div.onclick = () => {
                                            modalNguoiThucHienSearch.value = p.name;
                                            modalNguoiThucHienCode.value = p.code;
                                            performerSearchResults.classList.add('hidden');
                                        };
                                        performerSearchResults.appendChild(div);
                                    });
                                    performerSearchResults.classList.remove('hidden');
                                } else {
                                    performerSearchResults.classList.add('hidden');
                                }
                            });
                    }, 300);
                });
                // Employee search in modal
                let searchTimeout;
                modalMaNvSearch.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    modalMaNv.value = ''; // Invalidate on any input
                    const query = modalMaNvSearch.value.trim();
                    // If the search box is cleared, also clear the hidden code input.
                    if (query === '') {
                        employeeSearchResults.classList.add('hidden');
                        return;
                    }
                    if (query.length < 2) {
                        employeeSearchResults.classList.add('hidden');
                        return;
                    }
                    searchTimeout = setTimeout(() => {
                        // Kiểm tra xem có đang thêm bản ghi dịch vụ không
                        const isServiceMode = document.getElementById('modal-record-type').value === 'service';
                        const roleFilterParam = isServiceMode ? '&role_filter=buongphong' : '';

                        fetch(`/attendance/api/employees/search?q=${encodeURIComponent(query)}${roleFilterParam}`)
                            .then(res => res.json())
                            .then(employees => {
                                employeeSearchResults.innerHTML = '';
                                if (employees.length > 0) {
                                    employees.forEach(emp => {
                                        const div = document.createElement('div');
                                        div.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                                        div.textContent = `${emp.name} (${emp.code})`;
                                        div.onclick = () => {
                                            // --- START: LOGIC KHI CHỌN NHÂN VIÊN MỚI ---
                                            modalMaNvSearch.value = emp.name;
                                            modalMaNv.value = emp.code;
                                            employeeSearchResults.classList.add('hidden');
    
                                            // Cập nhật dataset của form với thông tin nhân viên mới
                                            recordForm.dataset.chiNhanhChinh = emp.branch || '';
                                            recordForm.dataset.employeeRole = emp.department || '';
    
                                            const isKtvOrQuanLy = emp.department === 'ktv' || emp.department === 'quanly';
                                            const cnLamContainer = document.getElementById('modal-cn-lam-container');
                                            const tangCaContainer = document.getElementById('modal-tang-ca-container');
                                            const performerContainer = document.getElementById('modal-performer-container');
    
                                            if (isKtvOrQuanLy) {
                                                // Ẩn các trường không áp dụng cho KTV/Quản lý
                                                cnLamContainer.style.display = 'none';
                                                modalChiNhanhLam.disabled = true;
                                                tangCaContainer.style.display = 'none';
                                                performerContainer.style.display = 'none';
                                                // Đặt các giá trị ngầm định
                                                modalChiNhanhLam.value = emp.branch;
                                                modalNguoiThucHienCode.value = emp.code;
                                                modalNguoiThucHienSearch.value = emp.code;
                                                modalLaTangCa.disabled = true;
                                            } else {
                                                // Hiển thị các trường cho các vai trò khác
                                                cnLamContainer.style.display = 'block';
                                                modalChiNhanhLam.disabled = false;
                                                tangCaContainer.style.display = 'block';
                                                performerContainer.style.display = 'block';
                                                modalLaTangCa.disabled = true; // Vẫn khóa không cho người dùng tự tick
                                            }
    
                                            // ✅ FIX: Luôn gọi updateOvertimeStatus sau khi chọn nhân viên mới
                                            // để kiểm tra lại logic tăng ca dựa trên chi nhánh chính mới.
                                            updateOvertimeStatus();
                                            // --- END: LOGIC KHI CHỌN NHÂN VIÊN MỚI ---
                                        };
                                        employeeSearchResults.appendChild(div);
                                    });
                                    employeeSearchResults.classList.remove('hidden');
                                } else {
                                    employeeSearchResults.classList.add('hidden');
                                }
                            });
                    }, 300);
                });
    
                // Hide search results when clicking outside
                document.addEventListener('click', (e) => {
                    if (!modalMaNvSearch.contains(e.target) && !employeeSearchResults.contains(e.target)) {
                        employeeSearchResults.classList.add('hidden');
                    }
                    if (filterNhanVienEl && !filterNhanVienEl.contains(e.target) && employeeFilterResults && !employeeFilterResults.contains(e.target)) {
                        employeeFilterResults.classList.add('hidden');
                    }
                });
    
                // Performer filter search
                let performerFilterTimeout;
                filterNguoiThucHienEl.addEventListener('input', () => {
                    clearTimeout(performerFilterTimeout);
                    const query = filterNguoiThucHienEl.value.trim();
                    if (query === '') {
                        performerFilterResults.classList.add('hidden');
                        return;
                    }
                    if (query.length < 2) return;

                    performerFilterTimeout = setTimeout(() => {
                        fetch(`/api/users/search-checkers?q=${encodeURIComponent(query)}`)
                            .then(res => res.json())
                            .then(performers => {
                                performerFilterResults.innerHTML = '';
                                if (performers.length > 0) {
                                    performers.forEach(p => {
                                        const div = document.createElement('div');
                                        div.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                                        div.textContent = `${p.name} (${p.code})`;
                                        div.onclick = () => {
                                            filterNguoiThucHienEl.value = p.code;
                                            performerFilterResults.classList.add('hidden');
                                        };
                                        performerFilterResults.appendChild(div);
                                    });
                                    performerFilterResults.classList.remove('hidden');
                                } else {
                                    performerFilterResults.classList.add('hidden');
                                }
                            });
                    }, 300);
                });
            }
    
            // --- Gắn các listener tĩnh một lần duy nhất ---
            function attachStaticListeners() {
                if (listenersAttached) return; // Chỉ chạy một lần

                // Sorting listener
                theadEl.addEventListener('click', (e) => {
                        const header = e.target.closest('.sortable');
                        if (!header) return;
                        const sortBy = header.dataset.sort;
                        if (!sortBy) return;

                        if (currentSortBy === sortBy) {
                            currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
                        } else {
                            currentSortBy = sortBy;
                            currentSortOrder = 'desc';
                        }
                        currentPage = 1;
                        fetchData();
                });

                if (isAdminOrBoss) {
                    setupCheckboxListeners();
                }

                listenersAttached = true;
            }
    
            // Employee filter search (for the main filter bar)
            let employeeFilterTimeout;
            if (filterNhanVienEl && employeeFilterResults) {
                filterNhanVienEl.addEventListener('input', () => {
                    clearTimeout(employeeFilterTimeout);
                    const query = filterNhanVienEl.value.trim();
                    if (query === '') {
                        employeeFilterResults.classList.add('hidden');
                        return;
                    }
                    if (query.length < 2) return;

                    employeeFilterTimeout = setTimeout(() => {
                        fetch(`/attendance/api/employees/search?q=${encodeURIComponent(query)}&context=results_filter`)
                            .then(res => res.json())
                            .then(employees => {
                                employeeFilterResults.innerHTML = '';
                                if (employees.length > 0) {
                                    employees.forEach(emp => {
                                        const div = document.createElement('div');
                                        div.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                                        div.textContent = `${emp.name} (${emp.code})`;
                                        div.onclick = () => {
                                            filterNhanVienEl.value = emp.name;
                                            employeeFilterResults.classList.add('hidden');
                                        };
                                        employeeFilterResults.appendChild(div);
                                    });
                                    employeeFilterResults.classList.remove('hidden');
                                } else {
                                    employeeFilterResults.classList.add('hidden');
                                }
                            });
                }, 300);
                });
            }
    
            // Initial data fetch
            fetchData();
            setupSoCongFilter();
            attachStaticListeners(); // Gắn các listener tĩnh
            toggleFilterVisibility(); // Initial check
    
            // Initialize Flatpickr date pickers
            flatpickr("#filter-date", {
                dateFormat: "d/m/Y",
                allowInput: true,
            });
            if (isAdminOrBoss) {
                flatpickr("#absence-check-date", {
                    dateFormat: "d/m/Y",
                    allowInput: true,
                });
                flatpickr("#modal-thoi-gian", { enableTime: true, dateFormat: "d/m/Y H:i", time_24hr: true, allowInput: true });
            }
        });
    </script>
    <script>
        function checkAndLogoutForShiftChange() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();

            // Tự động đăng xuất lúc 6:59 sáng
            const isMorningLogout = (hours === 6 && minutes === 59); // Giữ nguyên hoặc thay đổi để test

            // Tự động đăng xuất lúc 18:59 tối
            const isEveningLogout = (hours === 18 && minutes === 59); // <-- THAY ĐỔI GIỜ VÀ PHÚT Ở ĐÂY

            if (isMorningLogout || isEveningLogout) {
                console.log("Đã đến giờ chuyển ca, tự động đăng xuất...");
                // Chuyển hướng về trang đăng xuất để xóa session
                window.location.href = '/logout';
            }
        }

        // Kiểm tra thời gian mỗi 30 giây để đảm bảo không bỏ lỡ
        setInterval(checkAndLogoutForShiftChange, 30000);
    </script>
</body>
</html>
